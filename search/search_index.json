{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Haas Data Collection project","text":"<p>This is the Github Pages documentation for the Haas Data Collection project.</p> <p>Click the menu items at the top of the page to access the documentation.</p> <p>The code for the project can be found at this Github repository</p>"},{"location":"Introduction/","title":"Introduction to the Haas Data Collect Project","text":""},{"location":"Introduction/#project-purpose","title":"Project Purpose","text":"<p>The project enables Haas CNC machines with NG controls and the <code>macro</code> option to output operational data using CNC <code>DPRNT</code> commands to a network server, which is then saved to disk by a Python script. Operations personnel can then copy the files off to their PCs and analyze the data. Multiple copies of the script can listen on different <code>TCP/IP</code> ports which allows multiple <code>Haas</code> machines to send data concurrently to one server.</p> <p>The project workflow:</p> <ol> <li>Copy the files from the GitHub repository.</li> <li>Set Haas Options to output TCP/IP<ol> <li>261 - Set to <code>TCP Port</code></li> <li>262 - Set to <code>User Data/</code> to send to a server</li> <li>263 - the <code>DPRNT Port</code> to use. Haas recommends using <code>TCP/IP</code> ports 5001 - 5999 to communicate with the server.</li> </ol> </li> <li>Python logger script connects to the machine\u2019s IP/port.</li> <li>Haas NG control sends DPRNT messages over the network.</li> <li>Data is written into CSV files for later analysis.</li> </ol> <p>The python script is cross platform and will run on Windows/Mac/Linux. The script is lightweight, using approximately 20KB of RAM and under 100MB of disk space for the repository.</p> <p>The collected data is saved into text files with a <code>csv</code> extension. The <code>csv</code> in the extension stands for <code>Comma Separated Value</code> and is a common format for storing data. The <code>csv</code> format is lightweight and a typical file will be under 5KB in size.</p> <p>An example of a <code>csv</code> file:</p> <pre><code>Machine,Timestamp,Part_Number,Revision,Date_YYMMDD,Time_HHMMSS\nMachine2,2025-12-04 10:58:15,\u201c265-4183\u201d,\u201cX2\u201d,251204,105815\nMachine2,2025-12-04 10:58:20,\u201c265-4183\u201d,\u201cX2\u201d,251204,105820\nMachine2,2025-12-04 10:58:23,\u201c265-4183\u201d,\u201cX2\u201d,251204,105823\nMachine2,2025-12-04 11:27:07,\u201c265-4183\u201d,\u201cX2\u201d,251204,112707\n</code></pre> <p><code>csv</code> files are typically opened in Microsoft Excel or LireOffice Calc.</p> <p>The biggest hurdle to running the script in production is that the computer with the script has to be powered up and logged into. For testing, that isn't a big barrier but for 24/7/365 operations that is a problem. The next section of this guide shows how to Build a Raspberry Pi 5 appliance running Ubuntu 24.04.3 that creates a <code>service</code> to start the script on boot. No one has to be logged into the appliance for data to be collected. The total cost for an 8GB Raspberry Pi 5 with a 256GB NVME drive, PoE power supply and industrial case is around $200.00. The Raspberry Pi 5 draws around 25W of power so the OpEx cost is minimal.</p> <p>The appliance is built from the ground up to be secure. Ubuntu can be configured to automatically download security updates, the firewall is enabled and configured during installation and only ports:</p> <ul> <li>22 (SSH)</li> <li>445 (Microsoft server)</li> <li>9090 (Cockpit management)</li> </ul> <p>are exposed to just the users that need access. In other words, the appliance is \"Hardened\".</p> <p>Can I use a repurposed PC?</p> <p>What about using an out of service Intel/AMD based PC? Yes, the code for the appliance will run on the Raspberry Pi 5 or any Intel/AMD x86 computer. The code would also run on an Intel based Mac that is running Ubuntu 24.04.</p>"},{"location":"Introduction/#haas-videos-on-dprnt","title":"Haas Videos on DPRNT","text":"<p>The Haas CNC control supports a command named DPRNT. It allows data such as date/time, cycle count, cycle time, inspection data, etc. to be sent to a file on a USB Flash drive or a computer. Haas has a YouTube channel and this video clearly explains how to configure the control to send <code>DPRNT</code> statements to a USB flash drive or a server.</p> <p>This page on the Haas site has links to all the Haas videos on YouTube.</p> <p>Haas provides a copy of the Inspection Plus software for Haas machining centres manual. All of the variables used for probing can be output over <code>DPRNT</code>. You could write a <code>DPRNT</code> program that outputs dimensions that are out of spec and alert the operator before starting the next run,</p> <p>Info</p> <p>I wrote a manual for Fanuc Custom Macro way back in 1993! I was using <code>dprnt</code> to output Renishaw probe inspection data to a panel mounted serial printer. There is a section in the book on using <code>dprnt</code>, fully compatible with Haas, that you might find useful. Here is a link to the book - Fanuc Custom Macro</p>"},{"location":"Introduction/#haas-connect","title":"Haas Connect","text":"<p>Haas provides a cloud-based monitoring system for all new Next Gen controls. Here is a video describing it:</p> <p>Haas Connect Intro</p>"},{"location":"Pi_5_Appliance/","title":"Raspberry Pi 5 Appliance","text":"<p>Why would you want to build a Raspberry Pi 5 appliance when the Python scripts will run on Windows? A couple of reasons jump out:</p> <ul> <li>The scripts need to be running anytime the shop is working.</li> <li>You will need to have shares available for the files to be copied</li> </ul> <p>The first reason means that a Windows computer would have to be up and running 24/7 with a user logged in. I don't think that many IT security teams would find that acceptable. A cyber attack is most likely when a PC is powered on and a user is logged in. If the scripts are on a user's Windows desktop and they shut down in the evening or over weekends/holidays, data won't be collected.</p> <p>The workaround to a user being logged in is to use a tool like <code>NSSM (Non-Sucking Service Manager)</code> to install the script as a service. I researched <code>NSSM</code> and it appears to be abandoned so no security updates will be produced. My Haas scripts use standard Python libraries that will get updated anytime you update Python. There are a few other ways to run Python as a service on Windows, but you would still have to have a machine running 24/7, so the Pi is a less expensive method. The attack surface of a hardened Linux appliance is smaller than a Windows 11 desktop.</p> <p>Note</p> <p>Python doesn't get updated when you run Windows Update. Use <code>winget upgrade --id Python.Python.3</code> from a PowerShell terminal if you installed using winget or Update via Microsoft Store (If installed from there).</p> <p>The second reason means creating file shares on the Windows computer that the scripts are running on. I have had a lot of wasted time in small shops making their MSP understand what is needed (a user account, the shares, security groups, etc.) and getting it done while I'm onsite. Plus, creating shares on a personal workstation may violate IT security policy.</p> <p>A Raspberry Pi 5 appliance solves both of these problems. It can run 24/7 in the shop or in the server closet. It uses less than 20W of power so no one will be upset at the cost. It's simple to create a service that starts during boot using the systemd init system that Ubuntu is built on. You will still need to discuss the appliance with the IT security team. In the Samba section I will cover enabling the firewall and proving that SMB V1 is disabled.</p>"},{"location":"Pi_5_Appliance/#ubuntu-pro-coverage","title":"Ubuntu Pro coverage","text":"<p>If you are building the appliance for personal use, Ubuntu has a service that is free for up to five devices called <code>Ubuntu Pro</code>. Think of it as Microsoft support but for Ubuntu. The details are on the Ubuntu Pro Pricing page. For business use, the desktop version is $25/yr and the server version is $300/yr.</p> <p>Ubuntu Pro includes:</p> <ul> <li>Security updates</li> <li>Kernel Livepatch</li> <li>Advanced Active Directory policies for Ubuntu Desktop</li> <li>And much more</li> </ul>"},{"location":"Pi_5_Appliance/#why-use-a-raspberry-pi-instead-of-a-cheap-sff-intel-machine","title":"Why use a Raspberry Pi instead of a cheap SFF Intel machine","text":"<p>Raspberry Pis have become popular for industrial applications. They are inexpensive, reliable and have a massive community of blogs, YouTube videos, and magazine articles supporting them.</p> <p>If you have never seen Raspberry Pi 5s in the Industrial and Manufacturing spaces here are couple of example companies:</p> <ul> <li>Revolution Pi - Revolution Pi is your open-source Linux platform for future-oriented industrial solutions:<ol> <li>Powered by the Raspberry Pi Compute Module</li> <li>Raspberry Pi OS-based, industry-optimized operating system</li> </ol> </li> <li>Strato Pi - Industrial Raspberry Pi for Maximum Reliability<ol> <li>Edge Computing</li> <li>Industrial Automation</li> <li>Building &amp; Energy Management</li> <li>Data Acquisition</li> <li>Marine</li> <li>Fleet Management</li> </ol> </li> </ul> <p>It's worth a few minutes to look that homepages of those two companies.</p> <p>There is also a vibrant ecosystem of add-on hardware boards, sometimes called <code>Hats</code>. For example, Waveshare makes a $30 PoE hat that will power the RPI 5 from the Ethernet cable. Very convenient on the manufacturing floor. Here is a link to it - PoE hat. Waveshare also produces a board with four 2.5Gbs Ethernet ports - Waveshare 4 port Ethernet</p> <p>Finally, Waveshare makes great e-paper displays for the Pi. I built a serial console server using a Pi Zero W and a Waveshare display. On startup:</p> <ul> <li>Shows me the ip addresses it got</li> <li>Shows the MFG-S/N of the USB serial adapters that are connected.</li> <li>If it gets internet access, it emails my <code>gmail</code> account it the address.</li> </ul> <p>The email is handy if the console is in a rack up high and you can't see the display. Waveshare provides a Python library to talk to the display and there are tons of YouTube videos and blogs on coding it..</p> <p>Here is a photo of my Pi Zero 2 W serial console. It has a PoE hat so that I can just plug it into a switch, and it's ready to go. It has one FTDI serial cable connected. The <code>P 2003</code> means that I telnet to port 2003 to console to the device it's connected to.</p> <p></p> <p>In the future I might add one and display what machines are online. Here is the link to the Waveshare site - 3.97inch E-Paper Display</p> <p>The RPi 5 is available in several different models. The difference is the amount of RAM. To build a dedicated RPi 5 for this project I recommend the 8GB RAM model. That is overkill for just the scripts, but the difference in cost is negligible compared to the 4GB model, and I find that it's always better to have more RAM for future proofing.</p> <p>On 12/29/2025, Amazon's site offered this cost:</p> <ul> <li>Raspberry Pi 5 8GB - $93.99</li> <li>Raspberry Pi 5 4GB - $76.95</li> </ul> <p>You will need:</p> <ul> <li>Raspberry 5 8GB</li> <li>A certified power adapter</li> <li>An SD card of at least 32GB</li> <li>A case</li> </ul> <p>Amazon has a CanaKit Raspberry Pi 5 Starter Kit PRO - Turbine Black (128GB Edition) (8GB RAM) for $169.95 that includes all of the above and:</p> <ul> <li>a fan</li> <li>a heat sink</li> <li>a 128GB SD card</li> <li>CanaKit 45W PD Power Supply</li> </ul> <p>To build a high performance appliance for a manufacturing plant, I think the Canakit is worth the cost. You can also purchase a Raspberry Pi 5 from Micro Center, Ameridroid and many others if you want to piece it out instead of buying the Canakit.</p> <p>Note</p> <p>The Canakit isn't compatible with the Waveshare PoE hat. You need to remove the case to use the hat.</p>"},{"location":"Pi_5_Appliance/#which-version-of-ubuntu-should-you-use","title":"Which version of Ubuntu should you use","text":"<p>Ubuntu comes in three versions for the Raspberry Pi 5:</p> <ul> <li>Server - No desktop.</li> <li>Desktop - Includes the Gnome desktop</li> <li>Core - A dedicated version for IoT devices. I haven't used it yet, but it's on my list of projects!</li> </ul>"},{"location":"Pi_5_Appliance/#server-version-headless","title":"Server version (Headless)","text":"<p>I am experienced with Ubuntu, so the headless server version is my choice. I use SSH to manage the appliance, and the scripts don't require the Gnome desktop. The server uses less RAM and resources since it doesn't run a desktop.</p> <p>If you are creating a headless (no desktop) version of an appliance using Ubuntu server, you will be using SSH or a serial console cable to configure the Pi.</p>"},{"location":"Pi_5_Appliance/#desktop-version","title":"Desktop Version","text":"<p>If you are new to Linux and building appliances you should pick the desktop. During the installation, select \"minimal\" install since you don't need a word processor, spreadsheet, etc. The desktop version of Ubuntu uses the Gnome desktop, which is similar to a Windows desktop. You can use a Keyboard, Mouse, and Monitor to configure the Pi. This allows you to use a GUI text editor and other GUI tools.</p>"},{"location":"Pi_5_Appliance/#download-raspberry-pi-5-ubuntu-images","title":"Download Raspberry Pi 5 Ubuntu images","text":"<p>Canonical, Ubuntu's publisher, has a dedicated Raspberry Pi page located here: Install Ubuntu on a Raspberry Pi. Follow the instructions on that page to install Ubuntu onto the Raspberry Pi 5.</p>"},{"location":"Pi_5_Appliance/#installation","title":"Installation","text":"<p>Once you decide on a version, follow the instructions in the link above.</p>"},{"location":"Pi_5_Appliance/#what-is-needed-to-create-the-appliance","title":"What is needed to create the appliance","text":"<p>As you can imagine, there are a lot of steps required to build a functional appliance from scratch. But once you have completed it, you will have gained a lot of useful knowledge!</p> <ul> <li>Clone the repository - This is how you get the code from the repository</li> <li>Create the systemd service files</li> <li>Enable the Haas data collection service</li> <li>Install Samba to create Windows shares</li> </ul> <p>The next sections will cover all of these topics in detail.</p>"},{"location":"Pi_5_Appliance/#clone-the-repository","title":"Clone the repository","text":"<p>NOTE: Linux uses a case sensitive file system. So <code>Haas</code> is different from <code>haas</code>. Make sure you use <code>mkdir Haas</code> when you create the directory.</p> <p>Open a terminal on the Pi.</p> <ul> <li>Make sure you are in your home directory by running <code>cd ~</code></li> <li>Verify using <code>pwd</code> which is <code>print working directory</code> in Linux. You should see:</li> </ul> <pre><code>\u256d\u2500mhubbard@ubuntu-server ~\n\u2570\u2500$ pwd\n/home/mhubbard\n</code></pre> <ul> <li>Create a folder named <code>Haas</code> using <code>mkdir Haas</code>.</li> <li>Change to the Haas directory using <code>cd Haas</code></li> <li>Clone the repository using <code>git clone https://github.com/rikosintie/Haas_Data_collect.git</code></li> <li>Change to the <code>Haas_Data_collect</code> folder using <code>cd Haas_Data_collect</code></li> <li>List the files for reference using <code>ls -l</code></li> </ul>"},{"location":"Pi_5_Appliance/#the-systemd-service-files","title":"The systemd service files","text":"<p>Ubuntu uses an initialization (init) service named <code>systemd</code>. This service manages what services are initialized when Ubuntu starts up. We will use <code>systemd</code> to manage the Python scripts.</p> <p>The service files are where you define how to call the Python script when the Pi starts up. In the repository there are six files representing six different machine tools. The ports and IP addresses used are:</p> Machine Port# IP Address ST40 5052 192.168.10.141 VF2SS 5053 192.168.10.142 VF5SS 5054 192.168.10.143 MINIMILL 5055 192.168.10.143 ST30 5056 192.168.10.144 ST30L 5057 192.168.10.145 <p>You will have different names and IP addresses on your machine tools. No problem, just make a table of the name you want, the port, and the IP address. Then modify the existing service files. Here is the format:</p> <pre><code>[Unit]\nDescription=Haas Python logger for ST40\nAfter=network.target\n\n[Service]\nUser=mhubbard\nWorkingDirectory=/home/mhubbard/Haas/Haas_Data_collect\nExecStart=/usr/bin/python3 /home/mhubbard/Haas/Haas_Data_collect/haas_logger2.py -a -t 192.168.10.140  --port 5052 --name ST40\nType=idle\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>Warning</p> <p>Be extremely careful when you edit the files. Any mistake will prevent you from successfully receiving data from the machine and can be challenging to troubleshoot.</p>"},{"location":"Pi_5_Appliance/#editing-the-files","title":"Editing the files","text":"<p>The systemd service files are located in <code>/etc/systemd/system/</code> so you must use sudo to edit them.</p> <p>As an example, let's use the included st40.service file. You should be in the <code>Haas_Data_collect</code> directory. Use the following to copy <code>st40.service</code> to the <code>/etc/systemd/system/</code> directory:</p> <p><code>sudo cp st40.service /etc/systemd/system/st40.service</code></p> <p>Use the following to edit the included st40.service file: <code>sudo nano /etc/systemd/system/st40.service</code></p> <p>This will open <code>st40.service</code> in the built in <code>nano</code> editor.</p> <p>Note</p> <p>For whatever reason, <code>nano</code> doesn't use the normal text editor keys. If you are brand new to Linux, use this tutorial to learn nano - The beginners guide to Nano the Linux command line text editor</p> <p>If you installed the desktop version of Ubuntu, you can use the GUI Gnome Text Editor GUI to edit the files by running:</p> <p><code>sudo gnome-text-editor /etc/systemd/system/st40.service</code></p>"},{"location":"Pi_5_Appliance/#what-you-need-to-modify","title":"What you need to modify","text":"<ul> <li>Description - The description is shown when you check the status of the service. Change to something that makes sense in your environment</li> <li>User - Your username probably isn't mhubbard. Change to your username</li> <li>WorkingDirectory - I recommend you keep this format and just change the username in the path.</li> <li>ExecStart - This is where the table of names, ports, IP addresses comes in handy.</li> </ul> <p>Nothing else needs to be changed in the service file.</p>"},{"location":"Pi_5_Appliance/#configuring-systemd-to-use-the-service-files","title":"Configuring systemd to use the service files","text":"<p>Once you have the service file modified, use the following commands to set up the service:</p> <pre><code>sudo systemctl daemon-reload\nsudo systemctl enable st40.service\nsudo systemctl start st40.service\nsudo systemctl status st40.service\n</code></pre>"},{"location":"Pi_5_Appliance/#what-the-commands-do","title":"What the commands do","text":"<ul> <li>sudo systemctl daemon-reload - Forces <code>systemd</code> to read the changes</li> <li>sudo systemctl enable st40.service - Tells <code>systemd</code> to run the service on boot</li> <li>sudo systemctl start st40.service - Actually starts the <code>systemd</code> service</li> <li>sudo systemctl status st40.service - Displays the status of the <code>systemd</code> service</li> </ul> Status of the st40.service<pre><code>\u256d\u2500mhubbard@ubuntu-server ~\n\u2570\u2500$ sudo systemctl status st40.service\n\u25cf st40.service - Haas Python logger for ST40\n     Loaded: loaded (/etc/systemd/system/st40.service; enabled; preset: enabled)\n     Active: active (running) since Mon 2025-12-29 16:09:45 PST; 2s ago\n   Main PID: 44301 (python3)\n      Tasks: 1 (limit: 4601)\n     Memory: 6.9M (peak: 7.1M)\n        CPU: 37ms\n     CGroup: /system.slice/st40.service\n             \u2514\u250044301 /usr/bin/python3 /home/mhubbard/Haas/Haas_Data_collect/haas_logger2.py -a -t 192.168.10.122 --port 5052 --name ST40\n\nDec 29 16:09:45 ubuntu-server systemd[1]: Started st40.service - Haas Python logger for ST40.\n</code></pre> <p>Notice the description from the service file is shown. Also, <code>Main PID</code> can be useful during troubleshooting. That is the Process ID, similar to what you would see in the <code>Windows Task Manager</code>. In this case it's 44301 and we can track it using:</p> <pre><code>ps -ef | grep 5052\nmhubbard   44301       1  0 16:09 ?        00:00:00 /usr/bin/python3 /home/mhubbard/Haas/Haas_Data_collect/haas_logger2.py -a -t 192.168.10.122 --port 5052 --name ST40\n</code></pre>"},{"location":"Pi_5_Appliance/#memory-usage","title":"Memory Usage","text":"<p>The status command also lists the amount of RAM used by the script. You can see that the peak usage was 7.1MB. I haven't seen the script use more than that, so a Raspberry Pi 5 with 8GB of RAM could support many machine tools.</p>"},{"location":"Pi_5_Appliance/#other-options-for-the-service-file","title":"Other options for the service file","text":"<p>systemd has capabilities far beyond what is needed for this script. I used Gemini to research systemd for this project. Gemini has a lot of knowledge of <code>systemd</code> if you want to add more services to your appliance </p> <p>The <code>Type=</code> directive in a systemd service file's [Service] section defines how the service manager determines that a service has successfully started.</p> <p>Beyond simple, the available Type options include:</p> <ul> <li>exec: Similar to simple, but systemd considers the service started only after the main service binary has been successfully executed. This is often the preferred choice for long-running processes because it ensures errors like \"missing file\" are caught during startup.</li> <li>forking: Used for traditional UNIX daemons that \"fork\" into the background. Systemd considers the service started when the parent process exits. It is highly recommended to use PIDFile= with this type so systemd can track the correct child process.</li> <li>oneshot: Ideal for scripts that perform a task and then exit. Unlike simple, systemd waits for the process to exit before starting follow-up units. It is often paired with RemainAfterExit=yes to keep the service marked as \"active\" after completion.</li> <li>notify: Similar to exec, but the application must explicitly send a \"READY=1\" signal to systemd (via sd_notify) once it is fully initialized. This is the most reliable way to handle services with long internal initialization periods.</li> <li>notify-reload: A more recent addition that behaves like notify but also implements a standardized protocol for reloading. It expects the service to send \"RELOADING=1\" when it starts a configuration reload.</li> <li>dbus: The service is considered started once it acquires a specific name on the D-Bus bus. You must specify the expected name using the BusName= directive.</li> <li>idle: Similar to simple, but execution is delayed until all other active jobs are finished. This is primarily used to prevent service output from cluttering the boot console.</li> </ul>"},{"location":"Pi_5_Appliance/#scaling-up","title":"Scaling up","text":"<p>If you only have a handful of machines, editing the included service files and changing the name of the <code>systemctl</code> commands is the quickest way to create the service files and enable the services.</p> <p>If you have double or triple digits of machines, that gets old fast. You can use the Python script, <code>conf-gen_xlsx_v1.py</code> included in the repository, and a spreadsheet to generate the files and <code>systemd</code> commands automatically.</p> <p>It's probably easier to clone the repo to your laptop and run the scripts on it. The script will run on Mac/Linux/Windows and you can create the spreadsheet on the laptop. Or just create the spreadsheet on the laptop and copy it to the appliance.</p> <p>The spreadsheet name is <code>machines.xlsx</code>. The format of the spreadsheet is row 1 is a header with the following data:</p> <pre><code>description, username, ip_address, port, name\n</code></pre> <p>Fill out as many rows as you need, save it in the root of the project folder.</p> <p>Here is a example:</p> description   - username ip_address name Logger for ST40 mhubbard 192.168.0.140 st40 Logger for ST30 mhubbard 192.168.0.141 st30 Logger for ST30L mhubbard 192.168.0.142 st30l"},{"location":"Pi_5_Appliance/#create-the-service-files","title":"Create the service files","text":"<p>Run the following:</p> <p><code>python3 conf-gen_xlsx_v1.py -f machines.xlsx -t service-template.txt</code></p> <p>This creates the service files and saves them as <code>&lt;name&gt;.service</code> to the root of the project. Note that you can name the spreadsheet anything you want. Just change the <code>machines.xlsx</code> to the new filename.</p>"},{"location":"Pi_5_Appliance/#create-the-sudo-commands","title":"Create the sudo commands","text":"<p>Run the following: <code>python3 conf-gen_xlsx_v1.py -f machines.xlsx -t systemd-template.txt</code></p> <p>The files are saved as <code>&lt;name&gt;.txt</code> in the root of the project directory. Here are the contents of st40.txt</p> <pre><code>sudo cp st40.service /etc/systemd/system/st40.service\nsudo systemctl daemon-reload\nsudo systemctl enable st40.service\nsudo systemctl start st40.service\nsudo systemctl status st40.service\n\n# Create the directory for the share\n\nmkdir /home/mhubbard/Haas/st40\n\n# Create the share configuration\n\n[st40]\n    comment = Logger for ST40\n    path = /home/mhubbard/Haas/st40\n    read only = no\n    browsable = yes\n</code></pre> <p>It's much easier to peer review a spreadsheet than a bunch of files! If the spreadsheet is accurate, you will instantly get the service files and the commands to install them.</p>"},{"location":"Pi_5_Appliance/#bash-aliases","title":"bash aliases","text":"<p>During debugging you will find yourself typing the <code>systemctl</code> commands a lot. I recommend creating some bash aliases to cut down on the typing. Open the bashrc file on the Pi using <code>nano ~/.bashrc</code> or <code>gnome-text-editor ~/.bashrc</code>. If you are using zsh as your shell, the commands will be <code>nano ~/.zshrc</code> or <code>gnome-text-editor ~/.zshrc</code></p> <p>Note</p> <p>Notice the period in front of the bashrc filename. In Linux/Unix the period at the front of a filename means it is a hidden file. To see hidden files use <code>ls -la</code> which means show all files.</p> <p>Paste the following in at the bottom of the file:</p> <pre><code>alias gte='gnome-text-editor\nalias dmr='sudo systemctl daemon-reload'\nalias stop='(){sudo systemctl stop \"$1\".service}'\nalias start='(){sudo systemctl start \"$1\".service}'\nalias status='(){sudo systemctl status \"$1\".service}'\nalias servfile='(){sudo nano /etc/systemd/system.\"$1\".service}'\n</code></pre> <p>Save the file with <code>ctrl+s</code>, close it with <code>ctrl+x</code> Update bash by typing <code>exec bash</code> and pressing enter.</p>"},{"location":"Pi_5_Appliance/#what-does-the-1-do","title":"What does the $1 do","text":"<p>The <code>$1</code> is a placeholder, it gets replaced with the first text on the command line after the alias name. For example <code>stop st40</code> will become <code>sudo systemctl stop st40.service</code>.</p>"},{"location":"Pi_5_Appliance/#use-the-aliases","title":"Use the aliases","text":"<p>Now you can type the following:</p> <ul> <li><code>gte st30l.service</code> instead of <code>gnome-text-editor st30l.service</code></li> <li><code>stop st40</code> to stop the st40.service</li> <li><code>start st40</code> to start the st40.service</li> <li><code>status st40</code> to show the status of the st40.service</li> <li><code>dmr</code> to reload the daemons</li> </ul>"},{"location":"Pi_5_Appliance/#install-dependencies","title":"Install Dependencies","text":"<p>The script requires some dependencies. Use the following to install them:</p> <pre><code>python -m pip install pandas\npython -m pip install jinja2\npython -m pip install openpyxl\n</code></pre>"},{"location":"Pi_5_Appliance/#use-samba-server-for-windows-integration","title":"Use Samba Server for Windows integration","text":"<p>What is a Samba Server?</p> <p>A Samba server is an open-source software suite that enables seamless file and printer sharing between Linux/Unix systems and Windows systems. It implements the Server Message Block (SMB) and Common Internet File System (CIFS) protocols, which are standard for Windows-based file sharing. Samba also supports integration with Active Directory (AD) environments, making it a versatile tool for mixed-OS networks.</p> <ul> <li>Active Directory Integration: It can act as an Active Directory Domain Controller or a member server, supporting protocols like LDAP and Kerberos.</li> </ul> <p>For my project I chose not to use Active Directory integration because 99% of MSPs will freak out if you say you need a Linux server connected to Active Directory. We are only dealing with one account for the machines, and a handful of accounts for the CNC Programmers, and Operations personnel that will use spreadsheets created by the scripts, so we will create local accounts on the Raspberry Pi 5. If you want use  Active Directory integration there are plenty of blogs/YouTube Videos available.</p>"},{"location":"Pi_5_Appliance/#install-samba-server","title":"Install Samba Server","text":"<p>We will need the table we created earlier for reference. The concept is to create a share on the <code>Haas</code> directory for the scripts to use and a directory/share for each Haas machine tool. This share will be used for the CNC programmer to drop programs into and the machine operator to load from.</p> <p>The final structure will look like this:</p> <pre><code>\u251c\u2500\u2500 Haas\n\u2502   \u251c\u2500\u2500 Haas_Data_collect\n\u2502   \u2502   \u251c\u2500\u2500 cnc_logs\n|   \u251c\u2500\u2500 minimill\n\u2502   \u251c\u2500\u2500 st30\n\u2502   \u251c\u2500\u2500 st30l\n\u2502   \u251c\u2500\u2500 st40\n\u2502   \u251c\u2500\u2500 vf2ss\n\u2502   \u2514\u2500\u2500 vf5ss\n</code></pre> <p>Open a terminal on the Raspberry Pi 5 and enter</p> <pre><code>sudo apt update &amp;&amp; sudo apt install -y samba\n</code></pre> <p>This will install the Samba Server packages. The <code>-y</code> means \"Don't prompt for yes\". If you want to be in control during the installation don't include the <code>-y</code>.</p> <p>Configure the Samba Server to start on boot and start the Samba Server</p> <pre><code>sudo systemctl enable --now smbd\nsudo systemctl start smbd\n</code></pre> <p>If you want to restart the Samba Server use the following:</p> <pre><code>sudo systemctl restart smbd\n</code></pre>"},{"location":"Pi_5_Appliance/#verify-the-installation","title":"Verify the installation","text":"<p>Run the following to verify the Samba Server installation and location:</p> <pre><code>whereis samba\n</code></pre> Command Output<pre><code>samba: /usr/sbin/samba /usr/lib/x86_64-linux-gnu/samba /etc/samba /usr/libexec/samba /usr/share/samba /usr/share/man/man8/samba.8.gz /usr/share/man/man7/samba.7.gz\n</code></pre> <p>Now run this to view the Samba Server version:</p> <pre><code>samba --version\n</code></pre> Command Output<pre><code>Version 4.19.5-Ubuntu\n</code></pre> <p>As you can see, on January 4th, 2025 the current version is 4.19.5.</p> <p>Run the following to see the smb.conf file and service status</p> <pre><code>testparm -s\n</code></pre> Command Output<pre><code>Load smb config files from /etc/samba/smb.conf\nLoaded services file OK.\nWeak crypto is allowed by GnuTLS (e.g. NTLM as a compatibility fallback)\n\nServer role: ROLE_STANDALONE\n</code></pre> <p>This is just the top of the file. The entire smb.conf file will be displayed</p> <p>Run the following to display the Samba Server service status:</p> <pre><code>sudo systemctl status smbd\n</code></pre> Command Output<pre><code>\u25cf smbd.service - Samba SMB Daemon\n     Loaded: loaded (/usr/lib/systemd/system/smbd.service; enabled; preset: enabled)\n     Active: active (running) since Fri 2025-12-26 21:59:34 PST; 1 week 1 day ago\n       Docs: man:smbd(8)\n             man:samba(7)\n             man:smb.conf(5)\n   Main PID: 10736 (smbd)\n     Status: \"smbd: ready to serve connections...\"\n      Tasks: 4 (limit: 4601)\n     Memory: 24.9M (peak: 48.2M swap: 1.4M swap peak: 1.4M)\n        CPU: 23.914s\n     CGroup: /system.slice/smbd.service\n             \u251c\u250010736 /usr/sbin/smbd --foreground --no-process-group\n             \u251c\u250010739 \"smbd: notifyd\" .\n             \u251c\u250010740 \"smbd: cleanupd \"\n             \u2514\u250075813 \"smbd: client [192.168.10.143]\"\n\nDec 27 19:07:06 ubuntu-server smbd[20940]: pam_unix(samba:session): session opened for user mhubbard(uid=1000) by (uid=0)\n</code></pre>"},{"location":"Pi_5_Appliance/#create-the-shares","title":"Create the shares","text":"<p>First we need to create the directories. We can refer to our table for the names:</p> Machine Port# IP Address ST40 5052 192.168.10.141 VF2SS 5053 192.168.10.142 VF5SS 5054 192.168.10.143 MINIMILL 5055 192.168.10.143 ST30 5056 192.168.10.144 ST30L 5057 192.168.10.145 <p>If you are only doing a handful of machines use:</p> <pre><code>mkdir /home/mhubbard/Haas/ST40\n</code></pre> <p>And repeat for each machine. If you used the Python script under Scaling up with the <code>systemd-template.txt</code> it creates the 'mkdir' command along with the aliases.</p> <p>Open the <code>smb.conf</code> file</p> <pre><code>sudo nano /etc/samba/smb.conf\n</code></pre> <p>Go to the bottom of the file and paste this code in:</p> <pre><code># Share for Haas CNC Programs\n\n[Haas]\n    comment = Haas\n    path = /home/mhubbard/Haas\n    read only = no\n    browsable = yes\n</code></pre> <p>This is the root directory. All other shares with be appended to the end of <code>/home/mhubbard/Haas</code>. For example:</p> <pre><code>[ST40]\n    comment = st40\n    path = /home/mhubbard/Haas/st40\n    read only = no\n    browsable = yes\n</code></pre> <p>If you used the Python script with the <code>systemd-template.txt</code>, it creates all of the smb.conf share commands. Open each file and copy the code after <code>Create the share configuration</code>.</p> <pre><code>sudo cp st1.service /etc/systemd/system/st1.service\nsudo systemctl daemon-reload\nsudo systemctl enable st1.service\nsudo systemctl start st1.service\nsudo systemctl status st1.service\n\n# Create the directory for the share\n\nmkdir /home/mhubbard/Haas/st1\n\nCreate the share configuration\n\n[st1]\n    comment =\n    path = /home/mhubbard/Haas/st1\n    read only = no\n    browsable = yes\n</code></pre> <p>After you add all the share configurations, save <code>/etc/samba/smb.conf</code> and exit nano.</p> <p>Based on the table above this is what the share section will look like:</p> <pre><code># Share for Haas CNC Programs\n\n[Haas]\n    comment = Haas\n    path = /home/mhubbard/Haas\n    read only = no\n    browsable = yes\n[ST40]\n    comment = ST40\n    path = /home/mhubbard/Haas/st40\n    read only = no\n    browsable = yes\n[minimill]\n    comment = minimill\n    path = /home/mhubbard/Haas/minimill\n    read only = no\n    browsable = yes\n[VF2SS]\n    comment = vf2ss\n    path = /home/mhubbard/Haas/vf2ss\n    read only = no\n    browsable = yes\n[VF5SS]\n    comment = vf5ss\n    path = /home/mhubbard/Haas/vf5ss\n    read only = no\n    browsable = yes\n[ST30]\n    comment = st30\n    path = /home/mhubbard/Haas/st30\n    read only = no\n    browsable = yes\n[ST30L]\n    comment = st30l\n    path = /home/mhubbard/Haas/st30l\n    read only = no\n    browsable = yes\n</code></pre>"},{"location":"Pi_5_Appliance/#restart-the-samba-server","title":"Restart the Samba Server","text":"<p>This command restarts the samba service. You will need to run it any time you modify the <code>/etc/samba/smb.conf</code> file.</p> <pre><code>sudo systemctl restart smbd\n</code></pre> <p>There is no output from this command.</p>"},{"location":"Pi_5_Appliance/#local-group-management","title":"Local Group Management","text":"<p>Linux uses groups to manage permissions for users. For this project, all users will be in the same group. That isn't a security best practice since a disgruntled employee could delete everything. If you have compliance requirements or other concerns, just repeat this process to create multiple groups. For example, create a user and group for each machine. Then add the user to the machine's share and use it as the username when setting up the account on the machine.</p> <p>Does this seem like a lot of extra work? Yes, but I actually had a disgruntled employee delete the configuration for the DNC system for a neighboring cell one time. Of course, he was a night shift employee, and did it at midnight on Friday. I got called on Saturday morning and had to drive an hour to the plant and restore it. So it depends on your valuation of the risk in your shop.</p>"},{"location":"Pi_5_Appliance/#create-the-haasgroup-group","title":"Create the HaasGroup group","text":"<p><pre><code>sudo groupadd HaasGroup\n</code></pre> There is no output from this command.</p>"},{"location":"Pi_5_Appliance/#set-permissions-on-the-folders","title":"Set permissions on the folders","text":"<p>You need to be in the root of your home director to review the current permissions. Use the following to verify that you are in the correct location:</p> <pre><code>cd ~\npwd\nls -l\n</code></pre> Command Output<pre><code>/home/mhubbard\ndrw-rw-r-- 9 mhubbard mhubbard  4096 Jan  4 20:26 Haas_Data_collect\n</code></pre> <p>We can see the <code>Haas_Data_collect</code> folder, so we are in the correct location. Note that the <code>Haas_Data_collect</code> directory has <code>mhubbard mhubbard</code> listed. We need to change that to <code>mhubbard HaasGroup</code></p> <p>Now run:</p> <pre><code># Allow traversal into /home/mhubbard (needed to reach Haas subdirectory)\nsudo chmod 774 /home/mhubbard\n\n# Set ownership for everything under Haas\nsudo chown -R mhubbard:HaasGroup /home/mhubbard/Haas\n\n# View the changes\nls -l\n</code></pre> Command Output<pre><code>drwxrwxr-x 9 mhubbard HaasGroup  4096 Jan  4 20:26 Haas_Data_collect\n</code></pre> <p>Note the <code>Haas_Data_collect</code> directory had changed from <code>mhubbard mhubbard</code> to <code>mhubbard HaasGroup</code>. That means mhubbard is the owner and HaasGroup is the group that will be applied.</p>"},{"location":"Pi_5_Appliance/#set-the-file-permissions","title":"Set the file permissions","text":"<p>Run the following:</p> <pre><code># Set permissions: directories get execute, files don't\nsudo find /home/mhubbard/Haas -type d -exec chmod 775 {} +\nsudo find /home/mhubbard/Haas -type f -exec chmod 664 {} +\nchmod +x /home/$USER/Haas/Haas_Data_collect/lshare.sh\nchmod +x /home/$USER/Haas/Haas_Data_collect/smb_verify.sh\nchmod +x /home/$USER/Haas/Haas_Data_collect/setup_user.sh\n</code></pre> <p>There is no output from this command. Run a directory listing to see the results:</p> <pre><code>cd ~\nls -l\n</code></pre> Command Output<pre><code>ls -l\ntotal 52\ndrwxrwxr-- 6 mhubbard HaasGroup 4096 Jan  5 12:05 Haas_Data_collect\ndrwxrwxr-- 2 mhubbard HaasGroup 4096 Dec 25 22:43 minimill\ndrwxrwxr-- 2 mhubbard HaasGroup 4096 Dec 26 21:37 st30\ndrwxrwxr-- 2 mhubbard HaasGroup 4096 Dec 26 21:37 st30l\ndrwxrwxr-- 2 mhubbard HaasGroup 4096 Jan  4 15:18 st40\ndrwxrwxr-- 2 mhubbard HaasGroup 4096 Dec 26 21:37 vf2ss\ndrwxrwxr-- 2 mhubbard HaasGroup 4096 Dec 26 21:37 vf5ss\n</code></pre> <p>Now the account <code>mhubbard</code> and the group <code>HaasGroup</code> have <code>rwx</code> (read/write/execute) to directories. The <code>other</code> group has <code>r--</code> (read only). Files will have rw-, read/write.</p> <p>The three bash scripts:</p> <ul> <li>lshare.sh</li> <li>setup_users.sh</li> <li>smb_verify.sh</li> </ul> <p>Have eXecute so that you can run them.</p>"},{"location":"Pi_5_Appliance/#create-the-users","title":"Create the users","text":"<p>You will need to build a list of users that will need to access the shares. In this example I have:</p> <pre><code>|     Username    | Role and Responsibility                                                                                     |\n|:---------------:|-------------------------------------------------------------------------------------------------------------|\n|     haassvc     | The limited permission account used on the Haas CNC control                                                 |\n|     haassvc2    | An account for the customer to manage the Raspberry Pi 5                                                    |\n| Michael Hubbard | The administrator for the Raspberry Pi 5                                                                    |\n|  Manuel Chavez  | CNC Setup technician. Needs to review the CNC Programs from his Windows desktop and review the spreadsheets |\n| Robert Goodwin  | Operations. Needs access to the `cnc_logs` directory to move files                                          |\n</code></pre> <p>Run these command for each user:</p> <pre><code># Create user without shell access\nsudo useradd -M -s /usr/sbin/nologin haassvc\n\n# Add to Samba\nsudo smbpasswd -a haassvc\n\n# Enable the Samba user\nsudo smbpasswd -e haassvc\n</code></pre> <p>The first command creates the user <code>haassvc</code>.</p> <ul> <li>The <code>-M</code> skips creating a user <code>home</code> directory..</li> <li>The <code>-s /usr/sbin/nologin</code> disables shell login (good for service accounts that only need SMB access)</li> </ul> <p>The second command creates the Samba Server user. You will be prompted to enter and confirm a password. Here is the output for the <code>haassvc</code> user:</p> <pre><code>sudo smbpasswd -a haassvc\nNew SMB password:\nRetype new SMB password:\nAdded user haassvc.\n</code></pre> <p>Finally, <code>sudo smbpasswd -e haassvc</code> enables the smb username.</p> <p>Add the haassvc User account to the group:</p> <pre><code>sudo usermod -aG HaasGroup haassvc\n</code></pre>"},{"location":"Pi_5_Appliance/#list-all-users-in-the-haasgroup","title":"List all users in the HaasGroup","text":"<pre><code>cat /etc/group | grep Haas\nHaasGroup:x:1002:haassvc,mhubbard\n</code></pre>"},{"location":"Pi_5_Appliance/#verify-the-haassvc-user-settings","title":"Verify the <code>haassvc</code> user settings","text":"<pre><code>id haassvc\n</code></pre> <p><code>uid=1001(haassvc) gid=1001(haassvc) groups=1001(haassvc),1002(HaasGroup)</code></p>"},{"location":"Pi_5_Appliance/#create-users-the-easy-way","title":"Create users the easy way","text":"<p>It's fairly simple create a user but it's a lot of individual commands which leaves room for errors. There is bash script to do the heavy lifting included in the repository. It gets installed when you clone the repository. To use it, first run the following command:</p> <pre><code>cd /home/mhubbard/Haas/Haas_Data_collect\nchmod +x setup_user.sh\n</code></pre> <p>There is no output from the <code>chmod</code> commmand. Now you can create new users by running the following. Here I am creating the <code>haassvc2</code> user. Replace <code>haassvc2</code> with the username you need to create:</p> <pre><code>sudo ./setup_user.sh haassvc\n</code></pre> <p>How the script works*</p> <ul> <li>You will be asked for your password to activate <code>sudo</code>.</li> <li>You will be  asked for the password to use for the username.</li> <li>You will be  asked for the smbuser password. It MUST be the same as the Linux user!</li> <li>It will then create and enable the smb user, add it to the group and display the result.</li> </ul> <pre><code>[sudo] password for mhubbard:\nAttempting to create and configure user: haassvc2\nSystem user haassvc2 created.\nNew password:\nRetype new password:\npasswd: password updated successfully\nNew SMB password:\nRetype new SMB password:\nAdded user haassvc2.\nEnabled user haassvc2.\nConfiguration complete for haassvc2.\nVerifying user configuration:\nuid=1004(haassvc2) gid=1005(haassvc2) groups=1005(haassvc2),1002(HaasGroup)\n</code></pre> <pre><code>#!/bin/bash\n\n# Function to create a new system user with specific configurations (e.g., Samba, group membership)\n# Usage: create_samba_user &lt;username&gt;\ncreate_samba_user() {\n    # Check if exactly one argument (the username) was provided\n    if [ \"$#\" -ne 1 ]; then\n        echo \"Error: Usage requires exactly one argument: create_samba_user &lt;username&gt;\" &gt;&amp;2\n        return 1\n    fi\n\n    local USERNAME=\"$1\"\n    local GROUP_NAME=\"HaasGroup\"\n\n    echo \"Attempting to create and configure user: $USERNAME\"\n\n    # 1. Create the system user without a home directory and a nologin shell\n    # Error trapping: '|| { ...; return 1; }' stops execution if a command fails\n    sudo useradd -M -s /usr/sbin/nologin \"$USERNAME\" || {\n        echo \"Error creating system user $USERNAME. User may already exist or permissions issue.\" &gt;&amp;2\n        return 1\n    }\n    echo \"System user $USERNAME created.\"\n\n    # 2. Set the system password (will prompt for a new password interactively)\n    # The user running this script will be prompted by 'passwd' to set the password.\n    sudo passwd \"$USERNAME\" || {\n        echo \"Error setting system password for $USERNAME.\" &gt;&amp;2\n        return 1\n    }\n\n    # 3. Add user to Samba database and set the Samba password\n    # The user running this script will be prompted by 'smbpasswd' to set the Samba password.\n    sudo smbpasswd -a \"$USERNAME\" || {\n        echo \"Error adding user to Samba database $USERNAME.\" &gt;&amp;2\n        # Clean up the system user if Samba setup fails\n        sudo userdel \"$USERNAME\"\n        return 1\n    }\n\n    # 4. Enable the Samba account\n    sudo smbpasswd -e \"$USERNAME\" || {\n        echo \"Error enabling Samba account for $USERNAME.\" &gt;&amp;2\n        sudo userdel \"$USERNAME\"\n        return 1\n    }\n\n    # 5. Add the user to the specified group (e.g., HaasGroup)\n    # Note: Ensure 'HaasGroup' exists on your system beforehand.\n    sudo usermod -aG \"$GROUP_NAME\" \"$USERNAME\" || {\n        echo \"Warning: Failed to add $USERNAME to the group $GROUP_NAME. Proceeding anyway.\" &gt;&amp;2\n    }\n\n    echo \"Configuration complete for $USERNAME.\"\n\n    # 6. Display the final user ID/group information for verification\n    echo \"Verifying user configuration:\"\n    id \"$USERNAME\"\n}\n\ncreate_samba_user \"$@\"\n\n# --- Example Usage ---\n# To run this function, save the script (e.g., as setup_user.sh),\n# make it executable (chmod +x setup_user.sh), and run it.\n\n# Example 1: Create user 'jdoe'\n# create_samba_user jdoe\n</code></pre>"},{"location":"Pi_5_Appliance/#verify-the-samba-server","title":"Verify the Samba Server","text":"<p>testparm -s smbclient -L //192.168.10.223 -U mhubbard</p> <p>Here is a function that you can add to your ~/.zshrc file to display the paths to each share. use the following to open your ~./bashrc (or ~/.zshrc) file:</p> <pre><code>nano ~/.bashrc\n</code></pre> <p>Then paste this at the bottom of the file, save and exit.</p> <pre><code>smb-shares() {\n    while IFS= read -r line; do\n        if [[ \"$line\" == \\[*\\] ]]; then\n            # Extract share name without brackets\n            name=\"${line#\\[}\"\n            name=\"${name%\\]}\"\n        fi\n        if [[ \"$line\" == *path\\ =* ]]; then\n            # Skip global, printers, and print$ shares\n            if [[ \"$name\" != \"global\" &amp;&amp; \"$name\" != \"printers\" &amp;&amp; \"$name\" != \"print$\" ]]; then\n                # Extract path after \"path = \"\n                sharepath=\"${line#*path = }\"\n                # Print formatted output\n                printf \"%-12s %s\\n\" \"$name\" \"$sharepath\"\n            fi\n        fi\n    done &lt; /etc/samba/smb.conf\n}\n</code></pre> <p>If you don't want to add the function to your .bashrc file you can use the <code>lshares.sh</code> file that is included with the repository. You have to make it executable using:</p> <pre><code>chmod +x lshare.sh\n</code></pre> <p>Then run the script from the <code>/home/mhubbard/Haas/Haas_Data_collect</code> direcory using:</p> <pre><code>./lshare.sh\n</code></pre> <p>Here is the output of the function:</p> <pre><code>smb-shares\nHaas         /home/mhubbard/Haas\nST40         /home/mhubbard/Haas/st40\nminimill     /home/mhubbard/Haas/minimill\nVF2SS        /home/mhubbard/Haas/vf2ss\nVF5SS        /home/mhubbard/Haas/vf5ss\nST30         /home/mhubbard/Haas/st30\nST30L        /home/mhubbard/Haas/st30l\n</code></pre>"},{"location":"Pi_5_Appliance/#troubleshooting","title":"Troubleshooting","text":"Review the Jounal for user haassvc<pre><code>id haassvc\nsudo journalctl -u smbd.service -n 50 --no-pager\n</code></pre> <pre><code>uid=1001(haassvc) gid=1001(haassvc) groups=1001(haassvc),1002(HaasGroup)\nJan 05 11:05:55 ubuntu-server smbd[96113]: pam_unix(samba:session): session opened for user haassvc(uid=1001) by (uid=0)\n</code></pre>"},{"location":"Pi_5_Appliance/#-smbclient-localhostst40-u-haassvc","title":"- smbclient //localhost/st40 -U haassvc","text":""},{"location":"Pi_5_Appliance/#brief-introduction-to-linux-file-permissions","title":"Brief introduction to Linux file permissions.","text":"<p>You don't need to learn any of this to build an appliance. I am covering it for general knowledge. If you aren't interested please skip it. Claude and ChatGPT have extensive knowledge of the Linux file permissions if you run into a problem.</p> <p>Linux doesn't have the \"Effective Permission\" concept that Windows does.</p> <p>From Gemini: Effective file permissions in Windows 11 combine direct assignments, inheritance from parent folders, and group memberships, allowing you to control who can read, write, or execute files/folders through the Security tab in Properties.</p> <p>In Linux there is only <code>owner</code>, <code>group</code>, and <code>other</code>. Each user has a user ID, <code>UID</code>, each group has a group ID, <code>GID</code>. When you run <code>ls -l</code> you will get a listing of the directories and files with the user, group and other permissions along with the owner and the group associated with each entry.</p> <p>For example:</p> <pre><code>ls -l\ndrwxrwxr-x 6 mhubbard HaasGroup 4096 Jan  5 12:05 Haas_Data_collect\n-rwxrwxr-x 1 mhubbard HaasGroup  646 Jan  4 20:26 lshare.sh\ndrwxrwxr-x 2 mhubbard HaasGroup 4096 Dec 25 22:43 minimill\n</code></pre> <p>The letters break down like this. If the line starts with a <code>d</code> that is a directory.</p> <pre><code> usr|grp|other\n rwx|rwx|r-x\n 421|421|421\n</code></pre> <p>The permissions use three binary digits (1 or 0) to make up the permissions. In the example, mhubbard has <code>rwx</code> which is 7 when you convert the binary <code>111</code> to decimal. The <code>HaasGroup</code> also has <code>rwx</code>. But <code>other</code> has <code>r-x</code> (101) which is 5 in decimal.  So this file has the equivalent of 775 permissions. That's 7 for <code>user</code>, 7 for <code>group</code> and 5 for <code>other</code>.</p> <p>If I logged in as mhubbard, I would have read, write, eXecute permission on the directories and files. Same if I logged in as haassvc and it was a member of the HaasGroup. But anyone else would only have read and eXecute.</p> <p>Note</p> <p>The eXecute permission can be confusing. If a file is a program it means the program can be execute. But if it's a directory it means you have permission to cd into the directory, or use the directory in a pathname. For example, if the <code>haassvc</code> user attempts to execute <code>cd /home/mhubbard/</code>Haas, the haassvc user needs eXecute permission on the <code>/</code> directory, the <code>home</code> directory, the <code>mhubbard</code> directory, and the <code>Haas</code> directory.</p>"},{"location":"Pi_5_Appliance/#securing-the-appliance","title":"Securing the Appliance","text":"<p>The appliance is runnng on Ubuntu 24.04 which has many security features that Canonical has learned from being a very popular Internet Web server OS. Since the Raspberry Pi 5 appliance is only meant to transfer files to/from the Haas CNC control and the programmers, and connect to the Haas CNC controls using a redefined port and IP address to collect data, we can lock it down using local user accounts, file permissions, share permissions and the Uncomplicated Firewall (UFW).</p> <p>In addition to the Haas CNC ports we define, the Raspberry Pi 5 appliance needs to have SSH exposed to the customer user that is repsonsible for management of the appliance. Ubuntu 24.04 ships with OpenSSH 9.6 which has removed ssh-dss and made many other legacy protocols optional.You can verify the version using: <pre><code>ssh -V\n</code></pre> Command Output<pre><code>OpenSSH_9.6p1 Ubuntu-3ubuntu13.14, OpenSSL 3.0.13 30 Jan 2024\n</code></pre></p> <p>title='Command Output'</p>"},{"location":"installing_python/","title":"Installing Python","text":"<p>The scripts will run on Mac/Linux/Windows. Each of those operating systems requires different steps to install Python, pip, and the script. All three operating systems are covered below.</p>"},{"location":"installing_python/#windows-10-and-windows-11","title":"Windows 10 and Windows 11","text":"<p>If you haven't done any Python development on your Windows machine, it won't have Python or Git installed. Python is the language the scripts are written in and Git is the industry standard version control system for NetDevOps. Follow the instructions below to install both packages.</p> <p>Installing Python on Windows is simple.</p> <p>Note</p> <p>Select \"Install for all users\" during the installation. If you don't select the all users option, only the user account that did the installation will have access.</p> <ul> <li>Open the Edge browser</li> <li>Go to the Python download Page</li> <li>Click on the button for Python 3.14.2 (or the latest version)</li> <li>Select <code>Open File</code> so that the install starts when the download finishes.</li> </ul>"},{"location":"installing_python/#custom-settings","title":"Custom settings","text":"<p>Check the boxes for documentation, pip, <code>py launcher</code> and <code>for all users (requires admin privileges)</code>. If you don't select the <code>all users option</code>, only the user account that did the installation will have access to run the scripts. If you plan to write Python scripts, check the <code>Tcl/Tk, turtle, IDLE</code> box and the <code>Python test suite</code> boxes.</p> <p></p> <p>Click next, on this dialog check the check \"Add Python to environment variables\"</p> <p>For the path I recommend changing it to <code>c:\\python3.14</code>. I like to start the script using a batch file and having a space in the path is a pain to deal with.</p> <p></p> <p>Click <code>Install</code> to finish the installation.</p> <p>You can use <code>where python</code> from a <code>cmd</code> terminal to verify that Python is installed.</p> <p><code>where python</code></p> Command Output<pre><code>C:\\python3.14\\python.exe\n</code></pre> <p>You can also use the GUI tool Add or Remove Programs to verify Python is installed.</p> <p>To verify that <code>pip</code> is installed use:</p> <pre><code>pip --version\n</code></pre>"},{"location":"installing_python/#test-the-python-installation-on-windows","title":"Test the Python installation on Windows","text":"<p>type <code>python</code></p> <p>You should see something like this:</p> Command Output<pre><code>Python 3.14.2 (tags/v3.14.2:df79316, Dec  5 2025, 17:18:21) [MSC v.1944 64 bit (AMD64)] on win32\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n&gt;&gt;&gt;\n</code></pre> <p>To quit Python, type:</p> <p><code>quit()</code></p>"},{"location":"installing_python/#updating-python-on-windows","title":"Updating Python on Windows","text":"<p>Python doesn't get updated when you run Windows Update. You will need to go back to the Python Download Page and download the latest version.</p> <p>When you launch the installer:</p> <p>\u2714 If you want to upgrade in place The installer will detect your existing version and offer \u201cUpgrade Now\u201d (for minor versions, e.g., 3.11 \u2192 3.11.x).</p> <p>\u2714 If you\u2019re installing a new major version (e.g., 3.10 \u2192 3.12), Python installs side\u2011by\u2011side. This is normal and expected. You\u2019ll have multiple versions available, and the py launcher lets you choose which one to run.</p> <p>Run these commands to update the Python Packages that are installed:</p> <ul> <li>python -m pip list --outdated</li> <li>python -m pip install --upgrade [package-name]</li> </ul>"},{"location":"installing_python/#install-git-on-windows","title":"Install Git on Windows","text":"<p>If you are on Windows and don't have git installed, use</p> <p><code>winget install --id Git.Git -e --source winget</code></p> <p>from cmd or PowerShell to install Git.</p> <p>WinGet, also known as the Windows Package Manager, is pre-installed on Windows 11 versions 21H2 and later. If you don't have Winget installed, you can install it using these steps:</p> <pre><code>Type Microsoft Store in the Windows search bar, and press Enter\nSearch for App Installer\nClick on Get\n</code></pre> <p>Or you can install the git package from The Official Git Page. It seems better to use the Microsoft Store, but I'm not a Windows expert.</p>"},{"location":"installing_python/#install-on-macos","title":"Install on macOS","text":"<p>Apple provides a package called <code>xcode-select</code> that's full of developer tools like Python, git, and gcc (Gnu C Compiler), etc. To install <code>xcode-select</code>:</p> <ul> <li>Open a terminal (  + spacebar)</li> <li>Type xcode-select --install</li> <li>Press [enter]</li> </ul> <p>You can list the tools using</p> <p><code>ls /Library/Developer/CommandLineTools/usr/bin/</code></p> <p>You now have Python, git, venv, and many other dev tools.</p>"},{"location":"installing_python/#ubuntu-2404-or-higher","title":"Ubuntu 24.04 or higher","text":"<p>Ubuntu comes with Python installed. We only need to install <code>git</code> to clone the repository.</p> <p><code>sudo apt install git -y</code></p>"},{"location":"usage/","title":"How to use the Python logger script","text":"<p>The first step is downloading the script from my GitHub Repository. There are several ways to accomplish that task depending on your Operating System and how deep you want to go down the rabbit hole!</p>"},{"location":"usage/#download-the-script","title":"Download the script","text":"<ul> <li>From the homepage of the repository, click on <code>haas_logger2.py</code></li> <li>Click on the <code>Raw</code> download icon</li> <li>Save the file to a location on your drive.</li> </ul>"},{"location":"usage/#download-the-repo","title":"Download the Repo","text":"<p>You can also download a <code>zip</code> file with the entire repository. That is useful if you are going to build an appliance and need all of the scripts and files. To download the repository as a <code>zip</code> file:</p> <ul> <li>Open the Edge browser and navigate to the GitHub Repository.</li> <li>Click on the green <code>Code</code> button</li> <li>Click on <code>Download ZIP</code></li> <li>Unzip the files to your hard drive.</li> </ul> <p></p> <p>Note</p> <p>The unzip process with create two <code>Haas_Data_collect_main</code> folders. Navigate to the second one, highlight all the files, cut and paste them into the first folder.</p>"},{"location":"usage/#clone-the-repository","title":"Clone the Repository","text":"<p>Cloning the repository pulls down all the files into a directory named <code>Haas_Data_collect</code> on your local drive. The installation steps are done in the Mac/Linux terminal or cmd.exe/PowerShell on Windows. In my recent testing on Windows 11 24H2, I learned a lot about using PowerShell on Windows 11. I created a page on what my setup looks like. I highly recommend installing the Windows Terminal and setting up PowerShell if you are a Windows user. Here is a link to the page - Using PowerShell with the Network Discovery scripts. PowerShell is also available on Mac/Linux. The configurations on the \"Using PowerShell\" page work on all three OSes.</p> <p>Open the Mac/Linux terminal or cmd/PowerShell terminal and cd to a location you want to install the scripts into. I have a directory named <code>Tools</code> that I use to organize tools I download from the Internet.</p> <p>Then paste the following:</p> <pre><code>git clone https://github.com/rikosintie/Haas_Data_collect.git\ncd Haas_Data_collect\n</code></pre> <p>The cloning operation creates a subfolder named <code>Haas_Data_collect</code></p> <p>Inside the folder will be the :</p> <ul> <li>haas_logger2.py - The script to listen for the Haas machines' output</li> <li>cnc_logs - a folder to hold the data files</li> <li>dprnt_example.txt - A sample CNC program with the dprnt statements</li> <li>All of the scripts and files needed to build a data collection appliance.</li> </ul> <p>Note</p> <p>You should run <code>git pull</code> on a regular basis. If there are any updates to the project, this will copy them down and overwrite the existing files.</p>"},{"location":"usage/#configure-the-cnc-for-output","title":"Configure the CNC for output","text":"<p>Your CNC control must be connected to an Ethernet network either by Wi-Fi or cable. This Haas Video does a great jobs explaining how to setup <code>TCP/IP</code> on your control.</p>"},{"location":"usage/#configure-the-control-to-output-dprnt-statements","title":"Configure the control to output <code>DPRNT</code> statements","text":"<p>On the <code>settings</code> page, search for dprnt</p> <ul> <li>Option 261 - set to <code>TCP Port</code></li> <li>Option 262 - set to <code>User Data</code></li> <li>Option 263 - set to <code>5052</code></li> </ul> <p>The port number doesn't have to be unique per machine. The IP address of the  CNC control is unique so the ports can all be the same. I like to use unique port numbers. For example, my shop has six machines and I use:</p> <ul> <li>Machine1 - set to 5051</li> <li>Machine2 - set to 5052</li> <li>Machine3 - set to 5053</li> <li>Machine4 - set to 5054</li> <li>Machine5 - set to 5055</li> <li>Machine6 - set to 5056</li> </ul> <p>Here is a screenshot for machine2:</p> <p></p>"},{"location":"usage/#run-the-script","title":"Run the script","text":"<p>When you execute the script, <code>Haas_logger2.py</code>, it runs continuously until you press <code>ctrl+c</code>. When <code>DPRNT[End of Cycle]</code> is executed in the CNC program, the script writes the data to disk and then resumes listening. Multiple copies of the script can be started on the same server to collect from multiple CNC machines concurrently.</p> <p>The script accepts four parameters:</p> <ul> <li>-a or (--append) Save all data from a part number to the same file.</li> <li>-n or (--name) is the name of the machine. Used in the name of file that is saved.</li> <li>-p or (--port) is the port that is configured with parameter 263.</li> <li>-t is the IP address of the <code>Haas</code> machine tool.</li> </ul> <p>The script will connect to the machine using the IP address like putty does in the Haas Video.</p>"},{"location":"usage/#the-script-help-text","title":"The script help text","text":"<p>If you run the script with just <code>-h</code> as a parameter, the following help will be printed to the screen.</p> <pre><code>python haas_logger2.py -h\nusage: haas_logger2.py [-h] [-H HOST] [-p PORT] [-n MACHINE_NAME] [-a] [-t TARGET_IP]\n\nHaas CNC Data Logger - Connects to a CNC machine and saves output to files\n\noptions:\n  -h, --help            show this help message and exit\n  -H, --host HOST       Host IP to bind to in server mode (default: 0.0.0.0)\n  -p, --port PORT       Port to listen on or connect to (default: 5062)\n  -n, --name MACHINE_NAME\n                        Machine name for filename (default: Machine_Port####)\n  -a, --append          Append mode: Save all cycles for same part number to one file\n  -t, --target TARGET_IP\n                        Target IP address to connect to (client mode). If not specified, runs in server mode.\n\nExamples:\n    CLIENT MODE (Connect to the Haas CNC machine):\n    python haas_logger.py -t 172.16.1.100                 # Connect to machine at this IP\n    python haas_logger.py -t 172.16.1.100 -p 5063         # Connect to machine on custom port\n    python haas_logger.py -t 172.16.1.100 -a -n \"Mill_1\"  # Connect with append mode and custom name\n\n    ---------------------\n\n    SERVER MODE (Listens for connections. Only used for script development, not production):\n    python haas_logger.py                          # Listen on default port 5062\n    python haas_logger.py -p 5063 -a               # Listen on port 5063 with append mode\n    python haas_logger.py -H 0.0.0.0 -p 5062       # Listen on all interfaces\n\nNotes:\n    - Use -t to connect to a Haas machine (client mode)\n    - Without -t, the script waits for the machine to connect (server mode)\n    - In append mode (-a), close CSV files on PCs before production runs to avoid file locks\n    - If a file is locked, the script will retry 3 times then create a backup file\n    - In client mode, the script will auto-reconnect if the connection is lost\n</code></pre> <p>Warning</p> <p>Server mode isn't for use with Haas Data Collection. It's a mode for testing the script. The haas_simulator.py script is used to send data to the script running in server mode.</p>"},{"location":"usage/#usage-examples","title":"Usage examples","text":"<pre><code># Machine 1\npython haas_logger2.py -t 172.16.1.11  --port 5052 --name \"Lathe1\"\n\n# Machine 2\npython haas_logger2.py -t 172.16.1.12  --port 5053 --name \"Lathe2\"\n\n# Machine 3\npython haas_logger2.py -t 172.16.1.13  -p 5054 -n \"Lathe3\"\n\n# Machine 4\npython haas_logger2.py -t 172.16.1.14  -p 5055 -n \"Mill1\"\n\n# Machine 5\npython haas_logger2.py -t 172.16.1.15  -p 5056 -n \"Mill2\"\n\n# Machine 6\npython haas_logger2.py -t 172.16.1.16 -p 5057 -n \"Mill3\"\n</code></pre> <p>A new file is created each time using the naming format: <code>machine-name_\"part-number\"_yymmdd_hh:mm:ss.csv</code>.</p> <p>For example - <code>Machine1_\u201c265-4183\u201d_20251202_151020.csv</code></p>"},{"location":"usage/#append-mode","title":"Append mode","text":"<p>If you want all data from one part number collected in one file instead of one file per cycle use the <code>-a</code> append flag. One file is created using the naming format: <code>machine-name_part-number.csv</code>.</p> <p>For example - <code>Machine1_strut.csv</code></p>"},{"location":"usage/#cnc-program-format","title":"CNC Program Format","text":"<p>The sample code for DPRNT can be downloaded from the Haas.com site by clicking here.</p>"},{"location":"usage/#dprnt-alloweddisallowed-characters","title":"DPRNT Allowed/Disallowed Characters","text":""},{"location":"usage/#allowed-characters","title":"Allowed Characters","text":"<ul> <li>, + - . * () ? : # {} _ /</li> <li>a-z A-Z 0-9</li> </ul>"},{"location":"usage/#disallowed-characters-results-in-alarm-535","title":"Disallowed characters, results in alarm 535","text":"<ul> <li>\" &amp; \\ ; ` ~ | ' &lt;&gt; ! @ $ % ^ =</li> <li>other languages like \u03b1\u03b2\u03b3\u6c49\u5b57</li> <li>ascii chars like \u00ae \u00b1 \u20ac</li> </ul>"},{"location":"usage/#here-is-a-simple-example","title":"Here is a simple example","text":"<pre><code>%\nO03020 (DPRNT PART DATA)\nG04 P1. (1 SECOND DWELL, SO WE HAVE A CYCLE TIME)\nG103 P1 (LIMIT LOOKAHEAD)\n(DPRNT BLANK LINE)\nDPRNT[]\n(DPRNTS ALL TEXT, A PART NUMBER)\nDPRNT[ PART NUMBER: 265-4183, REV. X2]\n(DPRNT BLANK LINE)\nDPRNT[]\n(SIMPLE DATE AND TIME)\nDPRNT[ DATE YYMMDD: #3011[60]]\nDPRNT[ TIME HHMMSS: #3012[60]]\n(DPRNT BLANK LINE)\nDPRNT[]\n(DPRNT BLANK LINE)\nDPRNT[]\n(#3901 PARTS COUNTER)\nDPRNT[*PARTS*MADE:*#3901[90]]\n(DPRNT BLANK LINE)\nDPRNT[]\n(#3024 LAST PART TIMER)\nDPRNT[*TIME,*LAST PART:*#3024[40]*SECONDS]\nG103 (RETURN TO NORMAL LOOKAHEAD)\nDPRNT[End of Cycle]\nM30\n%\n</code></pre>"},{"location":"usage/#screen-output-from-haas_logger2py-when-using-the-append-flag","title":"Screen output from haas_logger2.py when using the Append flag","text":"<pre><code>python haas_logger2.py --port 5052 -a --name \"Machine1\"\n[Machine1] Haas CNC Data Logger started on 0.0.0.0:5052 (APPEND mode)\n[Machine1] Waiting for connections...\n[Machine1] TIP: Close CSV files in Excel to avoid file lock issues\n[Machine1] Press Ctrl+C to stop\n[Machine1] Connection established from ('172.16.0.143', 59994)\n[Machine1] Part number detected: \u201c265-4183\u201d\n[Machine1] End of cycle detected!\n[Machine1] Data appended to: cnc_logs/Machine1_\u201c265-4183\u201d.csv\n[Machine1] Connection closed from ('172.16.0.143', 59994)\n[Machine1] Connection established from ('172.16.0.143', 46606)\n[Machine1] Part number detected: \u201c265-4183\u201d\n[Machine1] End of cycle detected!\n[Machine1] Data appended to: cnc_logs/Machine1_\u201c265-4183\u201d.csv\n[Machine1] Connection closed from ('172.16.0.143', 46606)\n</code></pre>"},{"location":"usage/#screen-output-from-haas_logger2py-without-the-append-flag","title":"Screen output from haas_logger2.py without the Append flag","text":"<pre><code>python haas_logger2.py --port 5052 --name \"Machine1\"\n[Machine1] Haas CNC Data Logger started on 0.0.0.0:5052\n[Machine1] Waiting for connections...\n[Machine1] Press Ctrl+C to stop\n[Machine1] Connection established from ('127.0.0.1', 43052)\n[Machine1] Part number detected: TEST-001\n[Machine1] End of cycle detected!\n[Machine1] Data saved to: cnc_logs/Machine1_TEST-001_20251202_141427.csv\n[Machine1] Connection closed from ('127.0.0.1', 43052)\n[Machine1] Connection established from ('127.0.0.1', 56304)\n[Machine1] Part number detected: TEST-002\n[Machine1] End of cycle detected!\n[Machine1] Data saved to: cnc_logs/Machine1_TEST-002_20251202_141537.csv\n[Machine1] Connection closed from ('127.0.0.1', 56304)\n[Machine1] Connection established from ('127.0.0.1', 49556)\n[Machine1] Part number detected: TEST-002\n[Machine1] End of cycle detected!\n[Machine1] Data saved to: cnc_logs/Machine1_TEST-002_20251202_150918.csv\n[Machine1] Connection closed from ('127.0.0.1', 49556)\n[Machine1] Connection established from ('127.0.0.1', 39222)\n[Machine1] Part number detected: \u201c265-4183\u201d\n[Machine1] End of cycle detected!\n[Machine1] Data saved to: cnc_logs/Machine1_\u201c265-4183\u201d_20251202_151020.csv\n</code></pre>"},{"location":"usage/#start-up-files","title":"Start up files","text":"<p>If you have several Haas machines and want to collect data from all of them it gets tiresome to type the script command for each machine. I have created two Windows batch files that you can modify or your own use.</p> <p>This batch file uses the Windows cmd.exe to open a new cmd process for each machine:</p> <pre><code>set PY=C:\\Python314\\python.exe\nset SCRIPT=C:\\Users\\micha\\Downloads\\Haas_Data_collect\\haas_logger2.py\n\nrem Start each CNC logger in its own window\n\nstart \"ST40\"      cmd /k \"%PY% %SCRIPT% -t 172.16.0.21 -a -p 5052 -n ST40\"\nstart \"VF2SS\"     cmd /k \"%PY% %SCRIPT% -t 172.16.0.22 -a -p 5053 -n VF2SS\"\nstart \"VF5SS\"     cmd /k \"%PY% %SCRIPT% -t 172.16.0.23 -a -p 5054 -n VF5SS\"\nstart \"MINIMILL\"  cmd /k \"%PY% %SCRIPT% -t 172.16.0.24 -a -p 5055 -n MINIMILL\"\nstart \"ST30\"      cmd /k \"%PY% %SCRIPT% -t 172.16.0.25 -a -p 5056 -n ST30\"\nstart \"ST30L\"     cmd /k \"%PY% %SCRIPT% -t 172.16.0.26 -a -p 5057 -n ST30L\"\n\nexit /b\n</code></pre> <p>You will need to change the PY variable to match where you installed Python, and the <code>SCRIPT</code> variable to the path where you unzipped the files.</p> <p>Then update the IP Addresses and names to match your machines.</p> <p>This batch file uses the Windows terminal to open a new tab for each machine:</p> <pre><code>@echo off\nREM Launch Haas loggers in separate tabs\n\nwt ^\n  new-tab -p \"Haas Loggers ST40\" ^\n  ; new-tab -p \"Haas Loggers VF2SS\" ^\n  ; new-tab -p \"Haas Loggers VF5SS\" ^\n  ; new-tab -p \"Haas Loggers MINIMILL\" ^\n  ; new-tab -p \"Haas Loggers ST30\" ^\n  ; new-tab -p \"Haas Loggers ST30L\"\n</code></pre> <p>You will need to change the PY variable to match where you installed Python, the <code>SCRIPT</code> variable to the path where you unzipped the files.</p> <p>Then update the IP Addresses and names to match your machines.</p> <p>I prefer the terminal script if you have the Windows terminal installed.</p>"},{"location":"usage/#if-you-dont-have-access-to-a-haas-control","title":"If you don't have access to a Haas control","text":"<p>If you want to work on the Python scripts when you are at home, you can use the Linux <code>netcat</code> application to simulate a Haas control on a Mac/Linux laptop or Windows Subsystem for Linux (WSL).</p> <p>In this example, nc is running on a PC with IP address 172.16.0.223.</p> <ul> <li>Open a terminal</li> <li>paste in <code>sudo nc -lvkp 5052</code> and press Enter</li> </ul> <p>You will see <code>Listening on 0.0.0.0 5052</code> in the terminal.</p> <p>Type the dprnt commands, pressing Enter after each one. Type <code>End of Cycle</code> to write the data.</p> <pre><code>sudo nc -lvkp 5052\n\nListening on 0.0.0.0 5052\nConnection received on 1S1K-G5-5587.pu.pri 41104\nPART NUMBER: 265-4183, REV. X2\nEnd of Cycle\n</code></pre> <p>On the laptop with the script running:</p> <pre><code>[Machine2] Attempting to connect to 172.16.0.223:5052...\n[Machine2] Successfully connected!\n[Machine2] Connected to ('172.16.0.223', 5052)\n[Machine2] Part number detected: 265-4183\n[Machine2] End of cycle detected!\n[Machine2] Data saved to: cnc_logs/Machine2_265-4183_20251208_121016.csv\n</code></pre>"},{"location":"appendices/appendix-a/","title":"How is the appliance hardened?","text":"<p>The appliance is built on Ubuntu 24.04 which is a Long Term Support (LTS) version of Ubuntu. Ubuntu 24.04 is well tested in enterprises and the Ubuntu team releases security patches on a regular schedule.</p> <p>Since the appliance has a very limited role it can be hardened against typical attacks. The follow steps are completed by the installation script:</p> <ol> <li> <p>Minimal Attack Surface</p> <ol> <li>The system runs Ubuntu 24.04.3 LTS, a long\u2011term\u2011support OS with a stable security update cadence.</li> <li>Only essential services are installed:<ol> <li>SSH for administrative access</li> <li>Cockpit for web\u2011based monitoring</li> <li>Samba for Windows compatible drive mapping</li> </ol> </li> </ol> </li> <li> <p>Strict Network Access Control</p> <ol> <li>UFW is enabled and default\u2011deny for all inbound traffic.</li> <li>Only explicitly authorized devices (by IP or subnet) are allowed to reach:<ol> <li>TCP 22 (SSH)</li> <li>TCP 445 (SMB)</li> <li>TCP 9090 (Cockpit)</li> </ol> </li> <li>No outbound restrictions are required; the appliance only initiates connections to the Haas controls.</li> <li>No outbound control signals, no CNC commands, no remote execution.</li> </ol> </li> <li> <p>SSH Hardening</p> <ol> <li>OpenSSH 9.9p1 with modern cryptography only.</li> <li>Legacy algorithms removed (e.g., DSA host keys).</li> <li>Only strong key\u2011exchange, host\u2011key, and cipher suites remain enabled by default.</li> <li>A login banner warn users that access is restricted BEFORE logging in.</li> <li>Root login disabled.</li> <li>See MSP/MSSP Guidance for SSH for even stronger ssh hardening guidance.</li> </ol> </li> <li> <p>Samba Hardening</p> <ol> <li>Minimum of SMBv2 enforced.</li> <li>Printer sharing disabled.</li> <li>Shares are exposed to authorized IP addresses with only R/W permissions.</li> <li>Samba users are Linux system users; no guest access.</li> <li>No NetBIOS name service or legacy SMB1 traffic.</li> </ol> </li> <li> <p>Cockpit Hardening</p> <ol> <li>Cockpit is only reachable from authorized IPs.</li> <li>HTTPS enforced (self\u2011signed or appliance\u2011generated certificate).</li> <li>No optional Cockpit modules installed beyond what the appliance requires.</li> </ol> </li> <li> <p>Filesystem &amp; Permissions</p> <ol> <li>Application code and Cockpit extensions installed under /usr/share/cockpit/ with root\u2011owned, read\u2011only permissions.</li> <li>Scripts under /usr/local/sbin are root\u2011owned and non\u2011writable by users.</li> <li>No world\u2011writable directories except system\u2011required ones (/tmp, /var/tmp).</li> <li>Logs stored under /var/log with standard Linux permissions.</li> </ol> </li> <li> <p>Automatic Security Updates (requires optional Ubuntu Pro registration)</p> <ol> <li>unattended-upgrades enabled for:<ol> <li>Ubuntu security patches</li> <li>Kernel updates</li> <li>OpenSSH/Samba/Cockpit updates</li> </ol> </li> <li>Reboots are not automatic; the appliance notifies the operator when a reboot is required.</li> </ol> </li> <li> <p>No External Dependencies</p> <ol> <li>The appliance does not rely on cloud services, APIs, or external authentication.</li> <li>All functionality is local and self\u2011contained.</li> <li>No telemetry, analytics, or remote\u2011management agents installed.</li> </ol> </li> <li> <p>Physical Security Assumptions</p> <ol> <li>The appliance is intended to be installed inside a machine shop\u2019s secure network closet or control cabinet.</li> <li>No USB devices are required for operation.</li> <li>The system auto\u2011locks the console and requires a password for local login.</li> </ol> </li> <li> <p>Operational Safety</p> <ol> <li>The appliance does not modify machine\u2011tool configurations.</li> <li>The appliance reads machine\u2011generated data via Telnet and saves it to directories that are exposed by SMB (port 445 Microsoft file sharing).</li> </ol> </li> <li> <p>IPv6 Link\u2011Local Provisioning</p> <ol> <li>The appliance supports standards\u2011based IPv6 link\u2011local provisioning, identical to how network switches are configured out\u2011of\u2011box.</li> <li>Windows/Mac/Linux clients can SSH into the appliance using IPv6 EUI\u201164 addressing if the segmented network doesn't support DHCP address management.</li> <li>Windows Wi\u2011Fi does not support IPv6 link\u2011local provisioning; this is a Windows limitation, not an appliance limitation.</li> <li>Clear instructions are provided for MSPs on how to connect using a wired interface.</li> </ol> </li> <li> <p>IPv6 Machine tool network</p> <ol> <li>The <code>/etc/haas-firewall.conf</code> file supports a segmented IPv6 vlan for the machine tools.</li> <li>Edit the entry <code>HAAS_MACHINES_SUBNET_V6=\"\"</code> to add your IPv6 subnet.</li> </ol> </li> </ol> <p>Note</p> <pre><code>The IPv6 capability is for future proofing. I don't believe that the Haas CNC control currently supports IPv6\n</code></pre>"},{"location":"appendices/appendix-a/#mspmssp-guidance-for-ssh","title":"MSP/MSSP Guidance for SSH","text":"<p>Out of the box, the appliance supports username/password login for SSH. The following non-default settings are configured:</p> <ul> <li>Root login is disabled (PermitRootLogin no)</li> <li>Empty Passwords are not permitted (PermitEmptyPasswords no)</li> <li>Pre-login banner is configured (Banner /etc/issue.net)</li> </ul> <p>If the environment uses SSH keys for logins, the following additional steps can be taken to lock the appliance down using SSH Keys. Do not run this unless you are sure that you have configured ssh keys on your laptop and copied the public key to the appliance!</p>"},{"location":"appendices/appendix-a/#drop-in-config-file","title":"Drop-In Config File","text":"<p>Ubuntu 24.04 supports modular SSH configuration using the Include directive in the primary sshd_config file. Drop-in files located in /etc/ssh/sshd_config.d/ are automatically loaded</p> <p>You can create:</p> <p><code>/etc/ssh/sshd_config.d/99-haas-hardening.conf</code></p> <p>to keep custom security controls in an OpenSSH drop-in configuration file.</p> <p>This approach ensures:</p> <ul> <li>Clear separation from operating system defaults</li> <li>Improved audit transparency</li> <li>Clean survivability across package updates</li> <li>Simple identification of appliance-specific security controls</li> </ul>"},{"location":"appendices/appendix-a/#security-rationale","title":"Security Rationale","text":"<ul> <li>PermitRootLogin no Prevents direct root authentication, enforcing user accountability and privilege escalation via sudo.</li> <li>PasswordAuthentication no Eliminates exposure to password brute-force attempts. SSH access requires key-based authentication.</li> <li>PubkeyAuthentication yes Ensures modern cryptographic authentication is enabled.</li> <li>ChallengeResponseAuthentication no Disables legacy interactive authentication mechanisms not required for appliance operation.</li> <li>PermitEmptyPasswords no Prevents authentication with blank credentials.</li> </ul> <p>These controls align with common MSP/MSSP baseline requirements and typical CIS Level 1 guidance.</p>"},{"location":"appendices/appendix-a/#implementation","title":"Implementation","text":"<p>You can create the drop-in file using the following commands:</p> <pre><code>sudo tee /etc/ssh/sshd_config.d/99-haas-hardening.conf &gt; /dev/null &lt;&lt; 'EOF'\nBanner /etc/issue.net\nChallengeResponseAuthentication no\nLogLevel VERBOSE\nPasswordAuthentication no\nPermitEmptyPasswords no\nPermitRootLogin no\nPubkeyAuthentication yes\nX11Forwarding no\nEOF\n\nsudo systemctl restart ssh\n</code></pre> <p>Warning</p> <p>Make sure that you have created the SSH keys on your laptop and copied the public key to the appliance before running this code. Otherwise you will be locked out and have to use a monitor/keyboard or serial cable to recover.</p> <p>I have detailed instructions on setting up SSH for network devices that covers creating ssh keys here: Creating SSH Keys.</p>"},{"location":"appendices/appendix-a/#verification","title":"Verification","text":"<p>To confirm effective configuration, run:</p> <pre><code>sudo sshd -T | grep -E 'permitrootlogin|passwordauthentication|pubkeyauthentication|challengeresponseauthentication|permitemptypasswords|^banner|x11f'\n</code></pre> Command Output<pre><code>permitrootlogin no\npubkeyauthentication yes\npasswordauthentication yes\nx11forwarding no\npermitemptypasswords no\nbanner /etc/issue.net\n</code></pre> <p>The output should reflect the enforced values.</p> <p>Run this command to verify the port that ssh is actually listening on:</p> <pre><code>sudo ss -tulpn | grep ssh\n</code></pre> Command Output<pre><code>tcp   LISTEN 0      4096                             0.0.0.0:3333       0.0.0.0:*    users:((\"sshd\",pid=46557,fd=3),(\"systemd\",pid=1,fd=66))\ntcp   LISTEN 0      4096                                [::]:3333          [::]:*    users:((\"sshd\",pid=46557,fd=4),(\"systemd\",pid=1,fd=67))\n</code></pre> <p>Operational Considerations Before disabling password authentication:</p> <ul> <li>Confirm SSH key-based access is functional.</li> <li>Verify correct permissions:<ol> <li>~/.ssh \u2192 700</li> <li>authorized_keys \u2192 600</li> </ol> </li> </ul> <p>Failure to validate key access before disabling passwords may result in administrative lockout.</p>"},{"location":"appendices/appendix-a/#custom-ssh-port","title":"Custom SSH port","text":"<p>If your company's security policy requires a custom SSH port, you can use the <code>ssh_port.sh</code> script in the root of the <code>Haas_Data_collect</code> directory. The script prompts for a port number, then:</p> <ul> <li>Updates /etc/ssh/sshd_config</li> <li>Updates /etc/haas-firewall.conf</li> <li>restarts the ssh daemon</li> </ul> <p>You can run the script as often as you want. It updates both files each time.</p> <p>If you are concerned about SSH security, I recommend switching to SSH keys after changing the port. It is nearly impossible to brute-force a certificate.</p>"},{"location":"appendices/appendix-a/#the-ssh_port-script","title":"The ssh_port script","text":"<p>The script must be run with <code>sudo</code> since it modifies <code>/ect/haas-firewall.conf</code> and /etc/ssh/sshd_config`. Use the following to run the script:</p> <pre><code>sudo ./ssh_port.sh\n</code></pre> Command Output<pre><code>#############################################\n#                                           #\n#      Configure a custom port for SSH      #\n#  Use port 22 or a port between 1024-65535 #\n#                                           #\n#############################################\n\n\nEnter the SSH port number (22, 1024-65535): 3333\n\nSSH_PORT set to 3333\nUpdating /etc/ssh/sshd_config...\nUpdating /etc/haas-firewall.conf...\n\nRestarting SSH Service...\n\n\nFeb 19 14:31:38 haas sshd[47452]: Server listening on 0.0.0.0 port 3333.\nFeb 19 14:31:38 haas sshd[47452]: Server listening on :: port 3333.\n\n\n##########################################################\n\n           Script is now complete!\n  The SSH service is configured for port 3333\n  /etc/haas-firewall.conf is updated with SSH_PORT=3333\n        Use Cockpit to update the Firewall\n\n##########################################################\n</code></pre>"},{"location":"appendices/appendix-a/#update-the-firewall","title":"Update the firewall","text":"<p>The firewall by default is configured to use port 22 for ssh. If you change the port using <code>sudo ssh_port</code> then you must run the firewall configuration script to update the port:</p> <pre><code>sudo /usr/local/sbin/configure_ufw_from_csv.sh\n</code></pre> Command Output<pre><code>[INFO] Using CSV file: /home/haas/Haas_Data_collect/users.csv\n[INFO] Using backup directory: /home/haas/Haas_Data_collect/backups\n2026-02-19 14:36:12 [INFO] Starting UFW configuration from CSV.\n2026-02-19 14:36:12 [INFO] Using CSV file: /home/haas/Haas_Data_collect/users.csv\n2026-02-19 14:36:12 [INFO] Validating CSV...\n[*] Validating CSV: /home/haas/Haas_Data_collect/users.csv\n[*] CSV validation PASSED successfully.\n2026-02-19 14:36:12 [INFO] CSV validation passed.\n2026-02-19 14:36:12 [INFO] CSV backup created at: /home/haas/Haas_Data_collect/backups/users_2026-02-19_14-36-12.csv\n2026-02-19 14:36:12 [INFO] Applying Haas subnet rule: ALLOW 445/tcp FROM 10.10.10.0/24\nSkipping adding existing rule\n2026-02-19 14:36:12 [INFO] ADMIN: haas@192.168.10.143 \u2192 3333, 445, 9090\nSkipping adding existing rule\nSkipping adding existing rule\nSkipping adding existing rule\n2026-02-19 14:36:12 [INFO] USER: toolroom@192.168.10.104 \u2192 445\nSkipping adding existing rule\n2026-02-19 14:36:12 [INFO] ADMIN: msp_admin@192.168.10.113 \u2192 3333, 445, 9090\nSkipping adding existing rule\nSkipping adding existing rule\nSkipping adding existing rule\n2026-02-19 14:36:13 [INFO] USER: thubbard@192.168.10.100 \u2192 445\nSkipping adding existing rule\n2026-02-19 14:36:13 [INFO] Firewall rule application complete.\n</code></pre> <p>Note</p> <pre><code>I have run this while connected to the appliance over ssh/port 22 and didn't get disconnected. But, it is possible that you will lose connectivity. If that happens reconnect using `ss -p 3333 haas@&lt;ip_address&gt;\n</code></pre>"},{"location":"appendices/appendix-a/#ssh-access-lost-after-hardening-changes","title":"SSH Access Lost After Hardening Changes","text":"<p>After applying SSH hardening settings, administrators may be unable to reconnect to the appliance. This is typically caused by firewall rules, authentication changes, or service configuration order rather than a system failure.</p> <p>This section provides a structured troubleshooting process to safely restore access.</p>"},{"location":"appendices/appendix-a/#common-causes","title":"Common Causes","text":"<p>Loss of SSH access most commonly occurs when:</p> <ul> <li>The SSH listening port was changed but the firewall was not updated</li> <li>Password authentication was disabled before SSH keys were verified</li> <li>Root login was disabled without confirming a sudo-capable user</li> <li>SSH service configuration was modified but not restarted</li> <li>Incorrect permissions exist on SSH key files</li> </ul>"},{"location":"appendices/appendix-a/#troubleshooting-procedure","title":"Troubleshooting Procedure","text":"<p>Perform the following checks from the appliance console or hypervisor access if using a Virtual Appliance.</p>"},{"location":"appendices/appendix-a/#1-verify-ssh-service-status","title":"1. Verify SSH Service Status","text":"<pre><code>sudo systemctl status ssh\n</code></pre> <p>Expected Result: <code>Active: active (running) since Thu 2026-02-19 14:31:38 PST; 17min ago</code></p> <p>If not running:</p> <pre><code>sudo systemctl restart ssh\n</code></pre>"},{"location":"appendices/appendix-a/#2-confirm-listening-port","title":"2. Confirm Listening Port","text":"<p>Verify which port SSH is actually listening on:</p> <p>```bash lhl_lines='1' sudo ss -tulpn | grep ssh <pre><code>```bash title='Command Output'\ntcp   LISTEN 0      4096                             0.0.0.0:3333       0.0.0.0:*    users:((\"sshd\",pid=47452,fd=3),(\"systemd\",pid=1,fd=197))\ntcp   LISTEN 0      4096                                [::]:3333          [::]:*    users:((\"sshd\",pid=47452,fd=4),(\"systemd\",pid=1,fd=198))\n</code></pre></p> <p>If the expected port is not shown, review:</p> <ul> <li>/etc/ssh/sshd_config</li> <li>/etc/ssh/sshd_config.d/99-haas-hardening.conf</li> </ul> <p>Using</p> <pre><code>sudo nano /etc/ssh/sshd_config\nsudo nano /etc/ssh/sshd_config.d/99-haas-hardening.conf\n</code></pre> <p>Then test configuration validity:</p> <pre><code>sudo sshd -T | grep -E 'permitrootlogin|passwordauthentication|pubkeyauthentication|challengeresponseauthentication|permitemptypasswords|^banner|x11f|port\\ '\n</code></pre> Command Output<pre><code>port 3333\npermitrootlogin no\npubkeyauthentication yes\npasswordauthentication yes\nx11forwarding no\npermitemptypasswords no\nbanner /etc/issue.net\n</code></pre>"},{"location":"appendices/appendix-a/#3-check-firewall-rules","title":"3. Check Firewall Rules","text":"<p>A firewall blocking the new SSH port will result in connection timeouts.</p> <p>Check firewall status:</p> <pre><code> sudo ufw status numbered | sort -k5\n</code></pre> Command Output<pre><code>     --                         ------      ----\n     To                         Action      From\nStatus: active\n[11] 3333                       ALLOW IN    192.168.10.113             # msp_admin-admin-ssh\n[10] 3333                       ALLOW IN    192.168.10.143             # haas-admin-ssh\n[ 1] 445                        ALLOW IN    10.10.10.0/24              # haas-smb\n[ 9] 445                        ALLOW IN    192.168.10.100             # thubbard-user-smb\n[ 5] 445                        ALLOW IN    192.168.10.104             # toolroom-user-smb\n[ 8] 9090                       ALLOW IN    192.168.10.113             # msp_admin-admin-cockpit\n[ 7] 445                        ALLOW IN    192.168.10.113             # msp_admin-admin-smb\n[ 6] 22                         ALLOW IN    192.168.10.113             # msp_admin-admin-ssh\n[ 4] 9090                       ALLOW IN    192.168.10.143             # haas-admin-cockpit\n[ 3] 445                        ALLOW IN    192.168.10.143             # haas-admin-smb\n[ 2] 22                         ALLOW IN    192.168.10.143             # haas-admin-ssh\n</code></pre>"},{"location":"appendices/appendix-a/#4-validate-authentication-method","title":"4. Validate Authentication Method","text":"<p>If password authentication was disabled, confirm SSH key access:</p> <pre><code>ls -ld ~/.ssh\nls -l ~/.ssh/authorized_keys\n</code></pre> Command Output<pre><code>drwx------ 2 haas haas 4096 Feb 19 14:19 /home/haas/.ssh\n-rw------- 1 haas haas 86 Feb 19 14:45 /home/haas/.ssh/authorized_keys\n</code></pre> <p>The <code>drwx------</code> on /home/haas/.ssh means the permission is read/write/execute (700) for owner. No permission for the group or other users. The <code>-rw-------</code> on /home/haas/.ssh/authorized_keys means rw for owner, No permission for the group or other users.</p> <p>Fix if necessary:</p> <pre><code>chmod 700 ~/.ssh\nchmod 600 ~/.ssh/authorized_keys\n</code></pre> <p>The ~/.ssh directory must be restricted to the account owner (700). OpenSSH will reject key-based authentication if directory permissions allow write access by group or other users.</p>"},{"location":"appendices/appendix-a/#5-test-from-a-remote-system","title":"5. Test from a Remote System","text":"<p>Use verbose SSH output to identify failures:</p> <pre><code>ssh -vvv -p [custom port] haas@[appliance-ip]\n</code></pre> <p>This will indicate whether the failure is due to:</p> <ul> <li>Network filtering</li> <li>Authentication rejection</li> <li>Key negotiation issues</li> </ul>"},{"location":"appendices/appendix-a/#nmap-diagnostic-reference","title":"Nmap Diagnostic Reference","text":"<p>From another host:</p> <pre><code>nmap -p [custom port] appliance-ip\n</code></pre> Command Output<pre><code>Starting Nmap 7.95 ( https://nmap.org ) at 2026-02-19 15:08 PST\nNmap scan report for haas.pu.pri (192.168.10.136)\nHost is up (0.0068s latency).\n\nPORT     STATE SERVICE VERSION\n3333/tcp open  ssh     OpenSSH 9.6p1 Ubuntu 3ubuntu13.13 (Ubuntu Linux; protocol 2.0)\nMAC Address: 88:A2:9E:43:4D:DE (Unknown)\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 0.34 seconds\n</code></pre>"},{"location":"appendices/appendix-a/#recovery-recommendation","title":"Recovery Recommendation","text":"<p>When changing SSH ports or authentication settings, always apply changes in this order:</p> <ol> <li>Log into a second session before starting the change</li> <li>Update the ssh configuration files (run <code>./ssh_port.sh</code>)</li> <li>update the firewall rules (<code>sudo /usr/local/sbin/configure_ufw_from_csv.sh</code> )</li> <li>Verify new access from a another session</li> </ol> <p>This staged approach prevents administrative lockout.</p>"},{"location":"appendices/appendix-a/#design-note","title":"Design Note","text":"<p>The Haas Data Collection Appliance applies SSH hardening using configuration drop-in files located in:</p> <p><code>/etc/ssh/sshd_config.d/99-haas-hardening.conf</code></p> <p>This provides protection during Operating System upgrades because the updater will now try to overwrite the files in cat /etc/ssh/sshd_config.d/`</p>"},{"location":"appendices/appendix-a/#securing-samba","title":"Securing Samba","text":"<p>The appliance has Microsoft <code>SMBv1</code> removed and supports <code>SMBv2/SMBv3</code>, the Haas CNC controls support <code>SMBv2</code> and the Windows desktops that will access the shares should support <code>SMBv2</code> since it has been built into Windows since Vista in 2006!</p> <p>Note</p> <pre><code>SMB 2.0: Released in 2006 with Windows Vista. It was a major\nredesign to reduce protocol \u201cchattiness\u201d and improve performance over high-latency links.\n</code></pre> <p>We will also disable the Printer shares on the appliance since printing isn't needed. And we will disable the ANCIENT NetBios protocol known as <code>WINS</code> in the networking dialog on Windows. According to Microsoft CoPilot:</p> <p>NetBIOS (Network Basic Input/Output System) was originally developed by IBM in 1983 for early PC networking. Microsoft adopted it in the mid-1980s, integrating it into MS-NET and later LAN Manager, and it became a foundational part of Windows networking in the Windows for Workgroups and Windows NT era.</p> <p>\ud83e\uddef Is NetBIOS Still Supported in Windows? Yes, but it's being deprecated. NetBIOS name resolution (via WINS, the Windows Internet Name Service) is still technically supported in Windows Server 2025, but Microsoft has announced that:</p> <p>WINS will be removed in future Windows Server releases after 2025.</p> <p>Support for WINS (and by extension, NetBIOS name resolution) will continue only through the Windows Server 2025 lifecycle, which ends in November 2034.</p> <p>\ud83d\udd12 Why It\u2019s Being Phased Out Security risks: NetBIOS and WINS are considered legacy protocols with known vulnerabilities.</p>"},{"location":"appendices/appendix-a/#the-smbconf-file","title":"The smb.conf file","text":"<p>The following settings are added the Samba Server configuration file by the installation script:</p> <p>[global]</p> <pre><code>    # Protocol Security - Force SMB2/SMB3 only\n    client min protocol = SMB2\n    client max protocol = SMB3\n    server min protocol = SMB2\n    server max protocol = SMB3\n\n    # Disable legacy protocols and services\n    disable netbios = Yes\n    disable spoolss = Yes\n\n    # Disable printing\n    load printers = No\n    printing = bsd\n    printcap name = /dev/null\n\n    [printers]\n    available = No\n    browseable = No\n    printable = Yes\n</code></pre> <p><code>[print$]</code></p> <pre><code>[print$]\n    available = No\n</code></pre> <p>Run the following command to make sure the smb.conf file doesn't have any errors:</p> <pre><code>testparm -s\n</code></pre> <p>If there are any errors reopen the smb.conf file and correct them.</p>"},{"location":"appendices/appendix-a/#restart-samba-service","title":"Restart Samba service","text":"<p>Run the following to restart Samba and check the status:</p> <pre><code>sudo systemctl restart smbd\nsudo systemctl status smbd\n</code></pre> <p>Note</p> <pre><code>`SMBv1` was permanently removed from Samba Server version 4.1 and above. Disabling `NetBios`, the `spoolss` service and the `printer$` share harden the appliance beyond just disabling `SMBv1`\n</code></pre>"},{"location":"appendices/appendix-a/#the-ufw-firewall","title":"The UFW firewall","text":"<p>The Linux UFW firewall is used to prevent attacks against the appliance. During the initial setup the installation script enable the UFW firewall and configures it based on the file <code>users.csv</code>. This file contains:</p> <ul> <li>username</li> <li>ip address</li> <li>role</li> </ul> <p>for all users that need access.</p> <p>Based on this <code>users.csv</code> file:</p> <pre><code>cat users.csv\nusername,ip_address,role\nhaas,192.168.10.143,Administrator\nmsp_admin,192.168.10.113,Administrator\nthubbard,192.168.10.100,user\ntoolroom,192.168.10.104,user\n</code></pre> <p>The installation script will create the following rules:</p> <pre><code>sudo ufw status numbered | sort -k5\n</code></pre> Command Output<pre><code>     --                         ------      ----\n     To                         Action      From\nStatus: active\n[ 1] 445                        ALLOW IN    10.10.10.0/24              # haas-smb\n[ 9] 445                        ALLOW IN    192.168.10.100             # thubbard-user-smb\n[ 5] 445                        ALLOW IN    192.168.10.104             # toolroom-user-smb\n[ 8] 9090                       ALLOW IN    192.168.10.113             # msp_admin-admin-cockpit\n[ 7] 445                        ALLOW IN    192.168.10.113             # msp_admin-admin-smb\n[ 6] 22                         ALLOW IN    192.168.10.113             # msp_admin-admin-ssh\n[ 4] 9090                       ALLOW IN    192.168.10.143             # haas-admin-cockpit\n[ 3] 445                        ALLOW IN    192.168.10.143             # haas-admin-smb\n[ 2] 22                         ALLOW IN    192.168.10.143             # haas-admin-ssh\n</code></pre>"},{"location":"appendices/appendix-a/#the-haas-machines","title":"The Haas machines","text":"<p>In this example, the Haas machines are on a dedicated vlan of <code>10.10.10.0/24</code> as seen in the first line of the output. They only get access to the SMB share so that they can upload/download CNC programs to the appliance.</p>"},{"location":"appendices/appendix-a/#the-user-role","title":"The user role","text":"<ul> <li>thubbard - CNC Programmer</li> <li>toolroom - A toolroom mill that isn't on the dedicated vlan</li> </ul> <p>Received only access to the SMB shares.</p>"},{"location":"appendices/appendix-a/#the-administrator-role","title":"The Administrator Role","text":"<ul> <li>haas - the administrator account for the appliance</li> <li>msp_admin - a user delegated to the MSP manage the appliance</li> </ul> <p>Receive ssh, smb and cockpit access through the firewall.</p> <p>All other IP addresses will only be able to ping the appliance.</p>"},{"location":"appendices/appendix-b/","title":"Appendix B - Linux file permissions","text":"<p>This appendix is optional reading!</p> <p>I included it in case you are coming from Windows and want to understand what the output of commands like <code>ls -la</code> mean. This was created 100% by Google Gemini. But I did read every line to make sure there were no hallucinations </p> <p>When I was at Cal Poly, the head of the department started a lecture with this:</p> <ul> <li>I'm going to tell you what I'm lecturing on today.</li> <li>Then I'm going to lecture to you.</li> <li>Then I'm going to summarize what I told you.</li> </ul> <p>I was annoyed at first, but it was effective! This is done in a similar format, so if it seems repetitive, it is.</p> <p>Samba authenticates Windows users, but Linux decides what they can access.</p> <p>When a Windows user logs in, Samba maps them to a Linux user account that belongs to the <code>HaasGroup</code>. All folders under <code>Haas_Data_collect</code> are owned by <code>haas</code> and assigned to <code>HaasGroup</code>, so every user in that group gets the same read/write access. This keeps permissions simple and predictable without using Windows-style ACLs or effective permissions.</p>"},{"location":"appendices/appendix-b/#the-key-idea","title":"\ud83c\udfaf The key idea","text":"<p>Linux permissions are simple and strict compared to Windows. Every file and folder has exactly one owner and one group, and Linux checks permissions in a fixed order.</p> <p>Windows users are used to:</p> <ul> <li>Stacking multiple permissions from many groups</li> <li>Inheritance</li> <li>Deny rules</li> <li>\u201cEffective Permissions\u201d that calculate the final result</li> </ul> <p>Linux does none of that.</p>"},{"location":"appendices/appendix-b/#the-linux-permission-model","title":"\ud83e\uddf1 The Linux Permission Model","text":"<p>Every file or folder has:</p> Concept Meaning Windows Analogy User (Owner) The person who owns the file Like the file\u2019s \u201cprimary owner\u201d Group A team of users who share access Like a Windows security group Other Everyone else on the system Like \u201cEveryone\u201d in Windows <p>And each of those three categories gets exactly three possible permissions:</p> <ul> <li>r \u2192 read</li> <li>w \u2192 write</li> <li>x \u2192 execute (or \u201center\u201d a folder)</li> </ul> <p>That\u2019s it. No inheritance. No merging. No deny rules.</p> <p>\ud83d\udd0d How Linux Decides Access (the part Windows users must understand).</p> <p>Linux checks permissions in this exact order:</p> <ol> <li> <p>Is the user the owner?     \u2192 If yes, Linux uses the owner permissions and stops.</p> </li> <li> <p>If not, is the user in the file\u2019s group?     \u2192 If yes, Linux uses the group permissions and stops.</p> </li> <li> <p>Otherwise, use the \u201cother\u201d permissions.</p> </li> </ol> <p>There is no combining of permissions like Windows does.</p>"},{"location":"appendices/appendix-b/#example","title":"Example","text":"<p>If a file has:</p> <ul> <li>Owner: read/write</li> <li>Group: read only</li> <li>Other: no access</li> </ul> <p>And a user is in the group but not the owner:</p> <ul> <li>They get read only, even if they belong to multiple groups.</li> <li>They cannot \u201cinherit\u201d write access from anywhere else.</li> </ul> <p>This is the biggest conceptual shift for Windows users.</p>"},{"location":"appendices/appendix-b/#why-groups-matter-on-a-raspberry-pi-appliance","title":"\ud83e\uddd1\u200d\ud83e\udd1d\u200d\ud83e\uddd1 Why Groups Matter on a Raspberry Pi Appliance","text":"<p>If multiple users need access to the same shared folder (e.g., for Samba shares), Linux expects you to:</p> <ol> <li>Create a group (in our case, <code>HaasGroup</code>)</li> <li>Add users to that group</li> <li>Set the folder\u2019s group to HaasGroup</li> <li>Give the group the needed permissions</li> </ol>"},{"location":"appendices/appendix-b/#a-simple-analogy","title":"\ud83e\udde0 A Simple Analogy","text":"<p>Linux doesn\u2019t calculate permissions from multiple sources like Windows. Instead, every file chooses one set of permissions to apply \u2014 either the owner\u2019s, the group\u2019s, or the other's \u2014 depending on who you are.</p> <p>This analogy lands well with Windows admins</p> <pre><code>|\n\u251c\u2500\u2500 Haas_Data_collect/\n\u2502   \u2514\u2500\u2500 cnc_logs/\n\u2502\n\u251c\u2500\u2500 minimill/\n\u251c\u2500\u2500 st30/\n\u251c\u2500\u2500 st30l/\n\u251c\u2500\u2500 st40/\n\u251c\u2500\u2500 vf2ss/\n\u2514\u2500\u2500 vf5ss/\n</code></pre> <pre><code>                         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                         \u2502  Haas_Data_collect           \u2502\n                         \u2502  Owner: haas                 \u2502\n                         \u2502  Group: HaasGroup            \u2502\n                         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                        \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502                               \u2502                                \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502    minimill/     \u2502       \u2502      st30/           \u2502        \u2502      st30l/      \u2502\n\u2502 Owner: haas      \u2502       \u2502 Owner: haas          \u2502        \u2502 Owner: haas      \u2502\n\u2502 Group: HaasGroup \u2502       \u2502 Group: HaasGroup     \u2502        \u2502 Group: HaasGroup \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Additional sibling directories follow the same pattern:</p> <p><code>st40/, vf2ss/, vf5ss/</code></p> <p>This diagram makes the permission model visually obvious:</p> <ul> <li>One owner (<code>haas</code>)</li> <li>One shared group (<code>HaasGroup</code>)</li> <li>All users in <code>HaasGroup</code> get the same access</li> <li>No Windows\u2011style \u201ceffective permissions\u201d \u2014 just owner \u2192 group \u2192 everyone else</li> </ul> <p>All directories under <code>Haas_Data_collect</code> are owned by the user <code>haas</code> and assigned to the group <code>HaasGroup</code>, which contains all appliance users. This ensures consistent shared access without the complexity of Windows\u2011style effective permissions.</p>"},{"location":"appendices/appendix-b/#how-windows-users-access-the-pi","title":"How Windows users access the Pi","text":"<p>In this appliance, multiple Windows users will access shared folders on the Raspberry Pi.</p> <p>To keep things simple and predictable, we use:</p> <ol> <li>One owner for all files: <code>haas</code></li> <li>One shared group for all users: <code>HaasGroup</code></li> <li>A consistent permission model across all folders under <code>Haas_Data_collect</code></li> </ol> <p>You don\u2019t need to become a Linux admin to understand this \u2014 just a few key ideas.</p>"},{"location":"appendices/appendix-b/#1-how-linux-permissions-work-in-plain-windows-terms","title":"1. How Linux permissions work (in plain Windows terms)","text":"<p>On Linux, every file or folder has:</p> <ul> <li>One user (owner) \u2192 who \u201cowns\u201d it</li> <li>One group \u2192 a team that can also have access</li> <li>Other \u2192 everyone else on the system</li> </ul> <p>Linux decides access in this strict order:</p> <ol> <li>If you are the owner, Linux uses the owner permissions.</li> <li>Else, if you are in the group, Linux uses the group permissions.</li> <li>Else, Linux uses the other permissions.</li> </ol> <p>It picks exactly one of those; it does not merge them like Windows \u201cEffective Permissions.\u201d</p> <p>You can think of it like:</p> <p>\u201cOwner first, if not owner then group, if not group then everyone else.\u201d</p>"},{"location":"appendices/appendix-b/#2-who-owns-what-user-and-group","title":"2. Who owns what (user and group)","text":"<p>To make permissions easy to reason about, everything under `Haas_Data_collect1 is set up like this:</p> <ul> <li>Owner (user): haas</li> <li>Group: HaasGroup</li> <li>Members of HaasGroup: all users who should have access to these folders</li> </ul> <p>Conceptually, it looks like this:</p> <pre><code>                         Haas_Data_collect/\n                Owner: haas\n                Group: HaasGroup\n                         \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502                \u2502                             \u2502\n    minimill/          st30/                         st30l/\nOwner: haas          Owner: haas                    Owner: haas\nGroup: HaasGroup     Group: HaasGroup               Group: HaasGroup\n        \u2502\n        \u2514\u2500\u2500 cnc_logs/\n            Owner: haas\n            Group: HaasGroup\n</code></pre> <p>Additional sibling directories follow the same pattern:</p> <p><code>st40/, vf2ss/, vf5ss/</code></p> <p>So for every important directory:</p> <ul> <li>The  owner is always <code>haas</code>.</li> <li>The group is always <code>HaasGroup</code>.</li> <li>All real users connect as members of 'HaasGroup'.</li> </ul>"},{"location":"appendices/appendix-b/#3-what-permissions-users-actually-get","title":"3. What permissions users actually get","text":"<p>Let\u2019s say the folders under 'Haas' are configured so that:</p> <ul> <li>The owner (haas) has full access.</li> <li>The group (HaasGroup) has full access.</li> <li>Others (everyone not in HaasGroup) have read only</li> </ul> <p>In Linux shorthand, that would typically be something like:</p> <ul> <li>rwx for owner</li> <li>rwx for group</li> <li>r-- for others</li> </ul> <p>You don\u2019t need to remember the letters \u2014 what matters is the idea:</p> <p>\u201cOwner and HaasGroup can do everything here; everyone else is read only.\u201d</p> <p>So:</p> <ul> <li>if you\u2019re a member of HaasGroup \u2192 you get the group permissions.</li> <li>If you\u2019re not in HaasGroup \u2192 you get the other permissions (which are set to read only).</li> </ul>"},{"location":"appendices/appendix-b/#4-how-this-feels-to-a-windows-user","title":"4. How this feels to a Windows user","text":"<p>From a Windows perspective, you can think of it like this:</p> <ul> <li><code>haas</code> \u2248 a built\u2011in \u201cservice account\u201d that technically owns everything.</li> <li><code>HaasGroup</code> \u2248 a Windows security group that has Full Control on all the relevant folders.</li> <li>Other users on the system \u2248 like \u201cEveryone\u201d being read only.</li> </ul> <p>But unlike Windows:</p> <ul> <li>There are no deny rules.</li> <li>There is no inheritance that stacks or merges permissions.</li> <li>There is no \u201ceffective permissions\u201d calculation.</li> </ul> <p>Instead:</p> <p>Each file chooses exactly one set of permissions to apply: the owner\u2019s, the group\u2019s, or everyone else\u2019s \u2014 whichever matches the user first.</p>"},{"location":"appendices/appendix-b/#5-how-this-ties-into-the-appliance-usage","title":"5. How this ties into the appliance usage","text":"<p>When a Windows user connects to the appliance via a network drive share:</p> <ul> <li>Their account is mapped to a Linux user that belongs to <code>HaasGroup</code>.</li> <li>That membership gives them the group permissions on everything under <code>Haas_Data_collect</code>.</li> <li>They don\u2019t need to know anything about Linux users or groups; they just see folders like <code>Haas_Data_collect</code>, <code>cnc_logs</code>, <code>vf2ss</code>, etc., and can read/write according to the rules set for <code>HaasGroup</code>.</li> </ul> <p>You, as the appliance creator, keep control simply by:</p> <ul> <li>Keeping <code>haas</code> as the owner.</li> <li>Ensuring all real users are in <code>HaasGroup</code>.</li> <li>Ensuring all critical directories under <code>Haas_Data_collect</code> are assigned to <code>HaasGroup</code>.</li> </ul>"},{"location":"appendices/appendix-b/#how-samba-fits-into-this","title":"\ud83e\udde9 How Samba Fits Into This","text":"<p>When Windows users connect to the Raspberry Pi 5 appliance, they are not directly using Linux accounts. Instead, Samba acts as the \u201ctranslator\u201d between Windows authentication and Linux permissions.</p> <p>Here\u2019s what actually happens behind the scenes.</p>"},{"location":"appendices/appendix-b/#1-a-windows-user-connects-to-the-network-share","title":"1. A Windows user connects to the network share","text":"<p>When someone on Windows enters the following into the <code>map network drive</code> dialog:</p> <pre><code>\\\\your-appliance-ip\\Haas\n</code></pre> <p>Windows prompts them for a username and password. They enter the credentials you created for them (for example, <code>rgoodwin</code>).</p>"},{"location":"appendices/appendix-b/#2-samba-checks-the-username-and-password","title":"2. Samba checks the username and password","text":"<p>Samba keeps its own password database, separate from Linux. To create the Samba user run the following command:</p> <p><code>sudo smbpasswd -a rgoodwin</code></p> <p>This will:</p> <ul> <li>Prompt you to enter and confirm a password for the Samba user <code>rgoodwin</code>.</li> <li>Add <code>rgoodwin</code> to the Samba user database (if not already present).</li> <li>Allow <code>rgoodwin</code> to authenticate when accessing Samba shares.</li> </ul> <p>\u26a0\ufe0f Important: The user must already exist as a Linux system user (e.g., created via <code>sudo adduser rgoodwin</code>) before you can add them to Samba.</p> <p>If the Samba password matches, the user is allowed in.</p>"},{"location":"appendices/appendix-b/#3-samba-maps-the-windows-user-linux-user","title":"3. Samba maps the Windows user \u2192 Linux user","text":"<p>Once authenticated, Samba says:</p> <p>This Windows user is the Linux user <code>rgoodwin</code></p> <p>From this point on, Linux file permissions apply, not Windows ACLs. This is the key idea for your readers:</p> <p>Samba only handles the login.   Linux decides what the user can do once they\u2019re in.</p>"},{"location":"appendices/appendix-b/#4-linux-checks-which-groups-the-user-belongs-to","title":"4. Linux checks which groups the user belongs to","text":"<p>You added each user to the shared group: <code>sudo usermod -aG HaasGroup rgoodwin</code></p> <p>So when Samba maps the Windows user to the Linux user, Linux sees:</p> <ul> <li>User: <code>rgoodwin</code></li> <li>Groups: <code>rgoodwin</code>, HaasGroup</li> </ul> <p>Because all your shared folders belong to <code>HaasGroup</code>, the user gets the group permissions.</p>"},{"location":"appendices/appendix-b/#5-the-user-gets-access-based-on-the-folders-ownergroup","title":"5. The user gets access based on the folder\u2019s owner/group","text":"<p>Every directory under <code>Haas_Data_collect</code> is set up like this:</p> <ul> <li>Owner: <code>haas</code></li> <li>Group: <code>HaasGroup</code></li> <li>Permissions: owner = full, group = full, others = read only</li> </ul> <p>So when a Windows user connects:</p> <ul> <li>They are not the owner (haas)</li> <li>But they are in the group (HaasGroup)</li> <li>So they get the group permissions</li> </ul> <p>This is why the setup works cleanly for all users.</p>"},{"location":"appendices/appendix-b/#6-what-this-means-for-your-appliance-users","title":"6. What this means for your appliance users","text":"<p>From their perspective:</p> <ul> <li>They log in with a username and password</li> <li>They see the shared folders</li> <li>They can read/write files normally</li> <li>They never need to understand Linux permissions</li> </ul> <p>From the appliance administrator's  perspective:</p> <ul> <li>You control access simply by adding/removing users from HaasGroup</li> <li>Samba handles authentication</li> <li>Linux handles authorization (permissions)</li> </ul>"},{"location":"appendices/appendix-c/","title":"Appendix C \u2014 Threat Model","text":"<p>This threat model describes the security assumptions, expected adversaries, and defensive posture of the Haas Data Collection Appliance. It is intended to support penetration testing, vendor risk assessments, and internal security reviews.</p>"},{"location":"appendices/appendix-c/#1-security-objectives","title":"1. Security Objectives","text":"<p>The appliance is designed to:</p> <ul> <li>Safely collect CNC machine data via Telnet and share via SMBv2</li> <li>Provide local administrative access via SSH and Cockpit</li> <li>Remain stable, predictable, and low\u2011maintenance in industrial environments</li> <li>Minimize attack surface and eliminate unnecessary functionality</li> <li>Prevent unauthorized access, tampering, or lateral movement</li> </ul> <p>The appliance is not intended to provide cloud connectivity, remote management, or multi\u2011tenant operation.</p>"},{"location":"appendices/appendix-c/#2-inscope-threat-actors","title":"2. In\u2011Scope Threat Actors","text":"<p>The following adversaries are considered within scope:</p>"},{"location":"appendices/appendix-c/#21-external-network-attackers","title":"2.1. External Network Attackers","text":"<p>Attackers on the same LAN attempting:</p> <ul> <li>Port scanning</li> <li>Brute\u2011force authentication</li> <li>Exploitation of exposed services</li> <li>Lateral movement from compromised shop PCs</li> </ul> <p>Mitigations: UFW default\u2011deny, IP\u2011restricted access, SMBv2\u2011only, Cockpit restricted to authorized hosts. The appliance support using SSH keys instead of username/password for ssh access.</p>"},{"location":"appendices/appendix-c/#22-malicious-or-compromised-internal-users","title":"2.2. Malicious or Compromised Internal Users","text":"<p>Users with physical or logical access to the shop network attempting:</p> <ul> <li>Unauthorized login</li> <li>Privilege escalation</li> <li>Tampering with configuration or logs</li> <li>Accessing machine data they should not see</li> </ul> <p>Mitigations: Local authentication required, no guest access, root login disabled, file permissions locked down, Cockpit limited to authorized IPs.</p>"},{"location":"appendices/appendix-c/#23-malware-on-nearby-windows-systems","title":"2.3. Malware on Nearby Windows Systems","text":"<p>Common in machine shops where unmanaged PCs coexist with CNC equipment.</p> <p>Potential threats:</p> <ul> <li>SMB worms</li> <li>Credential harvesting</li> <li>Lateral movement attempts</li> </ul> <p>Mitigations: SMBv2\u2011only, no SMB1, no guest access, strict UFW rules, no Windows\u2011compatible remote execution surfaces.</p>"},{"location":"appendices/appendix-c/#24-opportunistic-attackers-on-the-internet","title":"2.4. Opportunistic Attackers on the Internet","text":"<p>These are out of scope because the appliance is not Internet\u2011exposed. If misconfigured by an MSP, the threat becomes relevant.</p> <p>Mitigations: Documented requirement: appliance must remain on an internal, non\u2011routable network.</p>"},{"location":"appendices/appendix-c/#3-outofscope-threat-actors","title":"3. Out\u2011of\u2011Scope Threat Actors","text":"<p>These threats are explicitly out of scope for the appliance\u2019s design:</p> <ul> <li>Nation\u2011state adversaries</li> <li>Advanced persistent threats (APT)</li> <li>Hardware supply\u2011chain attacks</li> <li>Physical attacks requiring disassembly or chip\u2011level access</li> <li>Compromise of the CNC machines themselves</li> <li>Attacks requiring cloud connectivity (none exists)</li> </ul> <p>The appliance is not intended to withstand high\u2011budget, targeted attacks.</p>"},{"location":"appendices/appendix-c/#4-attack-surface-summary","title":"4. Attack Surface Summary","text":"<p>The appliance exposes only three network services, all restricted by IP:</p> Service Purpose Hardening SSH (22/tcp) Admin access Key\u2011only auth, root disabled, modern crypto only SMB (445/tcp) CNC data collection SMBv2+, no guest, minimal share Cockpit (9090/tcp) Local management UI HTTPS, IP\u2011restricted, minimal modules <p>No other ports or services are exposed.</p>"},{"location":"appendices/appendix-c/#5-key-security-assumptions","title":"5. Key Security Assumptions","text":"<p>The threat model assumes:</p> <ul> <li>The appliance is deployed on a trusted internal network</li> <li>Physical access is restricted to authorized personnel</li> <li>CNC machines are trusted to provide accurate data and are not adversarial</li> <li>MSPs follow the documented network requirements (no WAN exposure)</li> <li>Administrators maintain SSH keys securely</li> <li>The shop network is not intentionally hostile</li> </ul> <p>If any of these assumptions are violated, the risk profile changes.</p>"},{"location":"appendices/appendix-c/#6-identified-risks-mitigations","title":"6. Identified Risks &amp; Mitigations","text":""},{"location":"appendices/appendix-c/#61-unauthorized-network-access","title":"6.1. Unauthorized Network Access","text":"<p>Risk: Attackers attempt to reach SSH, SMB, or Cockpit. Mitigation: UFW default\u2011deny, IP allowlists, no guest access, key\u2011only SSH.</p>"},{"location":"appendices/appendix-c/#62-credential-compromise","title":"6.2. Credential Compromise","text":"<p>Risk: Stolen passwords or weak credentials. Mitigation: No password logins for SSH, local accounts only, Cockpit behind firewall.</p>"},{"location":"appendices/appendix-c/#63-exploitation-of-legacy-protocols","title":"6.3. Exploitation of Legacy Protocols","text":"<p>Risk: SMB1, DSA, CBC ciphers, or other deprecated crypto. Mitigation: SMBv2+, OpenSSH 9.9 modern\u2011only crypto, legacy algorithms removed.</p>"},{"location":"appendices/appendix-c/#64-lateral-movement","title":"6.4. Lateral Movement","text":"<p>Risk: Malware on a Windows PC attempts to pivot into the appliance. Mitigation: Strict firewalling, minimal services, no remote execution surfaces.</p>"},{"location":"appendices/appendix-c/#65-misconfiguration-by-msps","title":"6.5. Misconfiguration by MSPs","text":"<p>Risk: Appliance accidentally exposed to WAN or guest Wi\u2011Fi. Mitigation: Documentation explicitly states internal\u2011only deployment; Cockpit and SSH reject unauthorized IPs.</p>"},{"location":"appendices/appendix-c/#7-residual-risk","title":"7. Residual Risk","text":"<p>Residual risk is low for the intended environment, assuming:</p> <ul> <li>The appliance remains on an internal network</li> <li>Administrators follow documented deployment practices</li> <li>Physical access is controlled</li> </ul> <p>Residual risk increases if:</p> <ul> <li>The appliance is Internet\u2011exposed</li> <li>SSH keys are mishandled</li> <li>The shop network is compromised by unmanaged devices</li> </ul> <p>These risks are documented for MSP awareness.</p>"},{"location":"appendices/appendix-c/#8-conclusion","title":"8. Conclusion","text":"<p>The appliance\u2019s threat model is intentionally simple: minimize attack surface, restrict access, use modern cryptography, and avoid unnecessary complexity.</p> <p>This design aligns with best practices for industrial environments and supports successful penetration testing outcomes.</p>"},{"location":"appendices/appendix-d/","title":"Other options for the service file","text":"<p>systemd has capabilities far beyond what is needed for this script. I used Gemini to research systemd for this project. Gemini has a lot of knowledge of <code>systemd</code> if you want to add more services to your appliance </p> <p>The <code>Type=</code> directive in a systemd service file's [Service] section defines how the service manager determines that a service has successfully started.</p> <p>Beyond simple, the available Type options include:</p> <ul> <li>exec: Similar to simple, but systemd considers the service started only after the main service binary has been successfully executed. This is often the preferred choice for long-running processes because it ensures errors like \"missing file\" are caught during startup.</li> <li>forking: Used for traditional UNIX daemons that \"fork\" into the background. Systemd considers the service started when the parent process exits. It is highly recommended to use PIDFile= with this type so systemd can track the correct child process.</li> <li>*oneshot: Ideal for scripts that perform a task and then exit. Unlike simple, systemd waits for the process to exit before starting follow-up units. It is often paired with RemainAfterExit=yes to keep the service marked as \"active\" after completion.</li> <li>notify: Similar to exec, but the application must explicitly send a \"READY=1\" signal to systemd (via sd_notify) once it is fully initialized. This is the most reliable way to handle services with long internal initialization periods.</li> <li>notify-reload: A more recent addition that behaves like notify but also implements a standardized protocol for reloading. It expects the service to send \"RELOADING=1\" when it starts a configuration reload.</li> <li>dbus: The service is considered started once it acquires a specific name on the D-Bus bus. You must specify the expected name using the BusName= directive.</li> <li>idle: Similar to simple, but execution is delayed until all other active jobs are finished. This is primarily used to prevent service output from cluttering the boot console.</li> </ul>"},{"location":"appendices/intro/","title":"Appendixes","text":"<p>This section provides technical deep dives and operational considerations that extend beyond basic installation of the Haas Data Collection Appliance.</p> <p>In production environments\u2014especially those managed by MSPs or security teams\u2014details matter. File permissions, service configuration, and system hardening directly impact stability, security posture, and long-term maintainability. These appendixes document those details clearly and explicitly.</p> <p>The material here is intended for administrators who want to understand not just how to deploy the appliance, but why it is configured the way it is.</p>"},{"location":"build_pi_5_appliance/Install_Samba/","title":"Install Samba for Windows integration","text":"<p>What is a Samba Server?</p> <p>A Samba server is an open-source software suite that enables seamless file and printer sharing between Linux/Unix systems and Windows systems. It implements the Server Message Block (SMB) and Common Internet File System (CIFS) protocols, which are standard for Windows-based file sharing. Samba also supports integration with Active Directory (AD) environments, making it a versatile tool for mixed-OS networks.</p> <ul> <li>Active Directory Integration: It can act as an Active Directory Domain Controller or a member server, supporting protocols like LDAP and Kerberos.</li> </ul> <p>For my project I chose not to use Active Directory integration because 99% of MSPs will freak out if you say you need a Linux server connected to Active Directory. We are only dealing with:</p> <ul> <li>One account for the machines</li> <li>A handful of accounts for the CNC Programmers</li> <li>A handful of accounts for Operations personnel that will use the spreadsheets created by the scripts</li> </ul> <p>Creating local accounts on the Raspberry Pi 5 is straight forward and we can script it if needed. If you want use Active Directory integration there are plenty of blogs/YouTube Videos available.</p>"},{"location":"build_pi_5_appliance/Install_Samba/#install-samba-server","title":"Install Samba Server","text":"<p>Open a terminal on the Raspberry Pi 5 and enter</p> <pre><code>sudo apt update &amp;&amp; sudo apt install -y samba\n</code></pre> <p>This will install the Samba Server packages. The <code>-y</code> means \"Don't prompt for yes\". If you want to be in control during the installation don't include the <code>-y</code>.</p> <p>Configure the Samba Server to start on boot and start the Samba Server</p> <pre><code>sudo systemctl enable --now smbd\nsudo systemctl start smbd\n</code></pre> <p>Anytime you need to restart the Samba Server, use the following:</p> <pre><code>sudo systemctl restart smbd\n</code></pre>"},{"location":"build_pi_5_appliance/Install_Samba/#verify-the-installation","title":"Verify the installation","text":"<p>Run the following to verify the Samba Server installation and location:</p> <pre><code>whereis samba\n</code></pre> Command Output<pre><code>samba: /usr/sbin/samba /usr/lib/x86_64-linux-gnu/samba /etc/samba /usr/libexec/samba /usr/share/samba /usr/share/man/man8/samba.8.gz /usr/share/man/man7/samba.7.gz\n</code></pre> <p>Run this to view the Samba Server version:</p> <pre><code>samba --version\n</code></pre> Command Output<pre><code>Version 4.19.5-Ubuntu\n</code></pre> <p>As you can see, on January 4th, 2025 the current version is 4.19.5.</p> <p>Run the this to see the smb.conf file and service status</p> <pre><code>testparm -s\n</code></pre> Command Output<pre><code>Load smb config files from /etc/samba/smb.conf\nLoaded services file OK.\nWeak crypto is allowed by GnuTLS (e.g. NTLM as a compatibility fallback)\n\nServer role: ROLE_STANDALONE\n</code></pre> <p>This is just the top of the file. The entire smb.conf file will be displayed</p> <p>Run the following to display the Samba Server service status:</p> <pre><code>sudo systemctl status smbd\n</code></pre> Command Output<pre><code>\u25cf smbd.service - Samba SMB Daemon\n     Loaded: loaded (/usr/lib/systemd/system/smbd.service; enabled; preset: enabled)\n     Active: active (running) since Fri 2025-12-26 21:59:34 PST; 1 week 1 day ago\n       Docs: man:smbd(8)\n             man:samba(7)\n             man:smb.conf(5)\n   Main PID: 10736 (smbd)\n     Status: \"smbd: ready to serve connections...\"\n      Tasks: 4 (limit: 4601)\n     Memory: 24.9M (peak: 48.2M swap: 1.4M swap peak: 1.4M)\n        CPU: 23.914s\n     CGroup: /system.slice/smbd.service\n             \u251c\u250010736 /usr/sbin/smbd --foreground --no-process-group\n             \u251c\u250010739 \"smbd: notifyd\" .\n             \u251c\u250010740 \"smbd: cleanupd \"\n             \u2514\u250075813 \"smbd: client [192.168.10.143]\"\n\nDec 27 19:07:06 ubuntu-server smbd[20940]: pam_unix(samba:session): session opened for user haas(uid=1000) by (uid=0)\n</code></pre>"},{"location":"build_pi_5_appliance/Install_Samba/#the-directory-structure","title":"The directory structure","text":"<p>We will need the table we created earlier for reference. The concept is to create a share on the <code>Haas_Data_collect</code> directory named <code>Haas</code>. This top level share will will be able so see the entire directory structure when it's mapped to a Windows network drive.</p> <p>Then create a directory/share for each Haas machine tool. The Haas machine tool share will be used for the CNC programmer to drop programs into and the machine operator to load from. This share is used when setting up the Ethernet on the CNC control.</p> <p>The Haas data collection scripts create the spreadsheets in the <code>cnc_logs</code> directory.</p> <p>The final structure will look like this:</p> <pre><code>\u251c\u2500\u2500 haas\n    \u251c\u2500\u2500 Haas_Data_collect\n       \u251c\u2500\u2500 cnc_logs\n       \u251c\u2500\u2500 minimill\n       \u251c\u2500\u2500 st30\n       \u251c\u2500\u2500 st30l\n       \u251c\u2500\u2500 st40\n       \u251c\u2500\u2500 vf2ss\n       \u2514\u2500\u2500 vf5ss\n</code></pre>"},{"location":"build_pi_5_appliance/Install_Samba/#create-the-shares","title":"Create the shares","text":"<p>First we need to create the directories. We can refer to our table for the names:</p> Machine Port# IP Address ST40 5052 192.168.10.141 VF2SS 5053 192.168.10.142 VF5SS 5054 192.168.10.143 MINIMILL 5055 192.168.10.143 ST30 5056 192.168.10.144 ST30L 5057 192.168.10.145 <p>If you are only doing a handful of machines use:</p> <pre><code>mkdir /home/haas/Haas_Data_collect/st40\n</code></pre> <p>And repeat for each machine. If you used the Python script under Scaling up with the <code>systemd-template.txt</code> it creates the 'mkdir' command along with the aliases.</p> <p>Open the <code>smb.conf</code> file</p> <pre><code>sudo nano /etc/samba/smb.conf\n</code></pre> <p>Go to the bottom of the file and paste this code in:</p> <pre><code># Share for Haas CNC Programs\n\n[Haas]\n    comment = Haas\n    path = /home/haas/Haas_Data_collect\n    read only = no\n    browsable = yes\n    writable = yes\n    browsable = yes\n    public = no\n    valid users = @HaasGroup, haas # Ensure the user is valid\n    force user = haas\n    force group = HaasGroup\n    create mask = 0664\n    force create mode = 0664\n    directory mask = 0775\n    force directory mode = 0775\n</code></pre> <p>This is the root directory. All other paths will be appended to the end of <code>/home/haas/Haas_Data_collect</code>. For example:</p> <pre><code>[ST40]\n    comment = st40\n    path = /home/haas/Haas_Data_collect/st40\n    read only = no\n    browsable = yes\n    writable = yes\n    browsable = yes\n    public = no\n    valid users = @HaasGroup, haas # Ensure the user is valid\n    force user = haas\n    force group = HaasGroup\n    create mask = 0664\n    force create mode = 0664\n    directory mask = 0775\n    force directory mode = 0775\n</code></pre> <p>If you used the Python script with the <code>systemd-template.txt</code>, it creates all of the smb.conf share commands. Open each file and copy the code after <code>Create the share configuration</code>.</p> <pre><code>sudo cp st1.service /etc/systemd/system/st1.service\nsudo systemctl daemon-reload\nsudo systemctl enable st1.service\nsudo systemctl start st1.service\nsudo systemctl status st1.service\n\n# Create the directory for the share\n\nmkdir /home/haas/Haas_Data_collect/st1\n\nCreate the share configuration\n\n[st1]\n    comment =\n    path = /home/haas/Haas_Data_collect/st1\n    read only = no\n    browsable = yes\n    writable = yes\n    browsable = yes\n    public = no\n    valid users = @HaasGroup, haas # Ensure the user is valid\n    force user = haas\n    force group = HaasGroup\n    create mask = 0664\n    force create mode = 0664\n    directory mask = 0775\n    force directory mode = 0775\n</code></pre> <p>The following options are needed so that files created from Windows, Mac, Linux with mapped drives get the correct permissions:</p> <ol> <li>force user = haas: Ensures that all operations on this share are performed as the user haas, making them the owner of all new files.</li> <li>force group = HaasGroup: Ensures that all new files and directories are assigned to the group HaasGroup.</li> <li>create mask = 0664 and force create mode = 0664: These lines work together to ensure that the resulting file permissions are exactly rw-rw-r-- (664 octal).</li> <li>directory mask = 0775 and force directory mode = 0775: These lines ensure that new directories are created with rwxrwxr-x permissions (775 octal), which includes the necessary execute bit for directory traversal.</li> </ol> <p>Ensure the underlying Linux directory permissions are correct: On the server's filesystem, make sure the shared directory (/home/haas/Haas_Data_collect) in this example) is owned by haas:HaasGroup.</p> <pre><code>sudo chown -R haas:HaasGroup /home/haas/Haas_Data_collect\nsudo chmod -R 2775 /home/haas/Haas_Data_collect\n</code></pre> <p>The 2 in 2775 sets the setgid bit, which ensures that all locally created files also inherit the HaasGroup. Run the following to verify:</p> <pre><code>cd ~\nls -l\n</code></pre> Command Output<pre><code>drwxrwxr-x 7 haas HaasGroup 4096 Feb 15 21:22 Haas_Data_collect\n</code></pre> <p>After you add all the share configurations, save <code>/etc/samba/smb.conf</code> and exit nano.</p> <p>Based on the table above this is what the share section will look like:</p> <pre><code># Share for Haas CNC Programs\n\n[Haas]\n    comment = Haas Directory Share\n    path = /home/haas/Haas\n    browseable = yes\n    writable = yes\n    guest ok = no\n    valid users = @HaasGroup, haas # Ensure the user is valid\n    force user = haas\n    force group = HaasGroup\n    create mask = 0664\n    force create mode = 0664\n    directory mask = 0775\n    force directory mode = 0775\n[ST40]\n    comment = ST40\n    path = /home/haas/Haas_Data_collect/st40\n    read only = no\n    browsable = yes\n    public = no\n    valid users = @HaasGroup, haas # Ensure the user is valid\n    force user = haas\n    force group = HaasGroup\n    create mask = 0664\n    force create mode = 0664\n    directory mask = 0775\n    force directory mode = 0775\n[minimill]\n    comment = minimill\n    path = /home/haas/Haas_Data_collect/minimill\n    read only = no\n    browsable = yes\n    public = no\n    valid users = @HaasGroup, haas # Ensure the user is valid\n    force user = haas\n    force group = HaasGroup\n    create mask = 0664\n    force create mode = 0664\n    directory mask = 0775\n    force directory mode = 0775\n[VF2SS]\n    comment = vf2ss\n    path = /home/haas/Haas_Data_collect/vf2ss\n    valid users = @HaasGroup\n    read only = no\n    public = no\n    valid users = @HaasGroup, haas # Ensure the user is valid\n    force user = haas\n    force group = HaasGroup\n    create mask = 0664\n    force create mode = 0664\n    directory mask = 0775\n    force directory mode = 0775\n  [VF5SS]\n    comment = vf5ss\n    path = /home/haas/Haas_Data_collect/vf5ss\n    read only = no\n    browsable = yes\n    public = no\n    valid users = @HaasGroup, haas # Ensure the user is valid\n    force user = haas\n    force group = HaasGroup\n    create mask = 0664\n    force create mode = 0664\n    directory mask = 0775\n    force directory mode = 0775\n[ST30]\n    comment = st30\n    path = /home/haas/Haas_Data_collect/st30\n    read only = no\n    browsable = yes\n    public = no\n    valid users = @HaasGroup, haas # Ensure the user is valid\n    force user = haas\n    force group = HaasGroup\n    create mask = 0664\n    force create mode = 0664\n    directory mask = 0775\n    force directory mode = 0775\n[ST30L]\n    comment = st30l\n    path = /home/haas/Haas_Data_collect/st30l\n    read only = no\n    browsable = yes\n    public = no\n    valid users = @HaasGroup, haas # Ensure the user is valid\n    force user = haas\n    force group = HaasGroup\n    create mask = 0664\n    force create mode = 0664\n    directory mask = 0775\n   force directory mode = 0775\n</code></pre>"},{"location":"build_pi_5_appliance/Install_Samba/#restart-the-samba-server","title":"Restart the Samba Server","text":"<p>Now that the /etc/samba/smb.conf file has been updated you need to test for errors. Use the following:</p> <pre><code>testparm -s\n</code></pre> <p>If there are no errors reported, restart the Samba Server service using:.</p> <pre><code>sudo systemctl restart smbd\n</code></pre> <p>There is no output from this command.</p>"},{"location":"build_pi_5_appliance/Install_Samba/#view-the-status-of-the-shares","title":"View the status of the shares","text":"<p>This command outputs a lot of information.</p> <pre><code>sudo smbstatus shares\n</code></pre> Command Output<pre><code>Samba version 4.19.5-Ubuntu\nPID     Username     Group        Machine                                   Protocol Version  Encryption           Signing\n----------------------------------------------------------------------------------------------------------------------------------------\n127044  haas     haas     192.168.10.143 (ipv4:192.168.10.143:51376) SMB3_11           -                    partial(AES-128-GMAC)\n117495  mchavez      mchavez      192.168.10.120 (ipv4:192.168.10.120:55586) SMB3_11           -                    partial(AES-128-GMAC)\n127455  rgoodwin     rgoodwin     192.168.10.104 (ipv4:192.168.10.104:52578) SMB3_11           -                    partial(AES-128-GMAC)\n127051  haas     haas     192.168.10.143 (ipv4:192.168.10.143:48096) SMB3_11           -                    partial(AES-128-GMAC)\n\nService      pid     Machine       Connected at                     Encryption   Signing\n---------------------------------------------------------------------------------------------\nminimill     127455  192.168.10.104 Fri Jan  9 07:41:53 PM 2026 PST  -            -\nHaas         127051  192.168.10.143 Fri Jan  9 06:27:16 PM 2026 PST  -            -\nST40         127044  192.168.10.143 Fri Jan  9 06:26:33 PM 2026 PST  -            -\nST30         117495  192.168.10.120 Thu Jan  8 11:45:23 AM 2026 PST  -            -\n\n\nLocked files:\nPid          User(ID)   DenyMode   Access      R/W        Oplock           SharePath   Name   Time\n--------------------------------------------------------------------------------------------------\n127455       1002       DENY_NONE  0x100081    RDONLY     NONE             /home/haas/Haas_Data_collect/minimill   .   Fri Jan  9 19:49:03 2026\n127455       1002       DENY_NONE  0x100081    RDONLY     NONE             /home/haas/Haas_Data_collect/minimill   .   Fri Jan  9 19:49:03 2026\n127455       1002       DENY_NONE  0x100081    RDONLY     NONE             /home/haas/Haas_Data_collect/minimill   .   Fri Jan  9 19:49:03 2026\n127455       1002       DENY_NONE  0x120089    RDONLY     LEASE(RWH)       /home/haas/Haas_Data_collect/minimill   O1000.txt   Fri Jan  9 19:57:32 2026\n117495       1003       DENY_NONE  0x100081    RDONLY     NONE             /home/haas/Haas_Data_collect/st30   .   Thu Jan  8 11:45:51 2026\n117495       1003       DENY_NONE  0x100081    RDONLY     NONE             /home/haas/Haas_Data_collect/st30   .   Thu Jan  8 11:45:51 2026\n</code></pre>"},{"location":"build_pi_5_appliance/Install_Samba/#what-the-output-means","title":"What the output means","text":"<p>The first section list the username, group, IP address of the machine that mapped the drive. Then you can see that SMB3 is being used. Yes, no SMBv1 vulnerabilities on the appliance!</p> <p>The second section lists the <code>systemd service file</code> that was used for each device, the IP address and the <code>pid</code>. In this case, there are the following devices connected:</p> <ul> <li>192.168.10.104 - A Windows 11 laptop with a mapping to the <code>minimill</code> share</li> <li>192.168.10.143 - An Ubuntu laptop with a mapping to the <code>Haas</code> share</li> <li>192.168.10.143 - An Ubuntu laptop with a mapping to the <code>ST40</code> share</li> <li>192.168.10.120 - An Apple Silicon MacBook with a mapping to the <code>ST30</code> share</li> </ul> <p>The third section lists files that are locked. This can useful information if a user left a file open.</p> <p>To force all new files and directories created via Samba to have a specific owner and permissions, you need to modify the share's configuration in your smb.conf file.</p> <p>This configuration requires two main changes:</p> <ul> <li>Enforce the desired user and group ownership for all connections to that share.</li> <li>Set the default file and directory creation masks to match the desired permissions.</li> </ul>"},{"location":"build_pi_5_appliance/Install_Samba/#permission-errors","title":"Permission errors","text":"<p>If you have any problems with permissions after mapping a drive follow these steps to make sure new files get the correct permissions.</p> <ul> <li>Edit your Samba configuration file: Use a text editor like nano to edit the smb.conf file. The path is typically /etc/samba/smb.conf.</li> </ul> <pre><code>sudo nano /etc/samba/smb.conf\n</code></pre> <p>Locate the relevant share definition (e.g., [Haas]) and add or modify the following lines within that specific share section: ini</p> <pre><code>[HAAS]\n  comment = Haas Data collector home\n  path = /home/haas/Haas_Data_collect\n  writable = yes\n  browsable = yes\n  public = no\n  valid users = @HaasGroup, haas # Ensure the user is valid\n  force user = haas\n  force group = HaasGroup\n  create mask = 0664\n  force create mode = 0664\n  directory mask = 0775\n  force directory mode = 0775\n</code></pre>"},{"location":"build_pi_5_appliance/Install_Samba/#definitions","title":"Definitions","text":"<ul> <li>force user = haas: Ensures that all operations on this share are performed as the user haas, making them the owner of all new files.</li> <li>force group = HaasGroup: Ensures that all new files and directories are assigned to the group HaasGroup.</li> <li>create mask = 0664 and force create mode = 0664: These lines work together to ensure that the resulting file permissions are exactly rw-rw-r-- (664 octal).</li> <li>directory mask = 0775 and force directory mode = 0775: These lines ensure that new directories are created with rwxrwxr-x permissions (775 octal), which includes the necessary execute bit for directory traversal.</li> </ul>"},{"location":"build_pi_5_appliance/Install_Samba/#restart-samba","title":"Restart Samba","text":"<p>After any changes to the Samba configuration file you must test the configuration and restart the service.  Use the following:</p> <pre><code>testparm -s\n</code></pre> <p>If there are no errors reported, restart the Samba Server service using:.</p> <pre><code>sudo systemctl restart smbd\n</code></pre> <p>There is no output from this command.</p> <p>Ensure the underlying Linux directory permissions are correct: On the server's filesystem, make sure the shared directory (/home/haas/Haas_Data_collect) in this example) is owned by haas:HaasGroup.</p> <pre><code>sudo chown -R haas:HaasGroup /home/haas/Haas_Data_collect\nsudo chmod -R 2775 /home/haas/Haas_Data_collect\n</code></pre> <p>The 2 in 2775 sets the setgid bit, which ensures that all locally created files also inherit the HaasGroup.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/","title":"Let's build the appliance","text":"<p>As you can imagine, there are a lot of steps required to build a functional appliance from scratch. But once you have completed it, you will have gained a lot of useful knowledge!</p> <ul> <li>Clone the repository - This is how you get the code from the repository to the appliance.</li> <li>Create the systemd service files - Used to start the Python data collection scripts when the appliance is booted.</li> <li>Enable the systemd services - Configure the services to start on boot</li> <li>Install Samba Server - Samba is used to create Windows compatible shares.</li> <li>Create the security group - Used to allow Windows users access to the directory shares on the appliance.</li> <li>Create the users - Multiple users are needed to deploy into production</li> <li>Add the users to the security group - Required for sharing</li> <li>Create the directories - A place to store files</li> <li>Create the Samba shares - Allows Windows users to map a network drive to the appliance</li> </ul> <p>The next sections will cover all of these topics in detail.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#clone-the-repository","title":"Clone the repository","text":"<p>Note</p> <p>Linux uses a case sensitive file system. So <code>Haas</code> is different from <code>haas</code>. If you type a command, for example, <code>LS -l</code> instead of <code>ls -l</code> and it says <pre><code>LS -l\nzsh: command not found: LS\n</code></pre></p> <p>Make sure you have the case correct!</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#open-a-terminal-on-the-pi","title":"Open a terminal on the Pi","text":"<p>If you are using ssh to connect, you are already at the terminal. If you are using the desktop version of Ubuntu, press <code>ctrl+alt+t</code> to open a terminal.</p> <ul> <li>Make sure you are in your home directory by running <code>cd ~</code></li> <li>Verify using <code>pwd</code> which is <code>print working directory</code> in Linux. You should see:</li> </ul> <pre><code>pwd\n/home/haas\n</code></pre> <p>Note</p> <p>The examples in this document will have <code>/home/haas</code> and <code>/home/haas/Haas_Data_collect</code>. When you install Ubuntu on your Raspberry Pi 5 use <code>haas</code>, all lowercase, as the username. If you use a different name, remember to update the path after you paste a command into the terminal.</p> <ul> <li>Clone the repository using</li> </ul> <pre><code>git clone https://github.com/rikosintie/Haas_Data_collect.git\n</code></pre> <ul> <li>Change to the <code>Haas_Data_collect</code> folder using</li> </ul> <pre><code>cd Haas_Data_collect\n</code></pre> <ul> <li>List the files for reference using <code>ls -l</code></li> </ul>"},{"location":"build_pi_5_appliance/configuring_appliance/#the-installation-script","title":"The installation script","text":"<p>The repository includes a script named: <code>haas_firewall_install.sh</code>. The script does a lot of the heavy lifting to get the appliance up and running.</p> <ul> <li>Writes the <code>/etc/haas-firewall.conf</code> file that allows you to add a custom subnet for the Haas CNCs if your network uses segmentation. Allows you to set a custom SSH port for the firewall rules if your security policy requires it.</li> <li>Installs the systemd firewall service + timer</li> <li>Installs Samba server and updates /etc/samba/smb.conf</li> <li>Sets up Samba security and creates the \"[Haas]\" share</li> <li>Creates Samba and Linux users from the <code>initial_users.csv</code> file</li> <li>Installs the Cockpit extension for managing/monitoring the firewall</li> <li>Installs the \"micro\" cli text editor</li> <li>Installs the \"fresh\" cli text editor</li> <li>Copies <code>issue.net</code> to <code>/etc/issue.net</code> (This is the Pre-logon banner)</li> <li>Copies csvlens binary to /usr/local/sbin - csvlens is a cli tool for viewing csv files. Example <code>csvlens users.csv</code></li> <li>Creates the backup directory in the repo</li> <li>Triggers an initial firewall configuration via systemd</li> </ul> <p>It does NOT modify or delete anything inside the repo.</p> <p>The installation script does not create the The systemd service files because they must be modified for your machine names and ip addresses. They are covered after the installation script.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#update-text-files","title":"Update text files","text":"<p>There are a three files in the <code>Haas_Data_collect</code> directory that need to be updated to fit your environment before you run the install script:</p> <ul> <li>users.csv - This file contains usernames, ip addresses and roles for configuring the firewall.</li> <li>initial_users.csv - Users who need access to the Windows shares on the appliance. The CNC controls will use the <code>haassvc</code> user account. Add CNC programmers, and operations personnel that need to copy files to/from the appliance.</li> <li>issue.net - This is the login banner. It gets copied to <code>/etc/issue.net</code> by the <code>haas-firewall-install.sh</code> script. This is a generic file. Update it per your company's security policy.</li> </ul> <p>These files are used as input to the <code>haas-firewall-install.sh</code> script that is presented next.</p> <p>There two user components to the appliance setup, which may be confusing at first! The appliance is protected by the Ubuntu firewall. The firewall is configured automatically by the data in the file <code>users.csv</code>.</p> <p>There are also <code>users</code> created from data in the file <code>initial_users.csv</code>. These are users that need to have both Linux and Samba accounts to access the file shares. The installation scripts creates the user accounts.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#userscsv","title":"users.csv","text":"<p>This is a comma-separated value (csv) file that contains the users, ip addresses and roles of any users that need to access the Raspberry Pi 5 appliance. Every Haas CNC machine will need to be in this file, otherwise the firewall will block access. If your machines are on a dedicated IP subnet, a best practice, you can edit the <code>/etc/haas-firewall.conf</code> file and enter the subnet. There is a script that will read the <code>haas-firewall.conf</code> file and update the firewall. That is explained in the <code>Cockpit management</code> section.</p> <p>The format for <code>users.csv</code> is:</p> <pre><code>username,ip_address,role\nhaas,192.168.10.143,Administrator\nhaassvc,192.168.10.104,user\nmchavez,192.168.10.133,user\nthubbard,192.168.10.100,user\nst30,192.168.10.110,user\nst30l,192.168.10.111,user\nst40,192.168.10.112,user\nvf2ss,192.168.10.113,user\nvf5ss,192.168.10.114,user\nminimill,192.168.10.115,user\n</code></pre> <ul> <li>username - The username of a person or machine that will access the appliance.</li> <li>ip _address - This is the IP address of devices that need to access the appliance.</li> <li>roles:<ol> <li>Administrator - Users that can manage the appliance. They can access ssh, smb shares, Cockpit.</li> <li>User - This role is configured on the Haas CNC and any users that only needs to map drives. Only file share access through the firewall</li> </ol> </li> </ul> <p>The <code>users.csv</code> file will remain in the <code>Haas_Data_collection</code> folder after the appliance is in production. Anytime the firewall needs to be modified you will update the <code>users.csv</code> file.</p> <p>Use the following to edit the file if you are connected over ssh:</p> <pre><code>cd ~/haas/Haas_Data_collect\nnano users.csv\n</code></pre> <p>When you are finished use the following to <code>save</code> and <code>close</code> the file:</p> <pre><code>ctrl+s\nctrl+x\n</code></pre> <p>If you are in the Desktop version of Ubuntu you can open the <code>Files</code> application and double click on <code>users.csv</code>. That will open the file in LibreOffice Calc. Make sure you save the file as a <code>csv</code> file and not an <code>odf</code> or excel format.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#the-initial_userscsv-file","title":"The initial_users.csv file","text":"<p>This is a comma-separated value (csv) file that contains usernames and passwords. These are users authorized to map drives to the appliance. Every user who needs to work with the appliance should be listed in this file. The installation script will create a Linux user account and Samba account for each user in <code>initial_users.csv</code>. This would include:</p> <ul> <li>Haas CNC controls - Use <code>haassvc</code> on all machine tools when enabling file sharing. Their role is <code>user</code>.</li> <li>CNC Programmers - You can map a drive using a Windows user name or use <code>haassvc</code> since the programmers only need to access the shares. Their role in <code>users.csv</code> would be <code>user</code>.</li> <li>Operations employees - These are users that will be copying log files for data analysis. You can map a drive using a Windows user name or use <code>haassvc</code> since the programmers only need to access the shares. Their role in <code>users.csv</code> would be <code>user</code>.</li> <li>Administrators - These are users that can add users, modify the firewall, and, monitor the appliance with the Cockpit extension. Use their Windows user name. Since the appliance isn't integrated into Active Directory, you will have to make up a password for them. Their role in <code>users.csv</code> would be <code>administrator</code>. The only administrator account that is mandatory is the <code>haas</code> account used to build the appliance,</li> </ul>"},{"location":"build_pi_5_appliance/configuring_appliance/#there-are-two-trains-of-thoughts-on-usernames","title":"There are two trains of thoughts on usernames","text":"<p>Use <code>haassvc</code> for all CNC controls, programmers, and operations people. They only get r/w access to shares. They cannot manage the appliance. Use <code>haassvc</code> for all CNC controls, use the Windows username for all other users. They only get r/w access to shares. They cannot manage the appliance.</p> <p>The first method is easier to deploy and maintain, but you lose the ability to track who has been logging in. Verify your company's security policy before deciding on a method to use.</p> <p>By default, the only user who can run Linux commands with superuser rights is <code>haas</code>, the user who installed Ubuntu.</p> <p>I used <code>xxxxxxxxx</code> for all users. This is because GitHub is scanned thousands of times per day by attackers looking for secrets. If I used anything resembling a password, attackers would be publishing my repository all over the dark web. I attended a <code>Crowdstrike</code> conference in Las Vegas in 2024. In one of the classes I got to enter <code>rikosintie</code> into their <code>Dark Web</code> tool. I was stunned that my repositories were listed as having <code>ssh keys</code> and passwords in the clear. None of the <code>ssh keys</code> or passwords were valid, I had changed several characters in the keys and the passwords were nonsense, but the Dark Web as very excited about them!</p> <p>Here is the included sample file. Modify it to fit your environment:</p> <pre><code>username, password\nmhubbard, xxxxxxxxx\nhaassvc, xxxxxxxxx\nmchavez, xxxxxxxxx\nthubbard, xxxxxxxxx\n</code></pre> <p>I know it's odd that there are <code>users.csv</code> and <code>initial_users.csv</code> but there is no secure way to leave passwords lying around in plain text files.</p> <p>Warning</p> <p>This file contains usernames/passwords that the installation script will use to create the Samba shares. You should delete this file as soon as the script finishes the installation.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#the-login-banner-issuenet","title":"The login banner - issue.net","text":"<p>This is a text file that is displayed before a user logs in over ssh. The included file is a basic \"You need Authorization\" banner. Modify it to match your organization's security policy before running the installation script. If you need to update it later, use <code>sudo nano /etc/issue.net</code> to open the file. ASCII art is a method of making banners using ASCII characters. I used the ASCII Art Archive to create this banner. You can get much fancier if you want to spend the time! If you are also responsible for network equipment, you can use the approved banner from a switch or router.</p> <pre><code>                 Haas Data Collection Server\n\n\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551                                                                 \u2551\n\u2551 UNAUTHORIZED ACCESS TO THIS NETWORK DEVICE IS PROHIBITED.       \u2551\n\u2551 You must have explicit permission to access or configure this   \u2551\n\u2551 device.  All activities performed on this device are logged and \u2551\n\u2551 violations of this policy may result in disciplinary action.    \u2551\n\u2551                                                                 \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n</code></pre> <p>Use the following to edit the file if you are connected over ssh:</p> <pre><code>cd ~/haas/Haas_Data_collect\nnano issue.net\n</code></pre> <p>When you are finished use the following to <code>save</code> and <code>close</code> the file:</p> <pre><code>ctrl+s\nctrl+x\n</code></pre> <p>If you are in the Desktop version of Ubuntu Open the <code>Files</code> application and right click on <code>issue.net</code> and select <code>Open with text Editor</code>. That will open the file in <code>Gnome Text Editor</code>.</p> <p>Use the following to edit the file if you are connected over ssh:</p> <pre><code>cd ~/haas/Haas_Data_collect\nsudo initial_users.csv\n</code></pre> <p>When you are finished use the following to <code>save</code> and <code>close</code> the file:</p> <pre><code>ctrl+s\nctrl+x\n</code></pre> <p>If you are in the Desktop version of Ubuntu you can open the <code>Files</code> application and double click on <code>users.csv</code>. That will open the file in LibreOffice Calc. Make sure you save the file as a <code>csv</code> file and not an <code>odf</code> or excel format.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#the-install-script-details","title":"The install script details","text":"<p>The installation script <code>haas_firewall_install.sh</code> is written in <code>bash</code>, the native Linux language for system administration tasks. I have included comments for every section. You should review the script before running it so that you have an idea what it does.</p> <p>Use the following to view the file if you are connected over ssh:</p> <pre><code>cd ~/haas/Haas_Data_collect\ncat initial_users.csv\n</code></pre> <p>If you are in the Desktop version of Ubuntu Open the <code>Files</code> application and right click on <code>haas_firewall_install.sh</code> and select <code>Open with text Editor</code>. That will open the file in <code>Gnome Text Editor</code>.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#run-the-installation-script","title":"Run the installation script","text":"<p>In Linux, scripts have to be marked <code>eXecutable</code> before you can run them. The files should already have the execute bit set but check with:</p> <pre><code>cd ~/haas/Haas_Data_collect\nls -l haas_firewall_install.sh\n</code></pre> Command Output<pre><code>ls -l haas_firewall_install.sh\n-rwxrwxr-x 1 mhubbard mhubbard 14347 Feb  5 15:12 haas_firewall_install.sh\n</code></pre> <p>If you don't see the <code>x</code> in the output, run the following:</p> <pre><code>chmod +x haas_firewall_install.sh\n</code></pre> <p>Execute the script using:</p> <pre><code>cd ~/Haas_Data_collect\n./haas_firewall_install.sh\n</code></pre> <p>There will be a lot of output as the script does it's job! Once it completes, review the output for any error messages. I don't expect any failures, the script has been tested on a Raspberry Pi 5 with an NVME drive, an Intel NUC running Ubuntu Desktop, a virtual machine running ubuntu Desktop.</p> <p>If there were no errors we can move on to creating the <code>systemd service files</code> that will automatically start the scripts when the Raspberry Pi 5 is booted.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#the-systemd-service-files","title":"The systemd service files","text":"<p>Ubuntu uses an initialization (init) service named <code>systemd</code>. Systemd manages what services are initialized when Ubuntu starts up. We will use <code>systemd</code> to manage the Python scripts.</p> <p>The installation script Does Not copy any service files so the Python scripts to collect data  are not running immediately after the installation script finishes.</p> <p>The service files are where you define how to call the Python script when the Pi starts up. In the repository there are six files representing six different machine tools. A service file requires:</p> <ul> <li>Machine name</li> <li>The port to be used on the machine</li> <li>The IP address of the CNC controller</li> </ul> <p>These are the machine names, ports and IP addresses in the sample files.</p> Machine Port# IP Address ST40 5052 192.168.10.141 VF2SS 5053 192.168.10.142 VF5SS 5054 192.168.10.143 MINIMILL 5055 192.168.10.143 ST30 5056 192.168.10.144 ST30L 5057 192.168.10.145 <p>You will have different names and IP addresses on your machine tools. No problem, just make a table of your names, the ports, and the IP addresses. Then modify the existing service files. Here is the format:</p> <pre><code>[Unit]\nDescription=Haas Python logger for ST40\nAfter=network.target\n\n[Service]\nUser=haas\nWorkingDirectory=/home/haas/Haas_Data_collect\nExecStart=/usr/bin/python3 /home/haas/Haas_Data_collect/haas_logger2.py -a -t 192.168.10.140  --port 5052 --name ST40\nType=idle\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>Warning</p> <p>Be extremely careful when you edit the files. Any mistake will prevent you from successfully receiving data from the machine and can be challenging to troubleshoot.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#creating-systemd-service-files","title":"Creating systemd Service files","text":"<p>The systemd service files are located in <code>/etc/systemd/system/</code> so you must use sudo to edit them. Think of <code>sudo</code> as <code>UAC</code> in Windows. The advantage is that you can proactively use <code>sudo</code> and not have to deal with pop up dialogs asking for permission!</p> <p>As an example, let's use the included st40.service file. You should be in the <code>Haas_Data_collect</code> directory. You can rename it using <code>mv st40.service new_name.service</code>. Use the following to copy <code>st40.service</code> to the <code>/etc/systemd/system/</code> directory:</p> <p><code>sudo cp st40.service /etc/systemd/system/st40.service</code> or <code>sudo cp new_name.service /etc/systemd/system/new_name.service</code></p> <p>Use the following to edit the st40.service file after you copy it:</p> <pre><code>sudo nano /etc/systemd/system/st40.service\n</code></pre> <p>This will open <code>st40.service</code> in the built in <code>nano</code> editor.</p> <p>Note</p> <p>For whatever reason, <code>nano</code> doesn't use the normal text editor keys. If you are brand new to Linux, use this tutorial to learn nano - The beginners guide to Nano the Linux command line text editor</p> <p>You can install the Fresh Editor using the command below. The site for the Fresh Editor is Fresh. I find it easier to use than <code>nano</code> because it uses the same key bindings as most GUI editors.</p> <pre><code>https://raw.githubusercontent.com/sinelaw/fresh/refs/heads/master/scripts/install.sh | sh\n</code></pre> <p>Note</p> <p>In the Linux/Unix world it is considered bad security practice to pipe a command to the shell that you found on the Internet. Feel free to go to the Fresh webpage and copy the command from there.</p> <p>If you installed the desktop version of Ubuntu, you can use the GUI Gnome Text Editor GUI to edit the files by running:</p> <p><code>sudo gnome-text-editor /etc/systemd/system/st40.service</code></p>"},{"location":"build_pi_5_appliance/configuring_appliance/#what-you-need-to-modify","title":"What you need to modify","text":"<ul> <li>Description - The description is shown when you check the status of the service. Change to something that makes sense in your environment</li> <li>ExecStart - This is where the table of names, ports, IP addresses comes in handy.</li> </ul> <p>Nothing else needs to be changed in the service file.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#configuring-systemd-to-use-the-service-files","title":"Configuring systemd to use the service files","text":"<p>Once you have the service file modified, use the following commands to set up the service:</p> <pre><code>sudo systemctl daemon-reload\nsudo systemctl enable st40.service\nsudo systemctl start st40.service\n</code></pre> <p>There is no output from these commands.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#what-the-commands-do","title":"What the commands do","text":"<ul> <li>sudo systemctl daemon-reload - Forces <code>systemd</code> to read the changes in the systemd files</li> <li>sudo systemctl enable st40.service - Tells <code>systemd</code> to run the service on boot</li> <li>sudo systemctl start st40.service - Actually starts the <code>systemd</code> service</li> </ul> <p>Once these commands are run the <code>st40.service</code> should be active.</p> <p>Run this command to check the status of the <code>st40.service</code>:</p> <pre><code>sudo systemctl status st40.service\n</code></pre> Status of the st40.service<pre><code>\u256d\u2500haas@haas ~\n\u2570\u2500$ sudo systemctl status st40.service\n\u25cf st40.service - Haas Python logger for ST40\n     Loaded: loaded (/etc/systemd/system/st40.service; enabled; preset: enabled)\n     Active: active (running) since Mon 2025-12-29 16:09:45 PST; 2s ago\n   Main PID: 115518 (python3)\n      Tasks: 1 (limit: 4601)\n     Memory: 6.9M (peak: 7.1M)\n        CPU: 37ms\n     CGroup: /system.slice/st40.service\n             \u2514\u2500115518 /usr/bin/python3 /home/haas/Haas_Data_collect/haas_logger2.py -a -t 192.168.10.122 --port 5052 --name ST40\n\nDec 29 16:09:45 ubuntu-server systemd[1]: Started st40.service - Haas Python logger for ST40.\n</code></pre> <p>Notice the description from the service file is shown. Also, <code>Main PID</code> can be useful during troubleshooting. That is the Process ID, similar to what you would see in the <code>Windows Task Manager</code>. In this case it's 115518 and we can track it using:</p> <pre><code>ps -ef | grep -E \"115518|PID\"\n</code></pre> Command Output<pre><code>UID          PID    PPID  C STIME TTY          TIME CMD\nhaas  115518       1  0 06:28 ?        00:00:04 /usr/bin/python3 /home/haas/Haas_Data_collect/haas_logger2.py -a -t 192.168.10.122 --port 5052 --name ST40\n</code></pre> <p>The <code>haas</code> is the User ID (UID) that owns the process, 115518 is the Process ID (PID).</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#memory-usage","title":"Memory Usage","text":"<p>The status command also lists the amount of RAM used by the script. You can see that the peak usage was 7.1MB. I haven't seen the script use more than that, so a Raspberry Pi 5 with 8GB of RAM could support many machine tools.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#scaling-up","title":"Scaling up","text":"<p>If you only have a handful of machines, editing the included service files and changing the name of the <code>systemctl</code> commands is the quickest way to create the service files and enable the services.</p> <p>If you have double or triple digits of machines, that gets old fast. You can use the Python script, <code>conf-gen_xlsx_v1.py</code> included in the repository, and a spreadsheet to generate the files and <code>systemd</code> commands automatically.</p> <p>It's probably easier to clone the repo to your laptop and run the scripts on it. The script will run on Mac/Linux/Windows and you can create the spreadsheet on the laptop. Or just create the spreadsheet on the laptop and copy it to the appliance after the <code>Samba shares</code> are created.</p> <p>The spreadsheet name is <code>machines.xlsx</code>. The format of the spreadsheet is that row one is a header with the following data:</p> <pre><code>description, username, ip_address, port, name\n</code></pre> <p>Fill out as many rows as you need, save it in the root of the Haas_Data_collect folder.</p> <p>Here is a example:</p> description   - username ip_address name Logger for ST40 haas 192.168.0.140 st40 Logger for ST30 haas 192.168.0.141 st30 Logger for ST30L haas 192.168.0.142 st30l"},{"location":"build_pi_5_appliance/configuring_appliance/#install-dependencies","title":"Install Dependencies","text":"<p>The script requires some dependencies. Use the following to install them:</p> <pre><code>python -m pip install pandas\npython -m pip install jinja2\npython -m pip install openpyxl\n</code></pre>"},{"location":"build_pi_5_appliance/configuring_appliance/#create-the-service-files","title":"Create the service files","text":"<p>Run the following:</p> <p><code>python3 conf-gen_xlsx_v1.py -f machines.xlsx -t service-template.txt</code></p> <p>This creates the service files and saves them as <code>&lt;name&gt;.service</code> to the root of the project. Note that you can name the spreadsheet anything you want. Just change the <code>machines.xlsx</code> to the new filename.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#create-the-sudo-commands","title":"Create the sudo commands","text":"<p>Run the following: <code>python3 conf-gen_xlsx_v1.py -f machines.xlsx -t systemd-template.txt</code></p> <p>The files are saved as <code>&lt;name&gt;.txt</code> in the root of the project directory. Here are the contents of st40.txt</p> <pre><code>sudo cp st40.service /etc/systemd/system/st40.service\nsudo systemctl daemon-reload\nsudo systemctl enable st40.service\nsudo systemctl start st40.service\nsudo systemctl status st40.service\n\n# Create the directory for the share\n\nmkdir /home/haas/st40\n\n# Create the share configuration\n\n[st40]\n    comment = Logger for ST40\n    path = /home/haas/st40\n    read only = no\n    browsable = yes\n    writable = yes\n    public = no\n    valid users = @HaasGroup, haas # Ensure the user is valid\n    force user = haas\n    force group = HaasGroup\n    create mask = 0664\n    force create mode = 0664\n    directory mask = 0775\n    force directory mode = 0775\n</code></pre> <p>It's much easier to peer review a spreadsheet than a bunch of files! If the spreadsheet is accurate, you will instantly get the service files and the commands to install them.</p> <p>Note</p> <p>The template files are just text files formatted for Jinja2. Basically a set of curly braces like this represent a variable <code>{{}}</code>. You can create your own templates and run them. The Python script doesn't care what is in the template, it just reads the spreadsheet and renders the template.</p> <p>I have a lot of Jinja2 resources on my Cisco DevNet github if you are interested.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#create-aliases","title":"Create aliases","text":"<p>During debugging you will find yourself typing the <code>systemctl</code> commands a lot. I recommend creating some bash aliases to cut down on the typing. Open the bashrc file on the Pi using <code>nano ~/.bashrc</code> or <code>gnome-text-editor ~/.bashrc</code>. If you are using zsh as your shell, the commands will be <code>nano ~/.zshrc</code> or <code>gnome-text-editor ~/.zshrc</code></p> <p>Note</p> <p>Notice the period in front of the bashrc filename. In Linux/Unix the period at the front of a filename means it is a hidden file. To see hidden files use <code>ls -la</code> which means show all files.</p> <p>Paste the following in at the bottom of the file:</p> <pre><code>alias gte='gnome-text-editor\nalias dmr='sudo systemctl daemon-reload'\nalias stop='(){sudo systemctl stop \"$1\".service}'\nalias start='(){sudo systemctl start \"$1\".service}'\nalias status='(){sudo systemctl status \"$1\".service}'\nalias servfile='(){sudo nano /etc/systemd/system.\"$1\".service}'\n</code></pre> <p>Save the file with <code>ctrl+s</code>, close it with <code>ctrl+x</code> Update bash by typing <code>exec bash</code> and pressing enter.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#what-does-the-1-do","title":"What does the $1 do","text":"<p>The <code>$1</code> is a placeholder, it gets replaced with the first text on the command line after the alias name. For example <code>stop st40</code> will become <code>sudo systemctl stop st40.service</code>.</p>"},{"location":"build_pi_5_appliance/configuring_appliance/#use-the-aliases","title":"Use the aliases","text":"<p>Now you can type the following:</p> <ul> <li><code>gte st30l.service</code> instead of <code>gnome-text-editor st30l.service</code></li> <li><code>stop st40</code> to stop the st40.service</li> <li><code>start st40</code> to start the st40.service</li> <li><code>status st40</code> to show the status of the st40.service</li> <li><code>dmr</code> to reload the daemons</li> </ul>"},{"location":"build_pi_5_appliance/configuring_appliance/#samba-installation","title":"Samba installation","text":"<p>Key changes:</p> <ul> <li>Overwrites /etc/samba/smb.conf entirely with tee (without -a)</li> <li>Backs up the original to smb.conf.backup first</li> <li>Includes all the security settings in the [global] section</li> <li>Disables the printer share</li> <li>Adds <code>testparm -s</code> to validate the configuration before restarting</li> </ul> <pre><code>[global]\n    workgroup = WORKGROUP\n    server string = %h server (Samba, Ubuntu)\n    log file = /var/log/samba/log.%m\n    max log size = 10000\n    logging = file\n    panic action = /usr/share/samba/panic-action %d\n\n    # Authentication\n    server role = standalone server\n    obey pam restrictions = Yes\n    unix password sync = Yes\n    passwd program = /usr/bin/passwd %u\n    passwd chat = *Enter\\snew\\s*\\spassword:* %n\\n *Retype\\snew\\s*\\spassword:* %n\\n *password\\supdated\\ssuccessfully* .\n    pam password change = Yes\n    map to guest = Bad User\n\n    # Protocol Security - Force SMB2/SMB3 only\n    client min protocol = SMB2\n    client max protocol = SMB3\n    server min protocol = SMB2\n    server max protocol = SMB3\n\n    # Disable legacy protocols and services\n    disable netbios = Yes\n    disable spoolss = Yes\n\n    # Disable printing\n    load printers = No\n    printing = bsd\n    printcap name = /dev/null\n\n    [printers]\n    available = No\n    browseable = No\n    printable = Yes\n\n[print$]\n    available = No\n\n    # Performance\n    socket options = TCP_NODELAY IPTOS_LOWDELAY\n\n[Haas]\n    comment = Haas Directory Share\n    create mask = 0664\n    directory mask = 0775\n    force create mode = 0664\n    force directory mode = 0775\n    force user = haas\n    force group = HaasGroup\n    path = /home/haas/Haas_Data_collect\n    read only = No\n    valid users = @HaasGroup haas\n    browseable = yes\n</code></pre> <p>Security improvements in this config:</p> <p>Forces SMB2 minimum (blocks SMB1 which has security vulnerabilities) Disables NetBIOS completely Disables printing services Only allows authenticated users (@HaasGroup)</p> <p>This approach is cleaner and ensures no duplicate entries!</p>"},{"location":"build_pi_5_appliance/create-groups/","title":"Create the HaasGroup and set file permissions","text":"<p>Linux uses groups to manage permissions for users. For this project, all users will be in the same group. That isn't a security best practice since a disgruntled employee could delete everything. If you have compliance requirements or other concerns, just repeat this process to create multiple groups. For example, create a user and group for each machine. Then add the user to the machine's share and use it as the username when setting up the account on the machine.</p> <p>Does this seem like a lot of extra work? Yes, but I actually had a disgruntled employee delete the configuration for the DNC system for a neighboring cell one time. Of course, he was a night shift employee, and did it at midnight on Friday. I got called on Saturday morning and had to drive an hour to the plant and restore it. So it depends on your determination of the risk in your shop.</p>"},{"location":"build_pi_5_appliance/create-groups/#create-the-haasgroup-group","title":"Create the HaasGroup group","text":"<pre><code>sudo groupadd HaasGroup\n</code></pre> <p>There is no output from this command.</p>"},{"location":"build_pi_5_appliance/create-groups/#set-permissions-on-the-folders","title":"Set permissions on the folders","text":"<p>You need to be in the root of your home director to review the current permissions. Use the following to verify that you are in the correct location:</p> <pre><code>cd ~\npwd\nls -l\n</code></pre> Command Output<pre><code>/home/haas\ndrw-rw-r-- 9 haas haas  4096 Jan  4 20:26 Haas_Data_collect\n</code></pre> <p>We can see the <code>Haas_Data_collect</code> folder, so we are in the correct location. Note that the <code>Haas_Data_collect</code> directory has <code>haas haas</code> listed. We need to change that to <code>haas HaasGroup</code></p> <p>Now run:</p> <pre><code># Allow traversal into /home/haas (needed to reach Haas subdirectory)\nsudo chmod 774 /home/haas\n\n# Set ownership for everything under Haas\nsudo chown -R haas:HaasGroup /home/haas/Haas_Data_Collect\n\n# View the changes\nls -l\n</code></pre> Command Output<pre><code>drwxrwxr-x 9 haas HaasGroup  4096 Jan  4 20:26 Haas_Data_collect\n</code></pre> <p>Note the <code>Haas_Data_collect</code> directory had changed from <code>haas haas</code> to <code>haas HaasGroup</code>. That means haas is the owner and HaasGroup is the group that will be applied.</p>"},{"location":"build_pi_5_appliance/create-groups/#set-the-file-permissions","title":"Set the file permissions","text":"<p>Run the following:</p> <pre><code># Set permissions: directories get execute, files don't\nsudo find /home/haas/Haas_Data_Collect -type d -exec chmod 2775 {} +\nsudo find /home/haas/Haas_Data_Collect -type f -exec chmod 664 {} +\nchmod +x /home/$USER/Haas_Data_collect/lshare.sh\nchmod +x /home/$USER/Haas_Data_collect/smb_verify.sh\nchmod +x /home/$USER/Haas_Data_collect/setup_user.sh\n</code></pre> <p>There is no output from these commands.</p> <p>Note</p> <p>The 2 in 2775 sets the <code>setgid</code> bit, basically set group ID, which ensures that all locally created files also inherit the HaasGroup. Without this bit set, files created locally on the Raspberry Pi 5 appliance would get owner and group IDs of the user that created the file. The <code>setgid</code> bit is located in the fourth character of the permissions string (the execute position of the group permissions).</p> <p>Run a directory listing to see the results:</p> <pre><code>cd ~\nls -l\n</code></pre> Command Output<pre><code>ls -l\ntotal 44\ndrwxrwsr-x 6 haas HaasGroup 4096 Jan  6 20:05 Haas_Data_collect\ndrwxrwsr-x 2 haas HaasGroup 4096 Jan  9 22:43 minimill\ndrwxrwsr-x 2 haas HaasGroup 4096 Jan  6 12:39 st30\ndrwxrwsr-x 2 haas HaasGroup 4096 Jan  9 22:11 st30l\ndrwxrwsr-x 2 haas HaasGroup 4096 Jan  9 20:32 st40\ndrwxrwsr-x 2 haas HaasGroup 4096 Dec 26 21:37 vf2ss\ndrwxrwsr-x 2 haas HaasGroup 4096 Dec 26 21:37 vf5ss\n</code></pre> <p>Now the account <code>haas</code> has <code>rwx</code> (read/write/execute) and and the group <code>HaasGroup</code> has <code>rws</code> (read\\write\\setgid) to directories. The <code>other</code> group has <code>r--</code> (read only). Files will have rw-, read/write.</p> <p>The three bash scripts in Haas_Data_collect:</p> <pre><code>~/Haas_Data_collect \u2039main\u25cf\u203a\n\u2570\u2500$ ls -l *.sh\n-rwxrwsr-x 1 haas HaasGroup  646 Jan  4 20:26 lshare.sh\n-rwxrwsr-x 1 haas haas  2441 Jan  6 12:38 setup_user.sh\n-rwxrwsr-x 1 haas HaasGroup 2620 Dec 26 23:01 smb_verify.sh\n</code></pre> <p>Have eXecute so that you can run them.</p>"},{"location":"build_pi_5_appliance/create-groups/#create-the-users","title":"Create the users","text":"<p>You will need to build a list of users that will need to access the shares. In this example I have:</p> <pre><code>|     Username    | Role and Responsibility                                                                                     |\n|:---------------:|-------------------------------------------------------------------------------------------------------------|\n|     haassvc     | The limited permission account used on the Haas CNC control                                                 |\n|     haassvc2    | An account for the customer to manage the Raspberry Pi 5                                                    |\n| Michael Hubbard | The administrator for the Raspberry Pi 5                                                                    |\n|  Manuel Chavez  | CNC Setup technician. Needs to review the CNC Programs from his Windows desktop and review the spreadsheets |\n| Robert Goodwin  | Operations. Needs access to the `cnc_logs` directory to move files                                          |\n</code></pre> <p>Run these command for each user:</p> <pre><code># Create user without shell access\nsudo useradd -M -s /usr/sbin/nologin haassvc\n\n# Add to Samba\nsudo smbpasswd -a haassvc\n\n# Enable the Samba user\nsudo smbpasswd -e haassvc\n</code></pre> <p>The first command creates the user <code>haassvc</code>.</p> <ul> <li>The <code>-M</code> skips creating a user <code>home</code> directory..</li> <li>The <code>-s /usr/sbin/nologin</code> disables shell login (good for service accounts that only need SMB access)</li> </ul> <p>The second command creates the Samba Server user. You will be prompted to enter and confirm a password. Here is the output for the <code>haassvc</code> user:</p> <pre><code>sudo smbpasswd -a haassvc\n</code></pre> <p>```bash title='Command Output New SMB password: Retype new SMB password: Added user haassvc. <pre><code>Finally,\n\n```bash\n`sudo smbpasswd -e haassvc` enables the smb username.\n</code></pre></p> Command Output<pre><code>Enabled user haassvc.\n</code></pre> <p>Add the haassvc User account to the <code>HaasGroup</code> group:</p> <pre><code>sudo usermod -aG HaasGroup haassvc\n</code></pre> <p>There is no output from this command.</p>"},{"location":"build_pi_5_appliance/create-groups/#list-all-users-in-the-haasgroup","title":"List all users in the HaasGroup","text":"<pre><code>cat /etc/group | grep Haas\n</code></pre> Command Output<pre><code>HaasGroup:x:1002:haassvc,haas\n</code></pre>"},{"location":"build_pi_5_appliance/create-groups/#verify-the-haassvc-user-settings","title":"Verify the <code>haassvc</code> user settings","text":"<pre><code>id haassvc\n</code></pre> Command Output<pre><code>uid=1001(haassvc) gid=1001(haassvc) groups=1001(haassvc),1002(HaasGroup)\n</code></pre>"},{"location":"build_pi_5_appliance/create-groups/#create-users-the-easy-way","title":"Create users the easy way","text":"<p>It's fairly simple to create a user but it's a lot of individual commands which leaves room for errors. There is bash script to do the heavy lifting included in the repository. It gets installed when you clone the repository. To use it, first run the following command:</p> <pre><code>cd /home/haas/Haas_Data_Collect\nchmod +x setup_user.sh\n</code></pre> <p>There is no output from this command.</p> <p>Now you can create new users by running the following. Here I am creating the <code>rgoodwin</code> user. Replace <code>rgoodwin</code> with the username you need to create:</p> <pre><code>sudo ./setup_user.sh rgoodwin\n</code></pre> <p>How the script works*</p> <ul> <li>You will be asked for your password to activate <code>sudo</code>.</li> <li>You will be  asked for the password to use for the username.</li> <li>You will be  asked for the smbuser password. It MUST be the same as the Linux user!</li> <li>It will then create and enable the smb user, add it to the group and display the result.</li> </ul> <p>Here is the output of the script for the rgoodwin user:</p> <pre><code>[sudo] password for haas:\nAttempting to create and configure user: rgoodwin\nSystem user rgoodwin created.\nNew password:\nRetype new password:\npasswd: password updated successfully\nNew SMB password:\nRetype new SMB password:\nAdded user rgoodwin.\nEnabled user rgoodwin.\nConfiguration complete for rgoodwin.\nVerifying user configuration:\nuid=1004(rgoodwin) gid=1005(rgoodwin) groups=1005(rgoodwin),1002(HaasGroup)\n</code></pre> <p>Here is the code for the setup_user.sh script:</p> <pre><code>#!/bin/bash\n\n# Function to create a new system user with specific configurations (e.g., Samba, group membership)\n# Usage: create_samba_user &lt;username&gt;\ncreate_samba_user() {\n    # Check if exactly one argument (the username) was provided\n    if [ \"$#\" -ne 1 ]; then\n        echo \"Error: Usage requires exactly one argument: create_samba_user &lt;username&gt;\" &gt;&amp;2\n        return 1\n    fi\n\n    local USERNAME=\"$1\"\n    local GROUP_NAME=\"HaasGroup\"\n\n    echo \"Attempting to create and configure user: $USERNAME\"\n\n    # 1. Create the system user without a home directory and a nologin shell\n    # Error trapping: '|| { ...; return 1; }' stops execution if a command fails\n    sudo useradd -M -s /usr/sbin/nologin \"$USERNAME\" || {\n        echo \"Error creating system user $USERNAME. User may already exist or permissions issue.\" &gt;&amp;2\n        return 1\n    }\n    echo \"System user $USERNAME created.\"\n\n    # 2. Set the system password (will prompt for a new password interactively)\n    # The user running this script will be prompted by 'passwd' to set the password.\n    sudo passwd \"$USERNAME\" || {\n        echo \"Error setting system password for $USERNAME.\" &gt;&amp;2\n        return 1\n    }\n\n    # 3. Add user to Samba database and set the Samba password\n    # The user running this script will be prompted by 'smbpasswd' to set the Samba password.\n    sudo smbpasswd -a \"$USERNAME\" || {\n        echo \"Error adding user to Samba database $USERNAME.\" &gt;&amp;2\n        # Clean up the system user if Samba setup fails\n        sudo userdel \"$USERNAME\"\n        return 1\n    }\n\n    # 4. Enable the Samba account\n    sudo smbpasswd -e \"$USERNAME\" || {\n        echo \"Error enabling Samba account for $USERNAME.\" &gt;&amp;2\n        sudo userdel \"$USERNAME\"\n        return 1\n    }\n\n    # 5. Add the user to the specified group (e.g., HaasGroup)\n    # Note: Ensure 'HaasGroup' exists on your system beforehand.\n    sudo usermod -aG \"$GROUP_NAME\" \"$USERNAME\" || {\n        echo \"Warning: Failed to add $USERNAME to the group $GROUP_NAME. Proceeding anyway.\" &gt;&amp;2\n    }\n\n    echo \"Configuration complete for $USERNAME.\"\n\n    # 6. Display the final user ID/group information for verification\n    echo \"Verifying user configuration:\"\n    id \"$USERNAME\"\n}\n\ncreate_samba_user \"$@\"\n\n# --- Example Usage ---\n# To run this function, save the script (e.g., as setup_user.sh),\n# make it executable (chmod +x setup_user.sh), and run it.\n\n# Example 1: Create user 'jdoe'\n# create_samba_user jdoe\n</code></pre>"},{"location":"build_pi_5_appliance/create-groups/#verify-the-samba-server","title":"Verify the Samba Server","text":"<p>Here is a function that you can add to your <code>~/.bashrc</code> or <code>~/.zshrc</code> file to display the paths to each share. Use the following to open your ~./bashrc (or ~/.zshrc) file:</p> <pre><code>nano ~/.bashrc\n</code></pre> <p>Then paste this at the bottom of the file, save and exit.</p> <pre><code>smb-shares() {\n    while IFS= read -r line; do\n        if [[ \"$line\" == \\[*\\] ]]; then\n            # Extract share name without brackets\n            name=\"${line#\\[}\"\n            name=\"${name%\\]}\"\n        fi\n        if [[ \"$line\" == *path\\ =* ]]; then\n            # Skip global, printers, and print$ shares\n            if [[ \"$name\" != \"global\" &amp;&amp; \"$name\" != \"printers\" &amp;&amp; \"$name\" != \"print$\" ]]; then\n                # Extract path after \"path = \"\n                sharepath=\"${line#*path = }\"\n                # Print formatted output\n                printf \"%-12s %s\\n\" \"$name\" \"$sharepath\"\n            fi\n        fi\n    done &lt; /etc/samba/smb.conf\n}\n</code></pre> <p>If you don't want to add the function to your .bashrc file you can use the <code>lshares.sh</code> file that is included with the repository. You have to make it executable using:</p> <pre><code>chmod +x lshare.sh\n</code></pre> <p>Then run the script from the <code>/home/Haas_Data_collect</code> directory using:</p> <pre><code>./lshare.sh\n</code></pre> <p>Here is the output of the function:</p> <pre><code>smb-shares\nHaas         /home/haas/Haas\nST40         /home/haas/Haas/st40\nminimill     /home/haas/Haas/minimill\nVF2SS        /home/haas/Haas/vf2ss\nVF5SS        /home/haas/Haas/vf5ss\nST30         /home/haas/Haas/st30\nST30L        /home/haas/Haas/st30l\n</code></pre>"},{"location":"build_pi_5_appliance/create-groups/#troubleshooting","title":"Troubleshooting","text":"Review the Journal for user haassvc<pre><code>id haassvc\nsudo journalctl -u smbd.service -n 50 --no-pager\n</code></pre> <pre><code>uid=1001(haassvc) gid=1001(haassvc) groups=1001(haassvc),1002(HaasGroup)\nJan 05 11:05:55 ubuntu-server smbd[96113]: pam_unix(samba:session): session opened for user haassvc(uid=1001) by (uid=0)\n</code></pre>"},{"location":"build_pi_5_appliance/create-groups/#-smbclient-localhostst40-u-haassvc","title":"- smbclient //localhost/st40 -U haassvc","text":"<p>testparm -s smbclient -L //192.168.10.223 -U haas</p> <p>List only shares:</p> <pre><code>sudo smbstatus -S\n</code></pre> <p>sudo smbstatus -L -b</p> <p>Managing Locked Files If a file is inappropriately locked (e.g., a client disconnected improperly), you can identify the process and kill it:</p> <p>Run smbstatus to find the PID of the process that has the lock on the file. Verify the user and hostname associated with that PID in the output. Kill the specific smbd process using the PID:</p> <pre><code>sudo kill &lt;PID&gt;\n</code></pre> <p>This action should release the lock.</p>"},{"location":"build_pi_5_appliance/firewall_configuration/","title":"Haas Appliance Firewall","text":"<p>The appliance is built on Ubuntu 24.04, one of the most secure operating systems available. Unlike a general-purpose server, the Raspberry Pi 5 appliance has limited functionality:</p> <ul> <li>Transfer files to/from the Haas CNC control</li> <li>Accept files from the CNC programmers</li> <li>Connect to the Haas CNC controls using a predefined port and IP address to collect data</li> <li>Allow management over ssh</li> <li>Allow management with Cockpit</li> </ul> <p>So we can lock it down using:</p> <ul> <li>Local user accounts</li> <li>Linux file permissions</li> <li>Samba Server share permissions</li> <li>The Ubuntu Uncomplicated Firewall (UFW)</li> </ul> <p>Ubuntu 24.04 ships with OpenSSH 9.6, which has removed ssh-dss and made many other legacy protocols optional. You can verify the version using:</p> <pre><code>ssh -V\n</code></pre> Command Output<pre><code>OpenSSH_9.6p1 Ubuntu-3ubuntu13.14, OpenSSL 3.0.13 30 Jan 2024\n</code></pre> <p>Note</p> <p>The instructions will walk you through step by step, but if you make a mistake, you could lock yourself out unless you have a keyboard and monitor connected or purchased the Serial cable</p>"},{"location":"build_pi_5_appliance/firewall_configuration/#the-project-files","title":"The project files","text":"<ul> <li>A systemd service to apply the firewall on boot</li> <li>A systemd timer that will reapply the firewall rules daily</li> <li>A script to verify the format of the <code>csv</code> file after editing</li> <li>A custom <code>Cockpit</code> extension to manage the firewall</li> </ul> <p>The combination of the <code>systemd</code> services, <code>csv</code> verification script, and <code>Cockpit</code> extension provides an easy to use, predictable configuration.</p> <p>There is an installation script that copies the files to the correct locations and starts the services. The project also includes a script, <code>configure_ufw_from_csv.sh</code> to build and maintain the firewall configuration over time. Once the firewall is enabled, you should be able to pass a penetration test because:</p> <ul> <li>The Samba shares are only exposed to the devices in the <code>csv</code> file</li> <li>Ubuntu includes the latest version of <code>Openssh</code></li> <li>SSH access attempts are rate limited with  <code>ufw limit 22/tcp</code></li> <li>The <code>Cockpit</code> management application is only exposed to the devices in the <code>csv</code> file with the <code>management</code> role</li> </ul> <p>At the end of this section, there is a PowerShell script that you can use to test the security of the appliance.</p>"},{"location":"build_pi_5_appliance/firewall_configuration/#the-design-concept-of-the-configuration-script","title":"The design concept of the configuration script","text":"<p>The design goal for the firewall configuration script is to provide an automated, error free, firewall configuration that is easy to modify as you add machines or users. Below is a description of the components:</p> <ul> <li>An automated script reads a CSV file to build the firewall rules</li> <li>Support for two roles:<ol> <li>user \u2192 Samba (445) only</li> <li>Administrator \u2192 Samba (445), SSH (22), Cockpit (9090)</li> </ol> </li> <li>Adds UFW rules for IPv4 and IPv6 (UFW handles both automatically when IPv6 is enabled)</li> <li>Adds extra firewall hardening that you may want in a manufacturing environment</li> <li>Allows the Haas machines to be on a separate segmented subnet</li> <li>Creates a log of the UFW changes</li> </ul> <p>\ud83d\udfe6 Why this design is good</p> <ul> <li>Automatic appliance behavior via systemd</li> <li>Developer\u2011friendly manual testing via CLI</li> <li>No conflicts between the two methods: automatic/manual testing</li> <li>No need to stop services to test</li> </ul>"},{"location":"build_pi_5_appliance/firewall_configuration/#the-csv-file-format","title":"The CSV file format","text":"<p>The project includes a script, <code>configure_ufw_firewall.sh</code> that reads a <code>csv</code> file and creates the firewall rules. The <code>csv</code> file format is shown below:</p> <pre><code>username,desktop_ip_address,role\nhaas,192.168.10.143,Administrator\nhaassvc,192.168.10.104,user\nhaassvc2,192.168.10.120,Administrator\nrgoodwin,192.168.10.120,Administrator\nmchavez,192.168.10.133,Administrator\n</code></pre> <p>The <code>csv</code> file lives in the root of the <code>Haas_Data_collect</code> directory. This directory was shared as <code>Haas</code>. Once you map a drive, you can edit the file in Excel. Just remember to save it as a <code>csv</code> file, not an <code>Excel</code> file.</p>"},{"location":"build_pi_5_appliance/firewall_configuration/#the-available-roles","title":"The available roles","text":""},{"location":"build_pi_5_appliance/firewall_configuration/#user","title":"User","text":"<ul> <li>Access to Samba shares (port 445) only</li> </ul>"},{"location":"build_pi_5_appliance/firewall_configuration/#administrator","title":"Administrator","text":"<ul> <li>Access to Samba shares (port 445)</li> <li>SSH (22) access to manage the appliance</li> <li>Cockpit (9090) access for web management</li> </ul>"},{"location":"build_pi_5_appliance/firewall_configuration/#haas-machine-tools","title":"Haas Machine Tools","text":"<p>All Haas CNC machines authenticate using the <code>haassvc</code> account. The script can create rules to allow the CNC controls access to Samba from a dedicated subnet if your security policy requires segmentation.</p> <p>Haas machines (haassvc)</p> <ul> <li>Allowed from HAAS_MACHINES_SUBNET_V4 (and optionally v6) to 445/tcp</li> <li>You can narrow or expand that subnet as your manufacturing network dictates.</li> </ul> <p>In this example, the CNC machines are on <code>192.168.10.0/24</code>:</p> <pre><code>192.168.10.0/24 \u2192 port 445\n</code></pre>"},{"location":"build_pi_5_appliance/firewall_configuration/#modifying-the-haas-ip-address-range","title":"Modifying the Haas IP address range","text":"<p>If your machine tools are on a dedicated subnet</p>"},{"location":"build_pi_5_appliance/firewall_configuration/#additional-security-features","title":"Additional security features","text":"<p>The script includes the following features in addition to the firewall <code>allow/deny</code> rules</p>"},{"location":"build_pi_5_appliance/firewall_configuration/#netbios-is-blocked","title":"NetBIOS is blocked","text":"<ul> <li>Explicitly denies 137/udp, 138/udp, 139/tcp so nothing revives that old stack by accident.</li> </ul>"},{"location":"build_pi_5_appliance/firewall_configuration/#ssh-hardening","title":"SSH hardening","text":"<ul> <li>Uses <code>ufw limit 22/tcp</code> to rate\u2011limit repeated connection attempts.</li> </ul>"},{"location":"build_pi_5_appliance/firewall_configuration/#safe-defaults","title":"Safe defaults","text":"<ul> <li>deny incoming, allow outgoing</li> <li>Loopback allowed</li> </ul>"},{"location":"build_pi_5_appliance/firewall_configuration/#script-options","title":"Script Options","text":"<p>Enabling a firewall while you are connected over <code>ssh</code> can lead to tears, especially if you are not on site! That's because the firewall will read the rules and execute them immediately. If you block <code>ssh</code> from the IP address of your management station you will lose connection. The <code>dry-run</code> mode previews the rules instead of applying them. Review the rules carefully!</p> <p>If you applied the rules and just want to start over use reset mode to remove all rules at one time.</p> <p>Dry Run Mode</p> <p>Use <code>--dry-run</code> to preview all firewall changes without applying them.</p> <p>Reset Mode</p> <p>Use <code>--reset</code> to wipe all UFW rules and rebuild from the CSV.</p>"},{"location":"build_pi_5_appliance/firewall_configuration/#systemd-integration","title":"Systemd Integration","text":"<p>The firewall is automatically applied at boot via:</p> <pre><code>haas-firewall.service\n</code></pre> <p>A daily sync is handled by:</p> <pre><code>haas-firewall.timer\n</code></pre> <p>Note</p> <p>If you make a change to to the <code>csv</code> file and don't want to reboot or wait until the timer goes off you can run:</p> <p><code>sudo systemctl start haas-firewall.service</code></p>"},{"location":"build_pi_5_appliance/firewall_configuration/#logs","title":"Logs","text":"<p>All firewall actions are logged to:</p> <pre><code>/var/log/haas-firewall.log\n</code></pre> <p>Log rotation is configured to keep logs manageable.</p>"},{"location":"build_pi_5_appliance/firewall_configuration/#lets-build-the-firewall-system","title":"Let's build the firewall system","text":"<p>Several files are needed to build the rules, run a timer to make sure the firewall is reapplied if disabled, and log the output. Below is where they are placed in the appliance:</p> <pre><code>/usr/local/sbin/\n  configure_ufw_from_csv.sh\n\n/home/haas/Haas_Data_collect/\n  users.csv\n\n/etc/systemd/system/\n  haas-firewall.service\n  haas-firewall.timer\n\n/etc/logrotate.d/\n  haas-firewall\n</code></pre> <p>Note</p> <p>The script is stored in <code>/usr/local/sbin</code> which is a system level directory. The script should not need to be edited and to edit a file in <code>/usr/local/sbin</code> you need <code>root</code> privileges. You can use <code>sudo nano /usr/local/sbin/configure_uft_from_csv.sh</code> if you need to edit it.</p>"},{"location":"build_pi_5_appliance/firewall_configuration/#the-systemd-files","title":"The systemd files","text":"<p>In the root of the repository are the files needed to configure <code>systemd</code>. There is an installation script <code>install_haas_firewall.sh</code> that runs all of the commands below. If you want to fully understand how the firewall service works run the individual commands.</p>"},{"location":"build_pi_5_appliance/firewall_configuration/#automated-installation-of-the-firewall-service","title":"Automated installation of the <code>Firewall Service</code>","text":"<p>This script deletes <code>configure_ufw_from_csv.sh</code> after it copies it to <code>/usr/local/sbin/</code>. if you want to run it manually after the installation script use this command:</p> <pre><code>sudo /usr/local/sbin/configure_ufw_from_csv.sh\n</code></pre> <p>In the <code>Haas_Data_Collect</code> folder run the following:</p> <pre><code>sudo ./haas_firewall_install.sh\n</code></pre> <p>\u2b50 What this installer guarantees</p> <ul> <li>No partial installs \u2014 it aborts safely if anything is missing</li> <li>Script and validator are protected in /usr/local/sbin/</li> <li>Systemd is configured correctly</li> <li>Firewall rules apply at boot</li> <li>Daily timer provides self\u2011healing</li> <li>Customer directory stays clean (only users.csv remains)</li> </ul>"},{"location":"build_pi_5_appliance/firewall_configuration/#if-you-want-to-uninstall-the-firewall-service","title":"If you want to uninstall the <code>Firewall Service</code>","text":"<p>\ud83d\udfe6 Uninstaller Script (uninstall_haas_firewall.sh) This script safely removes:</p> <ul> <li>The systemd service</li> <li>The systemd timer</li> <li>The installed scripts in /usr/local/sbin/</li> <li>Reloads systemd</li> </ul> <p>Leaves the CSV untouched</p> <p>It also checks for file existence before removing anything.</p>"},{"location":"build_pi_5_appliance/firewall_configuration/#manual-installation","title":"Manual Installation","text":"<p>Copy the files to the correct location using</p> <pre><code>sudo cp haas-firewall.service /etc/systemd/system/\nsudo cp haas-firewall.timer /etc/systemd/system/\nsudo cp configure_ufw_from_csv.sh /usr/local/sbin/\nsudo chmod +x /usr/local/sbin/configure_ufw_from_csv.sh\n</code></pre> <p>There is no output from these command.</p>"},{"location":"build_pi_5_appliance/firewall_configuration/#delete-the-script-after-copying","title":"Delete the script after copying","text":"<p>Once the <code>configure_ufw_from_csv.sh</code> file is copied to <code>/usr/local/sbin</code> we will delete it from the project directory. This is to prevent accidental changes being made.</p> <pre><code>ls -l /usr/local/sbin/configure_ufw_from_csv.sh\n</code></pre> <p>If the file exits in <code>/usr/local/sbin</code>, then delete the copy in the <code>Haas_Data_collect</code> directory:</p> <pre><code>rm /home/haas/Haas_Data_collect/configure_ufw_from_csv.sh\n</code></pre> <p>There is no output from this command.</p>"},{"location":"build_pi_5_appliance/firewall_configuration/#reload-the-daemons-to-incorporate-the-changes","title":"Reload the daemons to incorporate the changes","text":"<pre><code>sudo systemctl daemon-reload\n</code></pre> <p>There is no output from this command.</p>"},{"location":"build_pi_5_appliance/firewall_configuration/#enable-and-start-the-firewall-service","title":"Enable and start the <code>firewall Service</code>","text":"<pre><code>sudo systemctl enable haas-firewall.service\nsudo systemctl start haas-firewall.service\nsystemctl status haas-firewall.service\n</code></pre>"},{"location":"build_pi_5_appliance/firewall_configuration/#enable-the-timer","title":"Enable the timer","text":"<pre><code>sudo systemctl enable --now haas-firewall.timer\n</code></pre> <p>There is no output from this command.</p> <p>Verify the timer service:</p> <pre><code>systemctl list-timers | grep haas-firewall\n</code></pre> Command Output<pre><code>Need output\n</code></pre>"},{"location":"build_pi_5_appliance/firewall_configuration/#the-bash-script-that-creates-the-rules","title":"The bash script that creates the rules","text":"<p>In the root of <code>Haas_Data_Collect</code> is a script named <code>configure_ufw_from_csv.sh</code> and a <code>csv</code> file named users.csv. The script reads the data in a <code>csv</code> file and creates the <code>Uncomplicated Firewall (UFW)</code> rules.</p> <p>make script executable. Run the following:</p> <pre><code>cd /home/haas/Haas_Data_collect/\nchmod +x configure_ufw_from_csv.sh\nls -l configure*\n</code></pre> Command Output<pre><code>.rwxrwxr-x 4.8k haas 11 Jan 19:54 \uf489 configure_ufw_from_csv.sh\n</code></pre>"},{"location":"build_pi_5_appliance/firewall_configuration/#the-dry-run-script-option","title":"The Dry-Run script option","text":"<p>The script lives in <code>/usr/local/sbin/</code> so it requires root access to run it manually. During deployment is it possible to run it manually with the dry-run option using the following:</p> <pre><code>sudo /usr/local/sbin/configure_ufw_from_csv.sh --dry-run\n</code></pre> <p>Dry run mode reads the users.csv file, processes it and then displays what would be configured for <code>UFW</code>.</p> <p>\ud83d\udfe7 Why is there a <code>dry-run</code> mode? This is extremely helpful when:</p> <ul> <li>testing new CSV formats</li> <li>debugging customer issues</li> <li>validating rule logic</li> <li>verifying backups and validation</li> </ul> <p>Here is what the output of the <code>dry-run</code> option looks like:</p> Command Output<pre><code>[*] Setting UFW base policy...\n[DRY-RUN] Would set IPV6=yes in /etc/default/ufw\n[DRY-RUN] ufw default deny incoming\n[DRY-RUN] ufw default allow outgoing\n[DRY-RUN] ufw allow in on lo\n[DRY-RUN] ufw allow out on lo\n[DRY-RUN] ufw limit 22/tcp\n[DRY-RUN] ufw deny 137/udp\n[DRY-RUN] ufw deny 138/udp\n[DRY-RUN] ufw deny 139/tcp\n[*] Creating rules for Haas machines (haassvc)...\n[DRY-RUN] ufw allow from 192.168.50.0/24 to any port 445 proto tcp comment 'Haas machines IPv4 -&gt; Samba'\n[*] Processing CSV: users.csv\n[*] Adding ADMIN 'haas' from 192.168.10.143\n[DRY-RUN] ufw allow from 192.168.10.143 to any port 445 proto tcp comment 'Admin haas -&gt; Samba'\n[DRY-RUN] ufw allow from 192.168.10.143 to any port 22 proto tcp comment 'Admin haas -&gt; SSH'\n[DRY-RUN] ufw allow from 192.168.10.143 to any port 9090 proto tcp comment 'Admin haas -&gt; Cockpit'\n[*] Adding USER 'haassvc' from 192.168.10.104\n[DRY-RUN] ufw allow from 192.168.10.104 to any port 445 proto tcp comment 'User haassvc -&gt; Samba'\n[*] Adding ADMIN 'haassvc2' from 192.168.10.120\n[DRY-RUN] ufw allow from 192.168.10.120 to any port 445 proto tcp comment 'Admin haassvc2 -&gt; Samba'\n[DRY-RUN] ufw allow from 192.168.10.120 to any port 22 proto tcp comment 'Admin haassvc2 -&gt; SSH'\n[DRY-RUN] ufw allow from 192.168.10.120 to any port 9090 proto tcp comment 'Admin haassvc2 -&gt; Cockpit'\n[*] Adding ADMIN 'rgoodwin' from 192.168.10.120\n[DRY-RUN] ufw allow from 192.168.10.120 to any port 445 proto tcp comment 'Admin rgoodwin -&gt; Samba'\n[DRY-RUN] ufw allow from 192.168.10.120 to any port 22 proto tcp comment 'Admin rgoodwin -&gt; SSH'\n[DRY-RUN] ufw allow from 192.168.10.120 to any port 9090 proto tcp comment 'Admin rgoodwin -&gt; Cockpit'\n[*] Adding ADMIN 'mchavez' from 192.168.10.223\n[DRY-RUN] ufw allow from 192.168.10.223 to any port 445 proto tcp comment 'Admin mchavez -&gt; Samba'\n[DRY-RUN] ufw allow from 192.168.10.223 to any port 22 proto tcp comment 'Admin mchavez -&gt; SSH'\n[DRY-RUN] ufw allow from 192.168.10.223 to any port 9090 proto tcp comment 'Admin mchavez -&gt; Cockpit'\n[DRY-RUN] Would enable UFW\n[DRY-RUN] Would show UFW status\n[*] Done.\n</code></pre>"},{"location":"build_pi_5_appliance/firewall_configuration/#custom-csv-file-option","title":"Custom <code>csv</code> file option","text":"<p>The default file name is users.csv. For testing, you can run  a different <code>csv</code> file using the following:</p> <pre><code>sudo /usr/local/sbin/configure_ufw_from_csv.sh /path/to/test.csv\n</code></pre>"},{"location":"build_pi_5_appliance/firewall_configuration/#cockpit-integration","title":"Cockpit Integration","text":"<p>Cockpit is a web-based graphical interface for servers, intended for everyone, especially those who are:</p> <ul> <li>new to Linux (including Windows admins)</li> <li>familiar with Linux and want an easy, graphical way to administer servers</li> <li>expert admins who mainly use other tools but want an overview on individual systems</li> </ul> <p>We\u2019ll create a Cockpit plugin that shows a simple page with three actions:</p> <ul> <li>Simulate Firewall Update (--dry-run)</li> <li>Compare Current vs Planned Rules (--compare)</li> <li>Rollback CSV from backup (prompts for backup filename)</li> </ul> <p>Cockpit directory structure</p> <p>/usr/share/cockpit/haas-firewall/ \u251c\u2500\u2500 manifest.json \u251c\u2500\u2500 index.html \u2514\u2500\u2500 haas-firewall.js \u2514\u2500\u2500 icon.png</p> <p>Create the directory:</p> <pre><code>sudo mkdir -p /usr/share/cockpit/haas-firewall\n</code></pre> <p>copy the files</p> <pre><code>sudo cp /home/haas/Haas_Data_collect/cockpit/* /usr/share/cockpit/haas-firewall/\n</code></pre> <p>sudo cp manifest.json /usr/share/cockpit/haas-firewall/ sudo cp index.html /usr/share/cockpit/haas-firewall/ sudo cp haas-firewall.js /usr/share/cockpit/haas-firewall/</p> <p>After placing these files, restart Cockpit:</p> <pre><code>sudo systemctl restart cockpit\n</code></pre> <p>Cockpit will pick it up automatically.</p> <p>Restart Cockpit</p> <pre><code>sudo systemctl restart cockpit\n</code></pre> <p>Your new buttons will appear instantly.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/","title":"Which version of Ubuntu should you use","text":"<p>Ubuntu comes in two versions:</p> <ul> <li>Server - No desktop.</li> <li>Desktop - Includes the Gnome desktop</li> </ul>"},{"location":"build_pi_5_appliance/installing_ubuntu/#server-version-headless","title":"Server version (Headless)","text":"<p>I am experienced with Ubuntu, and this is a personal device; the headless server version is my choice. I use SSH to manage the appliance and the scripts don't require the Gnome desktop. The server uses fewer resources since it doesn't run a desktop.</p> <p>You can connect a monitor and keyboard, but you still use terminal-only tools since the desktop isn't installed. To copy files off the server to another PC, you can use SCP. On a Windows client, the popular <code>putty</code> application has an SCP client. Ubuntu 24.04 has the OpenSSH client built in.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#serial-console-cable","title":"Serial Console cable","text":"<p>If you are building your appliance on a Raspberry Pi 5, I recommend purchasing the serial console cable. It allows you to configure the Pi from your laptop if the Pi doesn't have an IP Address or you have locked yourself out with the firewall.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#desktop-version","title":"Desktop Version","text":"<p>If you are new to Linux and building appliances, use the desktop version. The desktop version of Ubuntu uses the GNOME desktop, which is similar to a Windows desktop. It includes LibreOffice Calc (spreadsheet), allowing you to manage the firewall configuration file from the appliance.</p> <p>With the desktop version, you can use a keyboard, mouse, and monitor (KVM) to configure the Pi using GUI tools like Gnome Text Editor, File Manager, Local Send, etc. Local Send is a free, open-source Flatpak app that allows you to move files between two systems. It supports Windows, Mac, Linux, Android, and iOS. On a Windows client, the popular <code>putty</code> application has an SCP client.</p> <p>The other advantage is that you can register with Canonical for Ubuntu Pro at $25/year vs. $300/year for the server version. The Ubuntu Pro is a great deal. You get automatic updates and most do not require a reboot. The appliance will stay patched for at least one quarter with no user intervention.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#installation","title":"Installation","text":"<p>The steps to install Ubuntu on a Raspberry Pi 5 with an NVME drive are different than installing on an Intel PC or virtual machine.</p> <p>During the installation on a Raspberry Pi 5 or Intel box:</p> <ul> <li>Use <code>haas</code> as the username, all lowercase, and use a simple password that you can type with both hands on the keyboard. You will be typing the password a lot during the creation of the appliance.</li> <li>Use <code>haas</code> as the hostname, all lowercase. You can use anything, but the examples use <code>haas</code>.</li> </ul> <p>The code in the rest of the setup expects the username to be haas, which creates a home directory at /home/haas, used in all the examples in the guide. When the appliance is ready for production, change the password to a long and complex password. Save it in a password manager so that you don't forget it.</p> <p>For ease of logging into the appliance, create ssh keys as shown here - Use SSH Keys.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#raspberry-pi-5-install","title":"Raspberry Pi 5 install","text":"<p>Once you have decided on a version, follow these instructions to complete the installation. The instructions are from the Wolf Paulus blog, he does a great job, and I didn't see that I could do any better!</p> <p>Regardless of which version you want for production, install the desktop version of Raspberry Pi OS for the first step.</p> <ul> <li>Raspberry Pi 5 with NVMe</li> <li>Install Ubuntu Server on Raspberry Pi 5 with NVMe SSD (Headless Setup)</li> </ul> <p>Note</p> <p>Read the instructions below before you do the install to the nvme drive.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#copy-files-to-a-pc","title":"Copy files to a PC","text":"<p>As stated in the Wolf Paulus blog, you need to copy files off the Raspberry Pi 5 before installing Ubuntu to the NVME drive. You can copy the cmdline.txt, network-config, user-data files to a flash drive or use scp to a laptop.</p> <p>To copy from the RPi to my laptop at 192.168.10.138</p> <ul> <li>scp /boot/firmware/user-data mhubbard@192.168.19.138:/home/mhubbard/Downloads</li> <li>scp /boot/firmware/network-config mhubbard@192.168.19.138:/home/mhubbard/Downloads</li> <li>scp /boot/firmware/cmdline.txt mhubbard@192.168.19.138:/home/mhubbard/Downloads</li> </ul>"},{"location":"build_pi_5_appliance/installing_ubuntu/#copy-back-to-the-pi","title":"Copy back to the Pi","text":"<p>After Ubuntu is installed, but before booting for the first time:</p> <ul> <li>sudo scp mhubbard@192.168.19.138:/home/mhubbard/Downloads/user-data /mnt/nvfat</li> <li>sudo scp mhubbard@192.168.19.138:/home/mhubbard/Downloads/network-config /mnt/nvfat</li> <li>sudo scp mhubbard@192.168.19.138:/home/mhubbard/Downloads/cmdline.txt /mnt/nvfat</li> </ul>"},{"location":"build_pi_5_appliance/installing_ubuntu/#ubuntu-is-version-24043-now","title":"Ubuntu is version 24.04.3 now","text":"<p>Below are updated links to <code>wget</code> 24.04.3.</p> <p>Server installer</p> <pre><code>cd ~\nwget https://cdimage.ubuntu.com/releases/24.04.3/release/ubuntu-24.04.3-preinstalled-server-arm64+raspi.img.xz`.\n</code></pre> <p>Desktop installer</p> <pre><code>cd ~\n`wget https://cdimage.ubuntu.com/releases/24.04.3/release/ubuntu-24.04.3-preinstalled-desktop-arm64+raspi.img.xz`\n</code></pre>"},{"location":"build_pi_5_appliance/installing_ubuntu/#intel-install","title":"Intel install","text":"<p>Just like for the Raspberry Pi 5, there are a lot of quality tutorials on installing Ubuntu 24.04. I'm not going to document that in this guide.</p> <p>Server Install Here is a link to the official Canonical tutorial - Install Ubuntu server</p> <p>If you need instructions to create a bootable flash drive - Open the Desktop link below and it explains how to use Rufus to create a flash drive. For a virtual machine you will use the ISO image that you downloaded.</p> <p>Desktop install Here is a link to the official Canonical tutorial - Install Ubuntu Desktop</p> <p>When you get to this screen:</p> <p></p> <p>Select <code>Install Ubuntu</code> and click <code>next</code>.</p> <p>Note</p> <p>From here on out the steps apply whether you installing on an Raspberry Pi 5 or an Intel based devices.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#configure-nano","title":"Configure Nano","text":"<p>Nano is a terminal text editor built into most Linux distributions and you will need to use it initially, so it's worth spending a couple minutes customizing it. From the terminal run:</p> <pre><code>nano ~/.nanorc\n</code></pre> <p>Note hte <code>dot</code> in front of the file. In Mac/Linux that means it's a hidden file. You must include the do or nano won't read it.</p> <p>Paste the following into the file:</p> <pre><code>set autoindent\nset historylog\nset linenumbers\nset regexp\nset smarthome\nset tabsize 4\nset tabstospaces\ninclude \"/usr/share/nano/awk.nanorc\"\ninclude \"/usr/share/nano/css.nanorc\"\ninclude \"/usr/share/nano/html.nanorc\"\ninclude \"/usr/share/nano/man.nanorc\"\ninclude \"/usr/share/nano/nanorc.nanorc\"\ninclude \"/usr/share/nano/python.nanorc\"\ninclude \"/usr/share/nano/sh.nanorc\"\ninclude \"/usr/share/nano/tcl.nanorc\"\ninclude \"/usr/share/nano/xml.nanorc\"\ninclude \"/usr/share/nano/yaml.nanorc\"\n</code></pre> <p>Press <code>ctrl+s</code> and <code>ctrl+x</code> to save and exit.</p> <p>Now when you open Nano it will <code>lint</code> (colorize) bash scripts, python, xml, html, man pages, etc. You can use <code>ls -l /usr/share/nano/*rc</code> to view all of the file types that Nano supports.</p> <p>This also sets:</p> <ul> <li>autoindent - automatically indent a newly created line to the same level of indentation (tabs and/or spaces) as the previous line.</li> <li>historylog - Save the last hundred search strings and replacement strings and executed commands, so they can be easily reused in later sessions.</li> <li>linenumbers - Display line numbers to the left of the text area.</li> <li>regexp - Do extended regular expression searches by default.</li> <li>smarthome - Make the Home key smarter. When Home is pressed anywhere but at the very beginning of non-whitespace characters on a line, the cursor will jump to that beginning (either forwards or backwards). If the cursor is already at that position, it will jump to the true beginning of the line.</li> <li>tabsize 4 - Use a tab size of number columns.</li> <li>tabstospaces - Convert typed tabs to spaces.</li> </ul> <p>Here is a screenshot of an Ubuntu server <code>netplan</code> yaml file after the nano updates:</p> <p></p> <p>You can find a detailed list of <code>nanorc</code> options at NANORC</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#change-the-shell-to-zsh","title":"Change the shell to zsh","text":"<p>When the Ubuntu installation is complete and you have rebooted, follow these instructions to configure the terminal for ease of use. I wrote that procedure on Ubuntu 18.04 and have updated it as versions have changed. It will make the appliance's  terminal use much easier.</p> <p>If you skip this step, not recommended, replace <code>.zshrc</code> with <code>.bashrc</code> where you see it in the documentation.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#static-ip-address","title":"Static IP address","text":"<p>The desktop version uses a GUI to change IP address configuration. Go to the system menu, which is accessible from the top-right screen corner, click the gear icon, then network. The network settings dialog is very similar to Windows 11. Here is a screenshot:</p> <p></p> <p>Ubuntu server doesn't have a GUI to change IP address settings. You have to modify a <code>yaml</code> file in the <code>/etc/netplan</code> directory. On the server version to use a static IP address instead of DHCP, replace <code>/etc/netplan/91-nw-init.yaml</code> with this yaml file:</p> <pre><code>network:\n  version: 2\n  renderer: networkd\n  ethernets:\n    eth0:\n      dhcp4: no\n      dhcp6: true\n      addresses:\n        - 192.168.1.100/24\n      routes:\n        - to: default\n          via: 192.168.1.254\n      nameservers:\n        addresses:\n          - 192.168.10.222\n          - 192.168.1.222\n      parameters:\n        stp: false\n        forward-delay: 0\n</code></pre> <ul> <li>Replace eth0 with the actual interface name (use ip link to find it, often eth0 or enp1s0 on Pi 5)</li> <li>Replace 192.168.1.100/24 with the desired static IP and subnet</li> <li>Replace 192.168.1.1 with the actual gateway IP</li> <li>Replace DNS servers (8.8.8.8, 8.8.4.4) with appropriate ones for the shop network</li> <li>The stp: false and forward-delay: 0 parameters disable Spanning Tree Protocol and reduce network startup delay</li> </ul> <p>In general, do not use a public DNS server address. Your company security policy SHOULD require you to use their DNS Server or Proxy server. Bypassing either could allow the appliance to contact a <code>control and command C2</code> server on the Internet without detection!</p> <p>Use <code>ip link</code> to find the actual interface name on your device. As you can see the interface is <code>eth0</code>. On an Intel installation it will probably be something like <code>enp60s0</code> on physical hardware or <code>ens33</code> on a virtual installation. Here is the output on my Raspberry Pi 5 with Ubuntu server 24.04.3.</p> <pre><code>ip link\n</code></pre> Command Output<pre><code>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000\n    link/ether 88:a2:9e:43:4d:de brd ff:ff:ff:ff:ff:ff\n3: wlan0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DORMANT group default qlen 1000\n    link/ether 88:a2:9e:43:4d:df brd ff:ff:ff:ff:ff:ff\n</code></pre> <p>Use the following code to create a backup and then edit the yaml file:</p> <pre><code>cd /etc/netplan/\nls -l # look for a yaml file\nsudo cp /etc/netplan/91-nw-init.yaml /etc/netplan/91-nw-init.bak\nls -l # look for the backup file\nsudo nano /etc/netplan/91-nw-init.yaml\n</code></pre> <p>Replace the <code>91-nw-init.yaml</code> with the name of the file you find with the <code>ls -l</code> command.</p> <p>Note</p> <p>The yaml file might not be named \"91-nw-init.yaml\" depending on the version you install. If that is the case, substitute the actual filename. On the server version the file should be named <code>50-cloud-init.yaml</code>.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#apply-the-configuration","title":"Apply the configuration","text":"<p>Yaml is very particular about indentation. Ubuntu provides <code>netplan try</code> that will show any errors in the yaml file.</p> <pre><code># This is all you really need:\nsudo netplan generate\nsudo netplan try\nsudo netplan apply\n</code></pre>"},{"location":"build_pi_5_appliance/installing_ubuntu/#verify-the-configuration","title":"Verify the configuration","text":"<pre><code>ip addr show eth0\nip route show\n</code></pre>"},{"location":"build_pi_5_appliance/installing_ubuntu/#show-the-processor","title":"Show the processor","text":"<p>The Raspberry Pi uses <code>Advanced RISC Machine (ARM)</code> architecture vs the Intel x86 in your laptop. You can use the standard Linux command `List CPU - lscpu' to display the CPU in your device:</p> <pre><code>lscpu\n</code></pre> Command Output<pre><code>Architecture:             aarch64\n  CPU op-mode(s):         32-bit, 64-bit\n  Byte Order:             Little Endian\nCPU(s):                   4\n  On-line CPU(s) list:    0-3\nVendor ID:                ARM\n  Model name:             Cortex-A76\n    Model:                1\n    Thread(s) per core:   1\n    Core(s) per cluster:  4\n    Socket(s):            -\n    Cluster(s):           1\n    Stepping:             r4p1\n    CPU(s) scaling MHz:   62%\n    CPU max MHz:          2400.0000\n    CPU min MHz:          1500.0000\n    BogoMIPS:             108.00\n</code></pre> <p>In this example I ran it on an Raspberry Pi 5.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#linux-list-commands","title":"Linux List commands","text":"<p>You can get a list of all <code>ls</code> commands by typying <code>ls</code> and pressing <code>tab</code>. You can google or use <code>man lscommand</code> to see help on any ls command. Some useful <code>ls</code> commands:</p> <ul> <li>ls - list files in current directory</li> <li>lsattr - list file attributes on a Linux extended file system</li> <li>lsblk - list block storage devices line SD cards, USB Flash Drives, NVMEs.</li> <li>lsb_release - the <code>-a</code> option displays all information about a release.</li> <li>lshw - list hardware - A detailed list of installed hardware.</li> <li>lslocks - list local system locks</li> <li>lsof - list open files. example sudo lsof -i -n | grep localsend to see the PID and IPv4 info.</li> <li>lsusb - list all USB devices</li> </ul> <p>procs - not an ls command but very userful - example <code>procs localsend</code> will show the <code>localsend</code> app's PID, CPU/Mem data, filepath</p> <pre><code>procs localsend\n PID:\u25b2  User     \u2502 TTY CPU MEM CPU Time \u2502 Command\n                 \u2502     [%] [%]          \u2502\n 515639 mhubbard \u2502     0.0 0.2 08:02:59 \u2502 /snap/localsend/32/usr/share/localsend_app/localsend_app\n</code></pre>"},{"location":"build_pi_5_appliance/installing_ubuntu/#use-ssh-keys","title":"Use SSH keys","text":"<p>Ubuntu supports using ssh keys instead of usernames/passwords for logging in over ssh. The advantage is that it's near impossible to brute force ssh keys compared to brute forcing a password. You can create more than one set of keys to be used with the appliance. If you have an MSP/MSSP that manages servers, you can create a set of keys for their use. If you ever replace them, you just delete their key on the appliance and they can no longer log in.</p> <p>The process to create ssh keys is very similar on Mac/Windows/Linux and will take less than 5 minutes to set it up.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#windows-11-25h2","title":"Windows 11 25H2","text":"<p>Windows 11 includes the OpenSSH package now. The command to create a key pair is the same as on Linux or Mac. Open the PowerShell terminal and enter the following to create an ed255519 key pair.:</p> <pre><code>cd .ssh\nPS C:\\Users\\mhubbard.PU\\.ssh&gt; ssh-keygen -C Haas\n</code></pre> Command Output<pre><code>Generating public/private ed25519 key pair.\nEnter file in which to save the key (C:\\Users\\mhubbard.PU/.ssh/id_ed25519): id_haas\nid_haas already exists.\nOverwrite (y/n)? y\nEnter passphrase (empty for no passphrase):\nEnter same passphrase again:\nYour identification has been saved in id_haas\nYour public key has been saved in id_haas.pub\nThe key fingerprint is:\nSHA256:h6lAMwPk2aF6M66kN5p11KBNCFL5NJfRjCbcytYRnaU Haas\nThe key's randomart image is:\n+--[ED25519 256]--+\n|oo+o..oO o.      |\n|.o.*=.B =.       |\n|  =+OB .E        |\n| . ==*.  o       |\n|. =.+ . S .      |\n| o + . . .       |\n| .o . .          |\n|o+o.             |\n|=o .             |\n+----[SHA256]-----+\n</code></pre> <p>Notice that I changed the key name to:</p> <p><code>id_haas</code></p> <p>This isn't strictly necessary but I like to name my keys since I uses ssh with keys to log into many different systems.</p> <p>I also entered a passphrase for the keys. When logging in using the <code>id_haas</code> private key, you will be prompted to enter the passphrase. Why would I use a passphrase when I just said that keys are hard to brute force?</p> <p>Keys are difficult to brute force, but if you forget to lock your workstation and walk away someone can copy the private key from <code>C:\\Users\\mhubbard.PU/.ssh</code> and then log in with out being prompted. The passphrase is a way to prevent that. I don't use a long, complex, impossible to type passphrase but it's random characters that would take some time to brute force with <code>Hashcat</code> or <code>John the Ripper</code>.</p> <p>I wrote a PowerShell script a while back that I keep on a flash drive. If a user forgets to lock their workstation this script will search every drive for <code>Keepass database files</code> and copy them to the flash drive. It could easily be modified to copy private keys now that  Microsoft supports ssh. I wrote the script as an educational tool so show people what can happen if they don't lock their workstations when they walk away. Think \"working in a coffee shop and running to the bathroom\".</p> <p>The <code>-c Haas</code> in the <code>ssh-keygen</code> command creates a comment for the comment that is stored with the key.</p> <ul> <li>-l - Show  fingerprint  of specified public key file. If combined with -v, a visual ASCII art representation of the key is supplied with the fingerprint.</li> </ul> <p>Run this command to view the hey's fingerprint:</p> <pre><code>ssh-keygen -l -f id_haas -v\n</code></pre> Command Output<pre><code>256 SHA256:h6lAMwPk2aF6M66kN5p11KBNCFL5NJfRjCbcytYRnaU Haas (ED25519)\n+--[ED25519 256]--+\n|oo+o..oO o.      |\n|.o.*=.B =.       |\n|  =+OB .E        |\n| . ==*.  o       |\n|. =.+ . S .      |\n| o + . . .       |\n| .o . .          |\n|o+o.             |\n|=o .             |\n+----[SHA256]-----+\n</code></pre>"},{"location":"build_pi_5_appliance/installing_ubuntu/#copy-the-key","title":"Copy the key","text":"<p>Windows didn't implement the <code>ssh-copy-id</code> script from the OpenSSH project for some reason. Here is how to use PowerShell to copy the key to the appliance:</p> <pre><code>PS C:\\Users\\mhubbard.PU&gt; type $env:USERPROFILE\\.ssh\\id_haas.pub | ssh -p 3333 haas@192.168.10.127 \"mkdir -p ~/.ssh &amp;&amp; cat &gt;&gt; ~/.ssh/authorized_keys &amp;&amp; chmod 600 ~/.ssh/authorized_keys &amp;&amp; chmod 700 ~/.ssh\"\n</code></pre> Command Output<pre><code>The authenticity of host '[192.168.10.127]:3333 ([192.168.10.127]:3333)' can't be established.\nED25519 key fingerprint is SHA256:0/RO4plpIpA6dw7EASpfdACx5KmqXT19oUjlyIRmffs.\nThis key is not known by any other names.\nAre you sure you want to continue connecting (yes/no/[fingerprint])? yes\nWarning: Permanently added '[192.168.10.127]:3333' (ED25519) to the list of known hosts.\n\nhaas@192.168.10.127's password:\n</code></pre> <p>The <code>$env:USERPROFILE\\</code> expands out to your full user path.</p> <p>I had to use <code>-p 3333</code> because I had changed the port that is used for ssh.</p> <p>The message about `The authenticity of host can't be established is because the appliance has a set of ssh keys and it offered its key to the W11 box. If you logged in initially with a password you could run:</p> <pre><code>ssh-keygen -l -f /etc/ssh/ssh_host_ed25519_key.pub\n</code></pre> Command Output<pre><code>256 SHA256:0/RO4plpIpA6dw7EASpfdACx5KmqXT19oUjlyIRmffs root@haas (ED25519)\n</code></pre> <p>To verity that you are indeed copying the keys to the appliance.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#view-the-comment","title":"View the comment","text":"<p>On the appliance, run:</p> <pre><code>cat ~/.ssh/authorized_keys\n</code></pre> Command Output<pre><code>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIe4VtZB4+t8LAWPLT54qMWRI5NgwIU7/SoIMYtWl4Tu Haas\nssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBt1FUYKmKsS98KZBEjLSdg95dCTydiB54SeNAAt2V7m Haas-223\n</code></pre> <p>You will see the comment at the end of the key. It makes identifying keys easier if you manage many servers. The second key <code>Haas-223</code> is a key from another device that has an IP ending in .223. You can make up a convention if you adopt using keys.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#linuxmac","title":"Linux/Mac","text":"<p>Open the terminal and enter the following to create an ed255519 key pair.:</p> <pre><code>ssh-keygen\n</code></pre> Command Output<pre><code>Generating public/private ed25519 key pair.\nEnter file in which to save the key (/home/mhubbard/.ssh/id_ed25519): id_haas\nEnter passphrase for \"haas\" (empty for no passphrase):\nEnter same passphrase again:\nYour identification has been saved in haas\nYour public key has been saved in haas.pub\nThe key fingerprint is:\nSHA256:OzzMu5XQjcXeG5Rks2hV2tSZ/jFq8QoPeTJy/w9QkgI\nThe key's randomart image is:\n+--[ED25519 256]--+\n|        E     =.*|\n|         . . * X.|\n|          . B B .|\n|         . B * + |\n|        S o = * +|\n|       + + O = +.|\n|        B = X +  |\n|         =   + . |\n|        o.    ..o|\n+----[SHA256]-----+\n</code></pre> <p>Notice that I changed the key name to:</p> <p><code>/home/mhubbard/.ssh/haas</code></p> <p>This isn't strictly necessary but I like to name my keys since I uses ssh with keys to log into many different systems. Also notice that I entered a passphrase for the keys. When logging in using the <code>id_haas</code> private key, you will be prompted to enter the passphrase. Why would I use a passphrase when I just said that keys are hard to brute force?</p> <p>Keys are difficult to brute force, but if you forget to lock your workstation and walk away someone can copy the private key from <code>C:\\Users\\mhubbard.PU/.ssh</code> and then log in with out being prompted. The passphrase is a way to prevent that. I don't use a long, complex, impossible to type passphrase but it's random characters that would take some time to brute force with <code>Hashcat</code> or <code>John the Ripper</code>.</p> <p>I wrote a PowerShell script a while back that I keep on a flash drive. If a user forgets to lock their workstation this script will search every drive for <code>Keepass database files</code> and copy them to the flash drive. It could easily be modified to copy private keys now that  Microsoft supports ssh. I wrote the script as an educational tool so show people what can happen if they don't lock their workstations when they walk away. Think \"working in a coffee shop and running to the bathroom\".</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#copy-the-key-over","title":"Copy the key over","text":"<p>Linux and Mac support the OpenSSH tool <code>ssh-copy-id</code>for moving the public key to a host. Run the following:</p> <pre><code>ssh-copy-id -i ~/.ssh/haas.pub -p 3333 haas@192.168.10.127\n</code></pre> Command Output<pre><code>/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: \"/home/mhubbard/.ssh/haas.pub\"\n/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed\n/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys\n\n\nhaas@192.168.10.127's password:\n\nNumber of key(s) added: 1\n\nNow try logging into the machine, with: \"ssh -i /home/mhubbard/.ssh/haas -p 3333 'haas@192.168.10.127'\"\nand check to make sure that only the key(s) you wanted were added.\n</code></pre> <p>The <code>-i</code> is used to name the key to copy. Since I have many public keys on this system I had to explicitly name the key to copy.</p> <p>I had to use <code>-p 3333</code> because I had changed the port that is used for ssh.</p> <p>The message \"Now try logging into the machine...\" is because even though you see the pre-login banner and enter the password, you don't have a user login. Once the key is copied, the session ends.</p> <p>The message about `The authenticity of host can't be established is because the appliance has a set of ssh keys and it offered its key to the W11 box. If you logged in initially with a password you could run:</p> <pre><code>ssh-keygen -l -f /etc/ssh/ssh_host_ed25519_key.pub\n</code></pre> Command Output<pre><code>256 SHA256:0/RO4plpIpA6dw7EASpfdACx5KmqXT19oUjlyIRmffs root@haas (ED25519)\n</code></pre> <p>To verity that you are indeed copying the keys to the appliance.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#view-the-key-comment","title":"View the key comment","text":"<p>On the appliance, run:</p> <pre><code>cat ~/.ssh/authorized_keys\n</code></pre> Command Output<pre><code>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIe4VtZB4+t8LAWPLT54qMWRI5NgwIU7/SoIMYtWl4Tu Haas\nssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBt1FUYKmKsS98KZBEjLSdg95dCTydiB54SeNAAt2V7m Haas-223\n</code></pre> <p>You will see the comment at the end of the key. It makes identifying keys easier if you manage many servers. The second key <code>Haas-223</code> is a key from another device that has an IP ending in .223. You can make up a convention if you adopt using keys.</p> <p>If you try to login now</p> <pre><code>ssh -i /home/mhubbard/.ssh/haas -p 3333 'haas@192.168.10.127'\n</code></pre> <p>You will be asked for the passphrase, then logged into the appliance.</p> <p>I can log in without including the <code>-i /home/mhubbard/.ssh/haas</code> and the ssh client will try all of the keys in <code>~/.ssh</code> directory until it finds a match. But that will add a significant delay since I have a lot of keys. After you type the command to login once it will be in your history so you don't have to type all of it.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#create-an-alias","title":"create an alias","text":"<pre><code>nano ~/.bashrc\nalias haas=\"ssh -i /home/mhubbard/.ssh/haas -p 3333 'haas@192.168.10.127'\"\n</code></pre> <p>Press <code>ctrl+s</code> and <code>ctrl+x</code> to save and exit. Then run:</p> <pre><code>exec bash\n</code></pre> <p>to reload the shell. Now you type <code>haas</code> and log in!</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#hardware-security-modules-hsm","title":"Hardware Security Modules (HSM)","text":"<p>Companies like <code>Yubico</code> and <code>Google</code> offer hardware keys to store your ssh private keys on. They are out of scope for this document, but you can go to Yubico Security Key and read up. One caution, if you lose the HSM and didn't make a backup it's a bad day. Just saying...</p> <p>You may want to buy two HSMs and keep one locked in a safe place.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#use-ipv6","title":"Use IPv6","text":"<p>If you don't mind learning a little IPv6, you can SSH to the Pi over IPv6 even if it doesn't have an IPv4 address. This is only for the initial configuration of Ubuntu. Once you run the <code>haas_firewall_install.sh</code> script you are limited to IPv4. The reason is that the <code>configure_ufw_from_csv.sh</code> script doesn't support IPv6 for Administrators. As my dad used to say \"Son, you ran out of talent on that one.\" I plan to add it in the future if there is demand for the feature.</p> <p>If you followed the Paulus blog, add <code>dhcp6: true</code> to the netplan yaml file</p> <pre><code>network:\n  version: 2\n  ethernets:\n    eth0:\n      dhcp4: true\n      optional: true\n      dhcp6: true\n</code></pre> <p>Use the following to find the IPv6 address:</p> <pre><code>ip a show dev eth0\n</code></pre> Command Output<pre><code>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 88:a2:9e:43:4d:de brd ff:ff:ff:ff:ff:ff\n    inet 192.168.10.137/24 metric 100 brd 192.168.10.255 scope global dynamic eth0\n       valid_lft 28463sec preferred_lft 28463sec\n    inet6 fe80::8aa2:9eff:fe43:4dde/64 scope link\n       valid_lft forever preferred_lft forever\n</code></pre> <p>The <code>fe80::8aa2:9eff:fe43:4dde</code> is an IPv6 <code>link local</code> address. It's similar to an IPv4 APIPA, but it's the same every time the device starts up. It is created using the EUI-64 format, which is based on the 48-bit MAC address.</p> <p>Note</p> <p>The EUI-64 (Extended Unique Identifier) format is a 64-bit interface identifier used in IPv6 to automatically generate host addresses from a 48-bit MAC address. This process involves splitting the MAC address, inserting FFFE in the middle, and flipping the 7th bit (universal/local bit) of the first byte.</p> <p>What flipping the 7th bit looks like:</p> <pre><code>10001000 \u2192 10001010\n                 ^\n                flipped b7\n88 \u2192 8A\n</code></pre>"},{"location":"build_pi_5_appliance/installing_ubuntu/#how-to-ssh-to-this-ipv6-address","title":"How to ssh to this IPv6 address","text":"<p>macOS wireless interface en0 Use the following command to ssh from a MacBook:</p> <pre><code>ssh haas@fe80::8aa2:9eff:fe43:4dde%en0\n</code></pre> <p>Linux with wireless interface wlp61s0 Use the following command to ssh from a Linux laptop:</p> <pre><code>ssh haas@fe80::8aa2:9eff:fe43:4dde%wlp61s0\n</code></pre> <p>Windows Use these commands to ssh from a Windows laptop:</p> <pre><code>netsh interface ipv6 show interfaces\n</code></pre> Command Output<pre><code>Idx     Met         MTU          State                Name\n---  ----------  ----------  ------------  ---------------------------\n  5          25        1500  connected     Ethernet\n 12          25        1500  connected     Wi-Fi\n</code></pre> <p>Now use:</p> <pre><code>ssh haas@[fe80::8aa2:9eff:fe43:4dde%5]\n</code></pre> <p>Warning</p> <p>Windows Wi-Fi interface don't support <code>IPv6 Neighbor Discovery</code> reliably. If you want to use this method, connect your laptop to ethernet.</p> <p>You can use the following command to see if the Raspberry Pi 5 is visble from a Windows machine:</p> <pre><code>netsh interface ipv6 show neighbors | Select-String \"4dde\"\n</code></pre> <p>As always, Windows uses a non-standard method for an industry standard\ud83d\ude41.</p>"},{"location":"build_pi_5_appliance/installing_ubuntu/#ipv6-link-local-addresses","title":"IPv6 Link Local addresses","text":"<p>IPv6 link\u2011local + EUI\u201164 is the industry standard for zero\u2011touch provisioning. Switches, routers, firewalls, PDUs, storage arrays, OT gear \u2014 they all do it.</p> <p>And Linux handles it flawlessly.</p> <p>Windows is the outlier.</p> <p>\ud83e\udde9 Why IPv6 link\u2011local + EUI\u201164 is brilliant</p> <ul> <li>Every NIC has a MAC</li> <li>EUI\u201164 turns that MAC into a deterministic IPv6 address</li> <li>You can derive the link\u2011local address instantly</li> <li>No DHCP</li> <li>No RA (IPv6 Router Advertisement)</li> <li>No SLAAC (Stateless Address Autoconfiguration)</li> <li>No guessing</li> <li>No APIPA garbage</li> <li>No vendor\u2011specific discovery tools</li> <li>No proprietary protocols</li> <li>No broadcast storms</li> <li>No \u201cmagic IP\u201d like 192.168.1.1</li> <li>It\u2019s elegant.</li> <li>It\u2019s predictable.</li> <li>It\u2019s universal.</li> <li>It\u2019s how IPv6 was meant to be used.</li> </ul>"},{"location":"build_pi_5_appliance/securing_appliance/","title":"Securing the Appliance","text":"<p>The appliance is running on Ubuntu 24.04 which has many security features that Canonical has learned from being a very popular Internet Web server OS. Since the Raspberry Pi 5 appliance is only meant to transfer files to/from the Haas CNC control and the programmers, and connect to the Haas CNC controls using a redefined port and IP address to collect data, we can lock it down using local user accounts, file permissions, share permissions and the Uncomplicated Firewall (UFW).</p> <p>In addition to the Haas CNC ports we define, the Raspberry Pi 5 appliance needs to have SSH exposed to the customer user that is responsible for management of the appliance. Ubuntu 24.04 ships with OpenSSH 9.6 which has removed ssh-dss and made many other legacy protocols optional.You can verify the version using:</p> <pre><code>ssh -V\n</code></pre> Command Output<pre><code>OpenSSH_9.6p1 Ubuntu-3ubuntu13.14, OpenSSL 3.0.13 30 Jan 2024\n</code></pre>"},{"location":"build_pi_5_appliance/why_pi_5_appliance/","title":"Use an appliance for the scripts","text":"<p>Why would you want to build a dedicated appliance when the Python scripts will run on Windows? A couple of reasons jump out:</p> <ul> <li>The scripts need to be running anytime the shop is working.</li> <li>You will need to have shares available for the files to be copied</li> </ul> <p>The first reason means that a Windows computer would have to be up and running 24/7 with a user logged in. I don't think that many IT security teams would find that acceptable. A cyber attack is most likely when a PC is powered on, a user is logged in and the user has gone home. If the scripts are on a user's Windows desktop and they shut down in the evening or over weekends/holidays, data won't be collected.</p> <p>The workaround to a user being logged in is to use a tool like <code>NSSM (Non-Sucking Service Manager)</code> to install the script as a service. I researched <code>NSSM</code> and it appears to be abandoned, so no security updates will be produced. My Haas scripts use standard Python libraries that will get updated anytime you update Python. There are a few other ways to run Python as a service on Windows, but you would still have to have a machine running 24/7, so the Pi is a less expensive method. The attack surface of a hardened Linux appliance is smaller than a Windows 11 desktop.</p> <p>The second reason means creating file shares on the Windows computer that the scripts are running on. I have had a lot of wasted time in small shops making their MSP understand what is needed (a user account, the shares, security groups, etc.) and getting it done while I'm onsite. Plus, creating shares on a personal workstation may violate IT security policy.</p> <p>An appliance solves both of these problems:</p> <ul> <li>Ubuntu is a well supported Operating System for appliances.</li> <li>It can run 24/7 in the shop or in the server closet with no one logged in.</li> <li>Creating a service that starts during boot is easy to do with Ubuntu.</li> <li>Ubuntu has a long track record of security in the enterprise.</li> </ul> <p>You will still need to discuss the appliance with the IT security team, but it resolves most concerns that IT or the security team will have. The appliance uses the Ubuntu UFW firewall and has SMB V1, NetBIOS disabled.</p> <p>See Appendix A - Securing the Appliance for details on the security used. Red Hat Cockpit is used to manage the appliance, so applying security updates and verifying firewall status is accomplished in a GUI.</p>"},{"location":"build_pi_5_appliance/why_pi_5_appliance/#what-hardware-is-needed","title":"What hardware is needed","text":"<p>The scripts do not require massive processor power. 8GB of RAM, a 256GB NVME drive and an Ethernet port are all that are needed.</p>"},{"location":"build_pi_5_appliance/why_pi_5_appliance/#raspberry-pi-5","title":"Raspberry Pi 5","text":"<p>Raspberry Pis have become popular for industrial applications. They are inexpensive, reliable, and have a massive community of blogs, YouTube videos, and magazine articles supporting them. Here is a link to Raspberry Pi for Industry on the official Raspberry Pi site. The Raspberry Pi 5 with 8GB of RAM is more than enough power to run the scripts and create the data files.</p>"},{"location":"build_pi_5_appliance/why_pi_5_appliance/#virtualization","title":"Virtualization","text":"<p>If your company uses virtualization that is a good choice for the appliance. Any of these platforms will support Ubuntu 24.04.</p> <ul> <li>Microsoft HyperV</li> <li>VMware ESXi</li> <li>ProxMox</li> <li>Linux KVM</li> </ul> <p>You can ask the IT department to spin up an Ubuntu VM for you. Ubuntu is free to download, I usually do a $25 donation, to help offset the projects costs. A VM on company infrastructure is a great way to run the appliance software. IT can back it up daily and create snapshots before you make big changes.</p> <p>Appendix A - Securing the Appliance and Appendix B - Linux file permissions go into detail on how the appliance operating system is secured. That should help with getting the request approved by IT and the security team.</p>"},{"location":"build_pi_5_appliance/why_pi_5_appliance/#sff-intel-pc","title":"SFF Intel PC","text":"<p>A Small Form Factor (SFF) Intel PC is also a good choice for a dedicated appliance. The Raspberry Pi 5 might be less expensive and the SFF may not run on PoE power! But, the appliance can be built on a repurposed PC or old server, or brand new SFF PC. All of the scripts and applications will run on ARM or Intel architecture chips.</p> <p>An easy way to get started if you just want to do a Proof of Concept would be to use a repurposed laptop to try out the appliance and then rebuild it on a Pi or SFF PC. Almost any laptop made in the last 8 years will run Ubuntu 24.04 and the Ethernet, and probably WiFi, will just work.</p>"},{"location":"build_pi_5_appliance/why_pi_5_appliance/#ubuntu-pro-coverage","title":"Ubuntu Pro coverage","text":"<p>If you are building the appliance for personal use, Ubuntu has a service that is free for up to five devices called <code>Ubuntu Pro</code>. Think of it as Microsoft support but for Ubuntu. The details are on the Ubuntu Pro Pricing page. For business use, the desktop version is $25/yr and the server version is $300/yr.</p> <p>Ubuntu Pro includes:</p> <ul> <li>Security updates</li> <li>Kernel Livepatch</li> <li>Advanced Active Directory policies for Ubuntu Desktop</li> <li>And much more</li> </ul> <p>If you have never seen Raspberry Pi 5s in the industrial and manufacturing spaces, here are couple of example companies:</p> <ul> <li>Revolution Pi - Revolution Pi is your open-source Linux platform for future-oriented industrial solutions:<ol> <li>Powered by the Raspberry Pi Compute Module</li> <li>Raspberry Pi OS-based, industry-optimized operating system</li> </ol> </li> <li>Strato Pi - Industrial Raspberry Pi for Maximum Reliability<ol> <li>Edge Computing</li> <li>Industrial Automation</li> <li>Building &amp; Energy Management</li> <li>Data Acquisition</li> <li>Marine</li> <li>Fleet Management</li> </ol> </li> </ul> <p>It's worth a few minutes to look at the homepages of those two companies.</p>"},{"location":"build_pi_5_appliance/why_pi_5_appliance/#the-raspberry-pi-community","title":"The Raspberry Pi community","text":"<p>There is also a vibrant ecosystem of add-on \"Hardware Attached on Top\" boards, usually called <code>Hats</code>.</p> <p>Sites like:</p> <ul> <li>Adafruit</li> <li>Waveshare</li> <li>Ameridroid</li> </ul> <p>Sell a large array of add ons, cases, etc. for the Raspberry Pi 5.</p> <p>Some examples:</p> <ul> <li>Waveshare PoE Hat makes a $30 PoE hat that will power the RPI 5 from the Ethernet cable. Very convenient on the manufacturing floor.</li> <li>Waveshare 4 port 2.5Gbps Ethernet - Support APs with 2.5 Gbps Ethernet.</li> <li>Raspberry Pi AI Hat - No article is complete until AI is used! The AI HAT+ is available in 13 and 26 tera-operations per second (TOPS) variants, built around the Hailo-8L and Hailo-8 neural network inference accelerators.</li> <li>Hi Resolution Camera - The Raspberry Pi Camera V2 is IR sensitive for low-light situations and features an upgraded 8MP Sony image sensor capable of taking 3280 x 2464 pixel images and capturing video at 1080p30, 720p60 and 640x480p90 resolutions. Like all Raspberry Pi camera modules, it works flawlessly with Raspberry Pi models using the latest Raspbian operating system.</li> </ul>"},{"location":"build_pi_5_appliance/why_pi_5_appliance/#e-paper-displays","title":"e-paper displays","text":"<p>Waveshare makes great e-paper displays for the Pi. I built a serial console server using a Pi Zero W and a Waveshare display. On startup:</p> <ul> <li>Shows me the IP addresses it got</li> <li>Displays the MFG-S/N of the USB serial adapters that are connected.</li> <li>If it gets internet access, it emails the address to my <code>Gmail</code> account.</li> </ul> <p>The email is handy if the console is in a rack up high and you can't see the display. Waveshare provides a Python library to talk to the display, and there are tons of YouTube videos and blogs on coding it..</p> <p>Here is a photo of my Pi Zero 2 W serial console. It has a PoE hat; I can plug it into a PoE switch, and it's ready to go. In the photo, one FTDI serial cable is connected. The P 2003 means that I telnet to port 2003 to connect to the device it's connected to.</p> <p></p> <p>In the future I might add one to the Haas Data Collection appliance and display what machines are online. Here is the link to the Waveshare site: 3.97inch E-Paper Display</p>"},{"location":"build_pi_5_appliance/why_pi_5_appliance/#the-rpi-5-is-available-4-models","title":"The RPi 5 is available 4 models","text":"<p>The difference is the amount of RAM. To build a dedicated RPi 5 for this project, I recommend the 8GB RAM model. That is overkill for just the scripts, but the difference in cost is negligible compared to the 4GB model, and I find that it's always better to have more RAM for future-proofing.</p> <p>On 12/29/2025, Amazon's site offered this cost:</p> <ul> <li>Raspberry Pi 5 8GB: $93.99</li> <li>Raspberry Pi 5 4GB: $76.95</li> </ul> <p>Warning</p> <p>The AI craze is dramatically increasing the cost of RAM, GPUs and NVME drives. It's not expected to change for a couple years. Don't get stuck in <code>Analysis Paralysis</code> if you plan to build one.</p> <p>To build a high-performance appliance for a manufacturing plant, I used:</p> <ul> <li>Raspberry Pi 5 8GB - $104.48</li> <li>Waveshare case - $33.99</li> <li>Waveshare PoE Hat - $28.49</li> <li>RTC battery case - $5.49</li> <li>Samsung 256GB NVME - $78.00</li> </ul> <p>The Waveshare case is industrial quality with ears to mount it to a back board. It has the following capabilities:</p> <ul> <li>\u2705 Supports PCIe Extending To M.2 Interface</li> <li>\u2705 Larger internal space, supports connecting to various HATs such as PoE HAT, Etc. Also, with space left for cable management</li> <li>\u2705 Adapting Type-C, dual full-size HDMI female ports, and a screw terminal for easier connection with peripherals, supports two power supply connection methods from the front side or the back side</li> <li>\u2705 Tabs on both sides for mounting to a backboard.</li> <li>\u2764\ufe0f Official Wiki Resources</li> </ul> <p>The installation instructions are on the Amazon link but they are hard to find. You can click the link here to view them.</p> <p>Note</p> <p>The case came with the wrong number of m2.5 x 6 flat head screws. I have never bought a Waveshare product that came with the wrong hardware. I had some from other projects but you should order some mankk 360PCS Laptop Screws with the case.</p> <p>Also, the PoE hat came with 6mm x 16mm female/female standoffs. The case needs mal/female. I ordered these YOKIVE 20 Pcs M2.5 Standoff Screws.</p>"},{"location":"build_pi_5_appliance/why_pi_5_appliance/#usb-serial-cable-for-the-raspberry-pi-5","title":"USB Serial cable for the Raspberry Pi 5","text":"<p>I recommend purchasing the Waveshare Industrial USB to TTL (D) Serial Cable, compatible with the Raspberry Pi 5 Serial to USB cable, for $13.99. The cable allows you to connect to the Raspberry Pi 5 if you lock yourself out over SSH. And that can happen when configuring the firewall. </p> <p>This cable is nice because in addition to the individual 4 connects it includes the <code>3 pin UART</code> connector that the Raspberry Pi 5 has. I have used that cable to console into Aruba 315 APs that have 4 pins instead of the typical RJ45 console connector. The Waveshare case exposes the 3 pin connector on the back of the case.</p> <p></p>"}]}